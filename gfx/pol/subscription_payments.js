class SubscrPayments extends Subscr{constructor(t={}){super(t),this.defaultCard={icon:"/gfx/standards/payment_group_card.svg",alt:"Default card icon",number:"**** ****"},this.IdoPay={systemLogo:"/data/lang/pol/payforms/gfx/Idopay_logo_black.svg",visaLogo:"/data/lang/pol/payforms/gfx/44.svg",masterCardLogo:"/data/lang/pol/payforms/gfx/45.svg"},this.icons={simple_transfer:"/gfx/standards/payment_group_simple_transfer.svg",card:"/gfx/standards/payment_group_card.svg",transfer:"/gfx/standards/payment_group_transfer.svg",installment:"/gfx/standards/payment_group_installment.svg",others:"/gfx/standards/payment_group_others.svg",tradeCredit:"/gfx/standards/payment_group_trade_credit.svg",dvp:"/gfx/standards/payment_group_dvp.svg"},this.names={simple_transfer:this.txt["Przelew zwykły"],card:this.txt["Karta płatnicza"],transfer:this.txt["Przelew online"],installment:this.txt["Płatność ratalna"],others:this.txt["Bony, karty podarunkowe"],tradeCredit:this.txt["Faktura na termin"],dvp:this.txt.Pobranie},this.descriptions={simple_transfer:this.txt["Zaksięgowanie do 3 dni roboczych"],card:this.txt["Zaksięgowane w kilka minut"],transfer:this.txt["Zaksięgowane w kilka minut"],installment:"",others:this.txt["Zaksięgowane w kilka minut"],tradeCredit:this.txt["Płatność przelewem po dostawie"],blik:this.txt["Zaksięgowane w kilka minut"],paypal:""},this.paymentStepsMapper=["card","others","installment","transfer"],this.paymentSystemIds={29:"idopay"}}async fetchPaymentsMethod(){const{data:t={}}=await super.fetchData({data:this.queries.PAYMENTS(),linkParameter:"?query=subscriptionPaymentsMethod",cacheName:"subscriptionPaymentsMethod"})||{},{paymentsMethod:e}=t;return e||!1}async fetchPreparePayment(t){const{data:{prepareSubscriptionPayment:e}={}}=await super.fetchData({data:this.queries.PREPARE_PAYMENT(this.vars.view.id,t),linkParameter:"?query=subscriptionPreparePayment"})||{};return e||!1}findGroupTerms({groupId:t,paymentNames:e,paymentsGroupTerms:s}){return s.filter((e=>e.groupId===t)).filter((t=>!e||e===[]||e.includes(t.type)))}isGiftPaymentMethod(t){const e=t?.toString();return"2"===e||"190"===e}hasGiftPaymentMethods(t){return t?.some((t=>this.isGiftPaymentMethod(t.id?.toString())))}findAssociatedPaymentSystemName(t){const e=t?.toString();return this.paymentSystemIds?.[e]}getPaymentById(t){const{payments:e=[]}=this.vars.paymentsData;return e.find((({id:e})=>e?.toString()===t?.toString()))}disableInputs(){const t=this.paymentsModalElement?.querySelectorAll('input:not([name="selected_group_only"]');t?.forEach((t=>{const e=t.closest(`.${this.prefix}_payments_modal__item`);if(!e.querySelector('input[name="selected_group_only"]').checked){t.disabled=!0,t.checked=!1;const s=e.querySelector(`.${this.prefix}_payments_modal__details.--show-all`);if(!s)return;s.classList.remove("--show-all");const a=s.querySelector(`.${this.prefix}_payments_modal__show_all`);if(!a)return;a.textContent=this.txt["Pokaż wszystkie"]}else t.disabled=!1}))}createClauseFragment(t,e){const s=document.createElement("div");return s.classList.add(`${this.prefix}_payments_modal__clause`),s.innerHTML=t,e&&(s.dataset.type=e),s.querySelectorAll("a").forEach((t=>t.setAttribute("target","_blank"))),s}prepareClauses(t){return[...t].filter((t=>t)).map((t=>this.createClauseFragment(t)?.outerHTML)).join("")}updateClause(t){const e=this.paymentsModalElement.querySelector(`.${this.prefix}_payments_modal__clauses`);if(e.innerHTML="",e.classList.remove("--active"),!t?.length)return;t.forEach((t=>{const{clause:s,type:a}=t;if(!s)return;const n=this.createClauseFragment(s,a);e.appendChild(n)}));e.querySelector(`.${this.prefix}_payments_modal__clause`)&&e.classList.add("--active")}getPaymentClause(t){const e=t.paymentChannel?.id,s=t.paymentSystem?.id,a=[];let n=[this.findAssociatedPaymentSystemName(s)];t.terms?.supportsPaymentInitiationService&&a.push({clause:t.terms.paymentInitiationServiceTerms.clause}),n=n.filter((t=>t));const{paymentsGroupTerms:i=[]}=this.vars.paymentsData,r=this.findGroupTerms({groupId:e,paymentNames:n,paymentsGroupTerms:i});return a.push(...r),a}clause(){if(this.updateClause([]),"payment"!==this.vars.selectedPaymentType)return;const t=this.getPaymentById(this.vars.selectedPayment);if(!t)return;const e=this.getPaymentClause(t);this.updateClause(e)}getUniquePayments(){const{payments:t=[]}=this.vars.paymentsData;return t.filter(((t,e,s)=>e===s.findIndex((e=>e.paymentChannel.id===t.paymentChannel.id&&!0!==e.methodAsGroup))||!0===t.methodAsGroup))}getPaymentId(t){return t.methodAsGroup||!t.paymentChannel.id||177===t.id?t.id:t.paymentChannel.id}getPaymentName(t){if(t.methodAsGroup)return t.name;if(153===t.id)return this.names.tradeCredit;const e=t.paymentChannel.id;return this.names[e]?this.names[e]:t.name}getPaymentIcons(t){if(t.methodAsGroup)return[{src:t.icon,alt:t.name}];if(153===t.id)return[{src:this.icons.tradeCredit,alt:this.names.tradeCredit}];const e=t.paymentChannel.id;return this.icons[e]?[{src:this.icons[e],alt:this.names[e]}]:[{src:t.icon,alt:t.name}]}getPaymentDescription(t){return 153===t.id?this.descriptions.tradeCredit:t.paymentChannel?.id in this.descriptions&&this.descriptions[t.paymentChannel.id]}getPaymentCost(t){const{costPercent:e}=t.additionalClientCost,{value:s}=t.additionalClientCost.costFixedAmount,{value:a}=t.additionalClientCost.minAmount;return(0!==e||0!==s||0!==a)&&t.id}getPaymentDefaultClause(t){if(!t.terms?.supportsPaymentInitiationService)return[];const{paymentsGroupTerms:e=[]}=this.vars.paymentsData;return this.findGroupTerms({groupId:t.paymentChannel?.id,paymentNames:["pis"],paymentsGroupTerms:e}).map((t=>{const e=t?.clausePrefix,s=t?.clause;let a="";return e&&(a+=`${e}: `),s&&(a+=s),a}))}getPaymentOptions(t){const{payments:e=[]}=this.vars.paymentsData;return e.filter((e=>e.paymentChannel.id===t.paymentChannel.id&&!1===e.methodAsGroup))}getFormattedPayments(){return this.getUniquePayments().map((t=>{const e=this.getPaymentId(t),s=this.getPaymentOptions(t);return this.isGiftPaymentMethod(e?.toString())||this.hasGiftPaymentMethods(s)?null:{id:e,group:!t.methodAsGroup&&s.length>1,icons:this.getPaymentIcons(t),name:this.getPaymentName(t),description:this.getPaymentDescription(t),cost:this.getPaymentCost(t),clause:this.getPaymentDefaultClause(t),options:s}})).filter(Boolean)}toggleShowAll(t,e){const s=t.querySelector(`.${this.prefix}_payments_modal__show_all`);s&&(e?s.classList.remove("--hidden"):s.classList.add("--hidden"))}createPaymentOption(t,e,s){const a=document.getElementById(`${this.prefix}_payments_modal_option_template`).content.cloneNode(!0),n=a.querySelector("input"),i=`payment_${t.id}_${s}`,r="payform_id";n.id=i,n.value=e.id,n.setAttribute("name",r),n.setAttribute("data-group-id",t.id),n.setAttribute("name",r);a.querySelector("label").setAttribute("for",i);a.querySelector(`.${this.prefix}_payments_modal__option_name`).textContent=e.name;const o=a.querySelector(`.${this.prefix}_payments_modal__option_icon`);return o.alt=e.name,o.src=e.icon,a}createPaymentsOptionList(t){return t.options.map(((e,s)=>this.createPaymentOption(t,e,s)))}addPaymentOptions(t,e){const s=e.querySelector(`.${this.prefix}_payments_modal__details`);if(!s)return;if(!t.group||!this.paymentStepsMapper.includes(t.id)||!t.options.length)return void s.parentNode.removeChild(s);const a=document.getElementById(`${this.prefix}_payments_modal_details_template`)?.content.cloneNode(!0);if(!a)return void s.parentNode.removeChild(s);e.firstChild.classList.add("--options");const n=a.querySelector(`.${this.prefix}_payments_modal__clause_options`);if(t.clause.length&&n){const e=this.prepareClauses(t.clause);n.innerHTML=e}const i=a.querySelector(`.${this.prefix}_payments_modal__options`),r=this.createPaymentsOptionList(t);r&&r.length>0&&i&&r.forEach((t=>{i.appendChild(t)})),s.appendChild(a),this.toggleShowAll(s,r.length>6)}prepareElementToDisplay(t){const e=document.getElementById(`${this.prefix}_payments_modal_item_template`)?.content.cloneNode(!0);if(!e)return!1;const s=e.querySelector(`.${this.prefix}_payments_modal__icons`),a=e.querySelector(`.${this.prefix}_payments_modal__icon`);t.icons.forEach((t=>{const e=a.cloneNode();e.alt=t.alt,e.src=t.src,s.appendChild(e)})),a.parentNode.removeChild(a);e.querySelector(`.${this.prefix}_payments_modal__name`).textContent=t.name;const n=e.querySelector(`.${this.prefix}_payments_modal__description`);t.description?n.textContent=t.description:n.parentNode.removeChild(n);const i=e.querySelector('input[name="first_payment_id"]');t.cost&&t.group?i.value=t.cost:i.parentNode.removeChild(i);const r=t.options?.[0]?.id,o=e.querySelector('input[name="payform_id"]');t.group&&177!==t.id?o.parentNode.removeChild(o):(o.value=t.id,1===t.options.length&&r&&(o.value=r));const m=e.querySelector('input[name="selected_group_only"]');m.id=`payform_${t.id}`,m.value=t.id,1===t.options.length&&r&&(m.value=r),m.setAttribute("data-group",t.group),"transfer"===t.id&&this.vars.transferChecked&&(m.checked=!0),t.checked&&"cash"===t.id&&this.paymentsModalElement?.classList?.add("--dvp");e.querySelector("label").setAttribute("for",`payform_${t.id}`);const l=this.paymentsModalElement.querySelector(`.${this.prefix}_payments_modal__clause_top`);if(l&&!t.group&&t.clause.length){const e=this.prepareClauses(t.clause);l.innerHTML=e,this.paymentsModalElement.classList.add("--clause-top")}return this.addPaymentOptions(t,e),e}getPaymentsModalElement(){const t=document.getElementById(`${this.prefix}_payments_modal_template`)?.content.cloneNode(!0);if(!t||!t.firstChild)return!1;this.paymentsModalElement=t.firstChild;const e=this.paymentsModalElement.querySelector(`.${this.prefix}_payments_modal__wrapper`);if(!e)return this.paymentsModalElement;return(this.getFormattedPayments()||[]).forEach((t=>{const s=this.prepareElementToDisplay(t);s&&e.appendChild(s)})),this.paymentsModalElement}paymentSelected(t){const{paymentElement:e=null,selectedPayment:s=null,selectedPaymentForCost:a=null,selectedPaymentType:n=null}=t||{};this.paymentsModalElement.classList.add("--selected");this.paymentsModalElement.querySelectorAll(`.${this.prefix}_payments_modal__item`).forEach((t=>{t.querySelector(`.${this.prefix}_payments_modal__input:checked`)||t.querySelector(`.${this.prefix}_payments_modal__option_input:checked`)?t.classList.add("--checked"):t.classList.remove("--checked")}));const i=e.querySelector(`.${this.prefix}_payments_modal__input`)||e.querySelector(`.${this.prefix}_payments_modal__option_input`);if(!i)return;const r=i.value,o=i.getAttribute("data-group-id");this.paymentsModalElement.setAttribute("data-id",r),this.paymentsModalElement.setAttribute("data-group-id",o),this.vars.selectedPayment=s,this.vars.selectedPaymentForCost=a,this.vars.selectedPaymentType=n,this.clause(),this.paymentsModalElement.querySelector(`.${this.prefix}_payments_modal__button.--edit`)?.focus()}validateSelectedPayment(t){return!!t||(Alertek.Info(this.txt["Wybierz formę płatności"]),!1)}checkRemovePaymentsElement(){if(this.vars.view.status===this.statuses.finished)return!0;const{cardNumber:t}=this.vars.view?.subscriptionPaymentData||{},{canCustomerEditSubscriptionPayments:e,isCardChangeInProgress:s}=this.vars.view?.subscriptionOptions||{},[a]=this.vars.orders,n=super.checkLastOrderIsShipped(a);return!(t||e||!n||s)}removeEditElement(){const t=this.paymentsElement.querySelector(`.${this.prefix}_payments__edit`);t&&t.remove()}initUpcomingPaymentDate(){const t=document.getElementById(`${this.prefix}_payments_upcoming`)?.content.cloneNode(!0);if(!t||!t.firstChild)return;const e=t.firstChild,s=e.querySelector(`.${this.prefix}_payments__upcoming_value`);if(!s)return;const{upcomingPaymentDate:a}=this.vars.view;s.textContent=super.getFormattedDate(a,{alwaysWithDate:!0,brackets:!0}),this.paymentsElement.append(e)}initSelectedPayment(){const t=document.getElementById(`${this.prefix}_payments_card`)?.content.cloneNode(!0);if(!t||!t.firstChild)return;const e=t.firstChild,{iconSvg:s,systemName:a,cardNumber:n}=this.vars.view?.subscriptionPaymentData||{},i=e.querySelector(`.${this.prefix}_payments__card_icon img`);i&&(i.src=s||this.defaultCard.icon,i.alt=a||this.defaultCard.alt);const r=e.querySelector(`.${this.prefix}_payments__card_number`);r&&(r.textContent=n||this.defaultCard.number),this.paymentsElement.append(e)}initIsCardChangeInProgress(t){const e=document.getElementById(`${this.prefix}_payments_card_change_in_progress`)?.content.cloneNode(!0);if(!e||!e.firstChild)return;const s=e.firstChild;this.paymentsElement.append(s),t&&this.initSelectedPayment(),this.initUpcomingPaymentDate()}initSomethingWentWrong(t){const e=document.getElementById(`${this.prefix}_payments_something_went_wrong`)?.content.cloneNode(!0);if(!e||!e.firstChild)return;const s=e.firstChild,a=s.querySelector(`.${this.prefix}_payments__pay_your_order`);a&&(a.href=t.link,this.paymentsElement.append(s))}initNoCard(){const t=document.getElementById(`${this.prefix}_payments_no_card`)?.content.cloneNode(!0);if(!t||!t.firstChild)return;const e=t.firstChild;this.vars.view.status!==this.statuses.hold&&e.querySelector(`.${this.prefix}_no_card__info`)?.remove();const s=e.querySelector(`.${this.prefix}_no_card__card_icon img`);s&&(s.src=this.defaultCard.icon),this.paymentsElement.append(e),this.initUpcomingPaymentDate()}initPayments(){const{cardNumber:t}=this.vars.view?.subscriptionPaymentData||{},{canCustomerEditSubscriptionPayments:e,isCardChangeInProgress:s}=this.vars.view?.subscriptionOptions||{};if(s)return this.initIsCardChangeInProgress(t),void this.removeEditElement();const[a]=this.vars.orders,n=super.checkLastOrderIsShipped(a);if(!t&&!e&&!n)return this.initSomethingWentWrong(a),void this.removeEditElement();t?(this.initSelectedPayment(),this.initUpcomingPaymentDate()):this.initNoCard()}onChangeSelectPayment(t){this.disableInputs();const e="selected_group_only"===t.name?t.closest(`.${this.prefix}_payments_modal__item`):t.closest(`.${this.prefix}_payments_modal__option`);if(!e)return;if(e.classList.contains("--options")){const s=t?.getAttribute("data-group-id");return t.value=s||"transfer",void this.paymentSelected({paymentElement:e})}const s=t.value,a=e.querySelector('input[name="payform_id"]'),n=e.querySelector('input[name="first_payment_id"]');let i=!1;a?i=a.value:n&&(i=n.value);const r=a?"payment":"group";this.paymentSelected({paymentElement:e,selectedPayment:s,selectedPaymentForCost:i,selectedPaymentType:r})}onClickToggleTab(t){const e=t.closest(`.${this.prefix}_payments_modal__item`);if(!e)return;const s=e.classList.contains("--collapse"),a=e.parentElement?.querySelectorAll(`.${this.prefix}_payments_modal__item.--options`);a.forEach((t=>t.classList.remove("--collapse"))),e.classList.contains("--options")&&e.classList.contains("--checked")&&(s?e.classList.remove("--collapse"):e.classList.add("--collapse"))}onClickShowAllOptions(t){const e=t.closest(`.${this.prefix}_payments_modal__details`);e&&(e.classList.toggle("--show-all"),e.classList.contains("--show-all")?t.textContent=this.txt["Pokaż mniej"]:t.textContent=this.txt["Pokaż wszystkie"])}afterPayment({status:t,cardDisconnected:e,alert:s=!0,statusOfChangeSubscriptionCard:a}={}){if("failed"!==a){if(a)return Alertek.Success(this.txt["Pomyślnie dokonano zmiany karty płatniczej"]),this.paymentsElement?.classList.add("--loading"),void this.callbacks.afterSuccessPayment?.();if(e&&super.clearCache(),"error"===t)return s&&Alertek.Error(this.txt["Wystąpił problem z płatnością"]),void this.onClickShowPaymentsModal();this.callbacks.afterSuccessPayment?.()}else Alertek.Error(this.txt["Nie udało się zmienić karty płatniczej"])}async onClickPaymentAction(){const t=this.vars?.selectedPayment?.toString();if(!this.validateSelectedPayment(t))return;this.paymentsModalElement.closest(".modal").classList.add("--loading");const e=await this.fetchPreparePayment(t);if(!e)return Alertek.Info(this.txt["Nie możesz zapłacić tą formą płatności, spróbuj wybrać inną"]),void this.paymentsModalElement.closest(".modal").classList.remove("--loading");super.clearCache();new PreparePayment({paymentData:window.paymentTest||e,paymentMethodData:this.getPaymentById(t),paymentId:t,leftToPay:this.vars.basketCost?.totalToPay?.formatted,afterPaymentCallback:this.afterPayment.bind(this),oldModal:this.vars.modal}).init()}async onClickShowPaymentsModal(){this.paymentsElement.classList.add("--loading");const t=this.vars.paymentsData||await this.fetchPaymentsMethod();this.paymentsElement.classList.remove("--loading");const{payments:e=[]}=t||{};if(!t||!e?.length)return Alertek.Info(this.txt["Brak metod płatności"]),void super.clearCache(["subscriptionPaymentsMethod"]);this.vars.paymentsData=t;const s=this.getPaymentsModalElement();s&&(this.vars.modal=new Modal({element:s,classList:"--subscr --payments --mobile"}),this.initPaymentsModalEvents())}initPaymentsModalEvents(){this.paymentsModalElement.addEventListener("click",(t=>{const{target:e}=t;if(e.closest(`.${this.prefix}_payments_modal__button.--return`))this.vars.modal.closeModal();else{if(e.closest(`.${this.prefix}_payments_modal__select_payment`)){t.preventDefault();const s=e.closest(`.${this.prefix}_payments_modal__item`).querySelector(`.${this.prefix}_payments_modal__input`);if(!s)return;return s.checked=!0,void this.onChangeSelectPayment(s)}if(!e.closest(`.${this.prefix}_payments_modal__button.--edit`))return e.closest(`.${this.prefix}_payments_modal__show_all`)?(t.preventDefault(),void this.onClickShowAllOptions(e)):void(e.closest(`.${this.prefix}_payments_modal__label`)&&this.onClickToggleTab(e));this.onClickPaymentAction()}})),this.paymentsModalElement.addEventListener("change",(t=>{const{target:e}=t;(e.closest(`.${this.prefix}_payments_modal__input`)||e.closest(`.${this.prefix}_payments_modal__option_input`))&&(t.preventDefault(),this.onChangeSelectPayment(e))}))}initEvents(){this.paymentsElement.addEventListener("click",(t=>{const{target:e}=t;(e.closest(`.${this.prefix}_payments__edit`)||e.closest(`.${this.prefix}_no_card__card`)||e.closest(`.${this.prefix}_no_card__add_card_link`))&&(t.preventDefault(),this.onClickShowPaymentsModal())}))}async generate(){const t=document.getElementById(`${this.prefix}_payments_template`)?.content.cloneNode(!0);if(!t||!t.firstChild)return;const e=this.paymentsElement;if(this.checkRemovePaymentsElement())return e?.remove(),void document.querySelector(this.vars.move.moveSelector)?.remove();this.paymentsElement=t.firstChild,this.initPayments(),this.initEvents(),e&&document.body.contains(e)?e.replaceWith(this.paymentsElement):super.move({element:this.paymentsElement,...this.vars.move})}async init(t={}){this.vars={afterReady:t.afterReady||(()=>{}),move:t.move||this.vars?.move||{},view:t.view||this.vars?.view||{},basketCost:t.basketCost||this.vars?.basketCost||null,paymentsData:this.vars?.paymentsData||!1,orders:t.orders||this.vars?.orders||[]},this.callbacks={afterSuccessPayment:t.afterSuccessPaymentCallback||this.callbacks?.afterSuccessPayment},await this.generate(),this.vars.afterReady(this.paymentsElement)}}app_shop.fn.subscrPayments=new SubscrPayments;const CountDownTimer=function(t={}){this.data=t;const{element:e=null,counterName:s="base",callback:a=()=>{},fyllDashArray:n=283,timeLimit:i=400}=t;let{timePassed:r=0,timeLeft:o=i,timerInterval:m=null}=t;const l=t=>t%60+"s",c=()=>{clearInterval(m),r=0,o=i,m=null,a&&a()},d=()=>{const t=`${((()=>{const t=o/i;return t-1/i*(1-t)})()*n).toFixed(0,1)} 283`;document.getElementById(`${s}-timer-path-remaining`).setAttribute("stroke-dasharray",t)};this.html=`\n  <div id="${s}-timer" class="timer">\n    <svg class="timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">\n      <g class="timer__circle">\n        <circle class="timer__path-elapsed" cx="50" cy="50" r="45"></circle>\n        <path\n          id="${s}-timer-path-remaining"\n          stroke-dasharray="283"\n          class="timer__path-remaining"\n          d="\n            M 50, 50\n            m -45, 0\n            a 45,45 0 1,0 90,0\n            a 45,45 0 1,0 -90,0\n          "\n        ></path>\n      </g>\n    </svg>\n    <span id="${s}-timer-label" class="timer__label">${l(o)}</span>\n  </div>\n  `,this.init=()=>!!e&&(e.innerHTML=this.html,m=setInterval((()=>{r+=1,o=i-r,document.getElementById(`${s}-timer-label`).innerHTML=l(o),d(),0===o&&c()}),1e3),!0)};var paymentForceTxt1="Przekierowanie do płatności",paymentForceTxt2="Jeśli przekierowanie nie nastąpiło automatycznie, kliknij:";const PaymentForce=function(t={},e={}){this.data=t,this.txt=e;const{element:s="",name:a="",shopLogo:n="",paymentLogo:i="",systemLogo:r="",form:o="",beforeSendCall:m=null,afterSendCall:l=null}=t,{przekierowanieDoPlatnosci:c=window?.paymentForceTxt1||"Przekierowanie do płatności",jesliPrzekierowanieNieNastapi:d=window?.paymentForceTxt2||"Jeśli przekierowanie nie nastąpiło automatycznie, kliknij:"}=e;this.endTimer=()=>{m&&m(),document.querySelector("#paymentForce form")?.submit(),l&&l()},this.html=`<div class="paymentForce__wrapper">\n    <div id="paymentForce" class="paymentForce">\n    <span class="paymentForce__shop_logo ${n?"":"d-none"}">\n        <img src="${n}" alt="logo"/>\n      </span>\n      <span class="paymentForce__header">\n        <span>${c}</span>\n        <img class="systemLogo ${r?"":"d-none"}" src="${r}" alt="${a}"/>\n        <img class="paymentLogo" src="${i}" alt="${a}"/>\n      </span>\n      <span class="paymentForce__timer"></span>\n      <span class="paymentForce__txt">${d}</span>\n      ${o}\n    </div>\n  </div>`,this.start=()=>{s.insertAdjacentHTML("afterbegin",this.html),this.timer=new CountDownTimer({name:"paymentForce",element:document.querySelector(".paymentForce__timer"),callback:window?.offRedirect||this.endTimer}),this.timer.init()}};class PreparePayment{constructor(t={}){this.txt={...SUBSCR_TXT},this.prefix=t?.prefix||"subscr",this.paymentData=t?.paymentData,this.paymentMethodData=t?.paymentMethodData,this.paymentId=t?.paymentId||0,this.leftToPay=t?.leftToPay||0,this.callbacks={afterPayment:t.afterPaymentCallback},this.options=t,this.systemIcons={29:"/data/lang/pol/payforms/gfx/Idopay_logo_black.svg"},this.oldModal=t.oldModal}getScriptsFromHtml(t){const e=document.createElement("div");e.innerHTML=t;const s=[...e.getElementsByTagName("script")];if(!s.length)return[];const a=[];return s.forEach((t=>{const e=document.createElement("script");e.text=t.innerHTML,a.push(e)})),a}getElementsFromHtml(t){const e=document.createElement("div");e.innerHTML=t;return[...[...e.childNodes].filter((t=>"SCRIPT"!==t.tagName)),...this.getScriptsFromHtml(t)]}replaceHtml(t,e){if(!e)return;e.innerHTML="";const s=this.getElementsFromHtml(t);e.append(...s)}setSystemIcons(){const t=this.goPaymentModalElement.querySelector(`.${this.prefix}_go_payment_modal__icons`);if(!t)return;const{icon:e,name:s,paymentSystem:{id:a,name:n}={}}=this.paymentMethodData||{},i=this.systemIcons[a];if(i){const e=document.createElement("img");e.src=i,e.alt=n,e.classList.add(`${this.prefix}_go_payment_modal__icon`,"--system"),t.append(e)}const r=document.createElement("img");r.src=e,r.alt=s,r.classList.add(`${this.prefix}_go_payment_modal__icon`),t.append(r)}setGoPayment(t){const e=this.goPaymentModalElement.querySelector(`.${this.prefix}_go_payment_modal__payment`);e&&this.replaceHtml(t,e)}getGoPaymentModal(t){const e=document.getElementById(`${this.prefix}_go_payment_modal_template`)?.content.cloneNode(!0);return!(!e||!e.firstChild)&&(this.goPaymentModalElement=e.firstChild,this.setSystemIcons(),this.setGoPayment(t),this.goPaymentModalElement)}checkPaymentForce(){return!!("object"==typeof this.paymentData?.formData?.inputs&&Object.values(this.paymentData?.formData?.inputs).length&&Object.values(this.paymentData?.formData?.inputs)?.reduce(((t,e)=>"checkbox"===e?.type))||this.paymentData?.description&&(-1!==this.paymentData?.description?.indexOf("<iframe")||-1!==this.paymentData?.description?.indexOf("paypal_button_container")||-1!==this.paymentData?.description?.indexOf("apple-pay-button")))}showPaymentModal(t){if(this.checkPaymentForce()){return this.getGoPaymentModal(t)?(PreparePayment.isListenerAttached||(window.addEventListener("message",this.onMessageIframe.bind(this)),PreparePayment.isListenerAttached=!0),this.oldModal?.closeModal?.(),this.modal=new Modal({element:this.goPaymentModalElement,classList:"--subscr --go-payment --medium --mobile --loading"}),void setTimeout((()=>{this.goPaymentModalElement.closest(".modal")?.classList.contains("--loading")&&(this.modal?.closeModal?.(),this.callbacks.afterPayment?.({status:"error"}))}),1e4)):void this.callbacks.afterPayment?.({status:"error"})}app_shop.vars.paymentForce=new PaymentForce({element:document.querySelector("#container"),name:this.paymentMethodData?.name,shopLogo:window?.prepaid_data?.shopLogoSettings?.url||app_shop.vars.logoUrl||document.querySelector("#logo img")?.src||"/data/gfx/mask/pol/logo_1_big.jpg",paymentLogo:this.paymentMethodData?.icon,systemLogo:this.paymentMethodData?.payment_system_logo,form:t}),super.clearCache(),app_shop.vars.paymentForce.start()}setPaymentForm(){const{type:t}=this.paymentData||{};if("form"!==t)this.callbacks.afterPayment?.({status:"error"});else{const t=new PreparePaymentForm(this.options).getHTML();this.showPaymentModal(t)}}onMessageIframe(t){const{data:e}=t;if(!e)return;const s=JSON.parse(e),{type:a,step:n}=s||{};"eventTrackerInfo"===a&&"display_payform"===n&&document.querySelector(".modal")?.classList.remove("--loading");const{status:i,"3dsUrl":r,statusOfChangeSubscriptionCard:o}=s,m=document.querySelector(`.${this.prefix}_go_payment_modal`),l="eventTrackerInfo"===a&&"successfully_removed_card_from_subscription"===n&&m;if((r||""===r)&&m)return this.callbacks.afterPayment?.({status:i,statusOfChangeSubscriptionCard:o,cardDisconnected:l,alert:!1}),document.getElementById("modal")&&(document.getElementById("modal").style.display="none"),void setTimeout((()=>{this.modal?.closeModal?.()}),5e3);l&&this.callbacks.afterPayment?.({cardDisconnected:l})}init(){window.orderdetails_payments={paymentID:-1,payment_target:"",test:!1,timeoutAjax:2e4,other_payments:"",retry_payment:"",fn_submit_credit_card:()=>!0,fn_submit_form:()=>!0,fn_submit_installment_plan:()=>!0,dialog:()=>!0,ajaxLoadSite(){}},this.paymentData?.type?this.setPaymentForm():this.callbacks.afterPayment?.({status:"error"})}}PreparePayment.isListenerAttached=!1,app_shop.fn.validateTerms=()=>{const t=document.querySelectorAll(".summary__term");let e=!0;return t.forEach((t=>{t.querySelector("input").checked?t.classList.remove("--required"):(t.classList.add("--required"),e=!1)})),e},app_shop.fn.isPayLaterSelected=t=>"210"===t;class PreparePaymentForm extends PreparePayment{constructor(t={}){super(t)}radio(t){return`<div class="orderpaymentradio">\n      <label>\n        <input type="${t.type}" value="${t.value}" name="${t.name}" ${t.checked?"checked":""}/>\n      </label>\n    </div>`}checkbox(t){return app_shop.fn.isPayLaterSelected(this.paymentId)?`<div class="summary__term">\n      <label class="summary__term_label">\n        <span>\n          <input\n            type="checkbox"\n            name="${t.name}"\n            value="yes"\n            class="css-checkbox ${t?.className||""}"\n            onchange="app_shop.fn.validateTerms()"/>\n          <i class="css-label --small"/>\n        </span>\n        <span class="summary__term__value">${t.value}</span>\n      </label>\n    </div>`:""}hidden(t){return`<input type="${t.type}" value="${t.value}" name="${t.name}"/>`}terms(t){return`<div class="terms_description cm">\n      <div class="terms_checkbox">\n        <label><input type="checkbox" class="css-checkbox" required id="terms_iai_pay_checkbox" value="${t.value}" name="${t.name}" onchange="this.checked=true" checked/>\n          <span style="text-align: center;">${t.url?`${this.txt["Zapoznałem się i akceptuję"]} <a target="_blank" href="${t.url}" class="show_terms_btn">${this.txt["regulamin płatności jednorazowej IdoPay"]}</a>, ${this.txt["przez którą będzie realizowana płatność"]}.`:this.txt["Oświadczam, że zapoznałam / zapoznałem się i w pełni akceptuję Regulamin"]}.</span>\n        </label>\n      </div>\n    </div>`}button(t){const e=`${t.className||"orderdetails_paygate_finalize"} btn --large --solid`,s=203===this.paymentId?`${this.txt["Przejdź do płatności odroczonej"]} (${this.leftToPay})`:`${this.txt["Zapłać"]} ${this.leftToPay}`;return`\n    <button type="submit" value="${t.value}" class="${e}" ${t.id?` id="${t.id}"`:""}>\n      ${t.img?`<img src="${t.img}"/>`:""}\n      ${s}\n    </button>\n    `}getDescription(){const t=`<div id="paymentdescription">${this.paymentData?.description||""}</div>`;return this.paymentData?.description?t:""}getForm(){const{inputs:t=[],method:e="post",action:s=""}=this.paymentData?.fromData||{};return`\n      <form class="payment_popup_submit_form" method="${e}" action="${s}">\n        ${t.reduce(((t,e)=>t+=this[e?.type]?this[e?.type](e||{}):""),"")}\n      </form>\n    `}getHTML(){return`\n      ${this.getDescription()}\n      ${this.paymentData?.fromData?this.getForm():""}\n    `}}