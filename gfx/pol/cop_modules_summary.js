class SummaryCOP extends COPModules{constructor(e={}){super(e),this.initEventsOnce()}addLoading(){const e=document.querySelector(`.${this.prefix}__content`);e&&e.classList.add("--loading"),this.summaryElement?.classList.add("--loading")}removeLoading(){const e=document.querySelector(`.${this.prefix}__content`);e&&e.classList.remove("--loading"),this.summaryElement?.classList.remove("--loading")}addHighlightError(){document.querySelectorAll(".f-feedback.--error .f-control").forEach((e=>{e.classList.add("--highlight"),setTimeout((()=>{e.classList.remove("--highlight")}),2e3)}))}addHighlightColorError(){document.querySelectorAll(".--add-highlight-color").forEach((e=>{e.classList.remove("--add-highlight-color"),e.classList.add("--highlight-color"),setTimeout((()=>{e.classList.remove("--highlight-color")}),2e3)}))}formValidationFailed(){const e=document.querySelector(".f-feedback.--error .f-control.--validate:not(:disabled)")||document.querySelector(".f-group.--error .f-control.--validate:not(:disabled)")||document.querySelector(".f-feedback.--error .f-group.f-select.--validate .f-select-select:not(:disabled)");super.scrollToElement({element:e.closest(".--error"),callback:this.addHighlightError.bind(this)}),e?.focus()}validatePayment(){const e=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!e)return!0;const t=new FormData(e);return!!t.has("payform_id")||(!!t.has("first_payment_id")||!!t.has("selected_group_only"))}paymentValidationFailed(){const e=document.querySelector(`.${this.prefix}_payments`),t=document.querySelector(`.${this.prefix}_payments__select_payment`);e&&t&&(this.scrollToElement({element:e}),t.focus(),Alertek.Info(this.txt["Wybierz formę płatności"]))}validateDelivery(){const e=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!e)return!0;const t=new FormData(e);return!!t.has("shipping")&&!("turn_on"===t.get("division")&&!t.has("shipping_division"))}deliveryValidationFailed(){const e=new FormData(document.querySelector(`.${this.prefix}`));Alertek.Info(this.txt["Wybierz opcję dostawy"]);const t=e.has("shipping")?"later":"now",i=document.querySelector(`.${this.prefix}_deliveries`);if(!i)return;const r=i.querySelector(`.${this.prefix}_deliveries__block.--${t}`);if(!r)return;const s=document.querySelector(`.${this.prefix}_deliveries__label_link.--${t}`);i.classList.contains("--later")&&"now"===t&&s?.click?.(),i.classList.contains("--later")||"later"!==t||s?.click?.(),this.scrollToElement({element:r}),i.classList.contains("--dvp")?r.querySelectorAll(`.${this.prefix}_deliveries__item[data-prepaid="dvp"] .${this.prefix}_deliveries__select_delivery`)?.[0]?.focus():r.querySelectorAll(`.${this.prefix}_deliveries__item[data-prepaid="prepaid"] .${this.prefix}_deliveries__select_delivery`)?.[0]?.focus()}validatePickupPoint(){const e=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!e)return!0;const t=new FormData(e);return""!==t.get("pickup_point")&&(""!==t.get("stock")&&(""!==t.get("pickup_point_division")&&""!==t.get("stock_division")))}pickupValidationFailed(){const e=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!e)return;const t=new FormData(e);Alertek.Info(this.txt["Wybierz punkt odbioru"]);const i=""===t.get("pickup_point")||""===t.get("stock")?"now":"later",r=document.querySelector(`.${this.prefix}_deliveries`);if(!r)return;const s=r.querySelector(`.${this.prefix}_deliveries__block.--${i}`);if(!s)return;const a=s.querySelector(`.${this.prefix}_delivery.--checked`);if(!a)return;const n=a.querySelector(`.${this.prefix}_delivery__pickup_find`);if(!n)return;n.classList.add("--add-highlight-color");const o=document.querySelector(`.${this.prefix}_deliveries__label_link.--${i}`);r.classList.contains("--later")&&"now"===i&&o?.click?.(),r.classList.contains("--later")||"later"!==i||o?.click?.(),this.scrollToElement({element:a,callback:this.addHighlightColorError.bind(this)}),r.classList.contains("--dvp")?s.querySelectorAll(`.${this.prefix}_deliveries__item[data-prepaid="dvp"] .${this.prefix}_deliveries__select_delivery`)?.[0]?.focus():s.querySelectorAll(`.${this.prefix}_deliveries__item[data-prepaid="prepaid"] .${this.prefix}_deliveries__select_delivery`)?.[0]?.focus()}formatAddressData(e,t){const i=e.get(`${t}_street`),r=e.get(`${t}_street_number`);i&&r&&(e.set(`${t}_street`,`${i} ${r}`),e.delete(`${t}_street_number`));const s=e.get(`${t}_phone`),a=e.get(`${t}_phone_prefix`);s&&a&&(e.set(`${t}_phone`,`${a} ${s}`),e.delete(`${t}_phone_prefix`));const n=[...e].filter((e=>e[0].startsWith(`${t}_`)));let o="";return n.forEach((e=>{e[0]!==`${t}_firm`&&e[0]!==`${t}_additional`?e[0]!==`${t}_nip`||"client"===t?e[0]!==`${t}_firstname`?e[0]!==`${t}_lastname`?e[0]!==`${t}_street`?e[0]!==`${t}_zipcode`?e[0]!==`${t}_city`?e[0]!==`${t}_region`?e[0]!==`${t}_province`?e[0]===`${t}_phone`&&(o+=`phone:"${e[1]?.replace?.(/"/g,'\\"')}",`):o+=`province:"${e[1]?.replace?.(/"/g,'\\"')}",`:o+=`country:${e[1]?.replace?.(/"/g,'\\"')},`:o+=`city:"${e[1]?.replace?.(/"/g,'\\"')}",`:o+=`zipcode:"${e[1]?.replace?.(/"/g,'\\"')}",`:o+=`street:"${e[1]?.replace?.(/"/g,'\\"')}",`:o+=`lastname:"${e[1]?.replace?.(/"/g,'\\"')}",`:o+=`firstname:"${e[1]?.replace?.(/"/g,'\\"')}",`:o+=`taxNumber:"${e[1]?.replace?.(/"/g,'\\"')}",`:o+=`companyName:"${e[1]?.replace?.(/"/g,'\\"')}",`})),o}getClientDeliveryData(e,t){let i=`${t||"clientDeliveryData"}: {`;return i+=this.formatAddressData(e,"client"),i+="}",i}getClientDeliveryOtherAddressData(e,t){if(!e.has("deliver_to_billingaddr"))return"";let i=`${t||"clientDeliveryOtherAddressData"}: {`;return i+=this.formatAddressData(e,"delivery"),i+="}",i}getClientBillingOtherData(e,t){if(!e.has("invoice_to_billingaddr"))return"";let i=`${t||"clientBillingOtherData"}: {`;return i+=this.formatAddressData(e,"invoice"),i+="}",i}getTypeData(e){if(!e.has("client_type"))return"";return`type: ${e.get("client_type")}`}getBirthdateData(e){if(!e.has("birth_date"))return"";return`birthDate: "${e.get("birth_date").replace(/"/g,'\\"')}"`}getTaxNumberData(e){if(!e.has("client_nip"))return"";return`taxNumber: "${e.get("client_nip").replace(/"/g,'\\"')}"`}getEmailData(e){if(!e.has("client_email"))return"";return`email: "${e.get("client_email").replace(/"/g,'\\"')}"`}getLoginData(e){if(!e.has("client_login"))return"";return`login: "${e.get("client_login").replace(/"/g,'\\"')}"`}getPasswordData(e){if(!e.has("client_password"))return"";const t=e.get("client_password");return`password: "${t.replace(/"/g,'\\"')}", passwordRepeat: "${t.replace(/"/g,'\\"')}", `}getDeliveryAddressId(e,t){if(!e.has("deliver_to_billingaddr"))return"activeDeliveryAddress: 0";return`activeDeliveryAddress: ${t.querySelector('input[name="deliver_to_billingaddr"]')?.getAttribute("data-id")||0}`}getInvoiceAddressId(e,t){if(!e.has("invoice_to_billingaddr"))return"activeInvoiceAddress: 0";return`activeInvoiceAddress: ${t.querySelector('input[name="invoice_to_billingaddr"]')?.getAttribute("data-id")||0}`}getClientData(e){const t=this.getTypeData(e);if(!t)return"";const i=this.getBirthdateData(e),r=this.getTaxNumberData(e),s=this.getEmailData(e);return`clientData: {\n      ${this.getClientDeliveryData(e)}\n      ${this.getClientDeliveryOtherAddressData(e)}\n      ${this.getClientBillingOtherData(e)}\n      ${t}\n      ${i}\n      ${r}\n      ${s}\n      ${this.getSaveToMailingData(e)}\n      ${this.getSaveToSmsData(e)}\n    }`}getPaymentData(e){if(e.has("payform_id")){return`paymentMethodId: ${e.get("payform_id")}`}if(e.has("first_payment_id")){return`paymentMethodId: ${e.get("first_payment_id")}`}if(e.has("selected_group_only")){return`selectedGroup: "${e.get("selected_group_only")}"`}return""}getCourierData(e){if(!e.has("shipping"))return"";return`courierId: "${e.get("shipping").split("-")[0]}"`}getCourierAdditionalData(e){if(!e.has("calendar_services")&&!e.has("shipping"))return"";const t=e.get("calendar_services")?.split?.("-")?.[2]||e.get("shipping")?.split?.("-")?.[2];if(!t)return"";let i="SERVICE_WEEKEND_DELIVERY";return"2"===t&&(i="SERVICE_SATURDAY_DELIVERY"),"3"===t&&(i="ATYPICAL_PRODUCT_SIZE"),`deliveryAdditionalServicesId: ${i}`}getCourierForPointsData(e){if(!e.has("shipping_for_points")&&!e.has("calendar_services_points"))return"";const t=e.get("shipping_for_points")||e.get("calendar_services_points");return`isShippingForPoints: ${"1"===t||t}`}getCourierLaterData(e){if(!e.has("calendar_services_division")&&!e.has("shipping_division"))return"";return`courierIdLater: "${(e.get("calendar_services_division")||e.get("shipping_division")).split("-")[0]}"`}getPrepaidData(e){if(!e.has("shipping"))return"";return`prepaid: ${"1"===e.get("shipping").split("-")[1]?"prepaid":"dvp"}`}getPickupPointData(e){if(!e.has("pickup_point"))return"";return`pickupPointId: "${e.get("pickup_point")}"`}getPickupPointLaterData(e){if(!e.has("pickup_point_division"))return"";return`pickupPointIdLater: "${e.get("pickup_point_division")}"`}getClientCourierNumberData(e){if(!e.has("client_courier_number"))return"";return`clientCourierNumber: "${e.get("client_courier_number")}"`}getStockData(e){if(!e.has("stock"))return"";return`stockId: ${e.get("stock")}`}getStockLaterData(e){if(!e.has("stock_division"))return"";return`stockIdLater: ${e.get("stock_division")}`}getCalendarData(e){const t=e.get("calendar_select_date"),i=e.get("calendar_select_hour"),r=e.get("calendar_services");if(!t&&!i&&!r)return"";return`courierCalendarDetails: {\n      ${t?`selectedDate: "${t}"`:""}\n      ${i?`selectedHour: "${i}"`:""}\n      ${r?`calendarServiceCourierId: "${r.split("-")[0]}",calendarServicePaymentType: ${r.split("-")[1]}`:""}\n    }`}getRemarksData(e){if(!e.has("remarks"))return"";return`remarks: """${e.get("remarks").replace(/"/g,'\\"')}"""`}getDeliveryRemarksData(e){if(!e.has("delivery_remarks"))return"";return`deliveryRemarks: """${e.get("delivery_remarks").replace(/"/g,'\\"')}"""`}getDocumentTypeData(e){if(!e.has("invoice"))return"";const t=e.get("invoice");return"0"===t?"purchaseDocumentType: confirmation":"1"===t?"purchaseDocumentType: invoice":"2"===t?"purchaseDocumentType: eInvoice":""}getSaveToMailingData(e){return e.has("client_mailing")?"saveToMailingAfterOrder: true":""}getSaveToSmsData(e){return e.has("client_sms")?"saveToSmsAfterOrder: true":""}getEmailProcessingData(e){return e.has("order_email-processing")?"emailProcessingConsent: true":""}getCheckoutTypeData(){return`checkoutType: ${"oscop"===this.type?"oscop":"multistep"}`}getOrderData(e){const t=this.getPaymentData(e);if(!t)return"";return`orderData: {\n      ${t}\n      ${this.getCourierData(e)}\n      ${this.getCourierAdditionalData(e)}\n      ${this.getCourierForPointsData(e)}\n      ${this.getCourierLaterData(e)}\n      ${this.getPrepaidData(e)}\n      ${this.getPickupPointData(e)}\n      ${this.getPickupPointLaterData(e)}\n      ${this.getClientCourierNumberData(e)}\n      ${this.getStockData(e)}\n      ${this.getStockLaterData(e)}\n      ${this.getCalendarData(e)}\n      ${this.getRemarksData(e)}\n      ${this.getDeliveryRemarksData(e)}\n      ${this.getDocumentTypeData(e)}\n      ${this.getEmailProcessingData(e)}\n      ${this.getCheckoutTypeData()}\n    }`}prepareOrderCreateInput(){const e=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!e)return"orderCreateInput: {}";const t=new FormData(e);return`orderCreateInput: {\n      ${this.getClientData(t)}\n      ${this.getOrderData(t)}\n    }`}async orderCreate(){const e=this.prepareOrderCreateInput(),t=await this.fetchData({data:this.queries.ORDER_CREATE(e),linkParameter:`?mutation=copModulesOrderCreate&type=${this.type}`});if(t?.data?.orderCreate?.location)return sessionStorage.removeItem("userOnceData"),void(window.location.href=t.data.orderCreate.location);this.removeLoading()}getCheapestCourier(e=[]){return e.filter((e=>e.minworthReached&&0!==e.courier.id)).sort(((e,t)=>e.cost.value-t.cost.value))[0]}getFastestCourier(e=[],t=!1){const i=t?e.filter((e=>e.minworthReached&&"later"===e.availability&&0!==e.courier.id)):e.filter((e=>e.minworthReached&&"now"===e.availability&&0!==e.courier.id)),r=i.filter((e=>e.deliveryTime.today));if(r.length)return r[0];return i.sort(((e,t)=>e.deliveryTime.time.days-t.deliveryTime.time.days))[0]}getDeliveryTimeObject(e){if(!e)return!1;const t=0===e.courier?.id,{today:i}=e.deliveryTime||{};if(i)return{dateFormatted:this.locale.weekdays[0],pickup:t};const{weekDay:r,weekAmount:s}=e?.deliveryTime;if(s>0){const{days:i}=e?.deliveryTime?.time||{},{day:s,month:a}=super.calculateDate({days:i})||{};return{dateFormatted:`${this.locale.weekdays[r]} (${s}.${a})`,pickup:t}}return{dateFormatted:this.locale.weekdays[r],pickup:t}}async getDeliveryTime(){const e=super.getFormDataFromSessionStorage(),{delivery_time:t,delivery_time_division:i}=e||{};if(t){const e={dateFormatted:t},r=!!i&&{dateFormatted:i};return void this.updateTime({now:e,later:r,hideLater:!r})}const r=await super.fetchData({data:this.queries.DELIVERY_TIME(),linkParameter:`?query=copModulesDeliveryTime&type=${this.type}`}),{shipping:s}=r?.data?.shipping||{};if(!s)return;this.vars.cheapestCourier=this.getCheapestCourier(s);const a=this.getFastestCourier(s),n=this.getFastestCourier(s,!0);if(!a)return;const o=this.getDeliveryTimeObject(a),c=this.getDeliveryTimeObject(n);this.updateTime({now:o,later:c,hideLater:!c})}async updateTime(e){if(!this.summaryElement)return;if(!e)return void await this.getDeliveryTime();const t=this.summaryElement.querySelector(`.${this.prefix}_time`);if(!t)return;const{now:i,later:r,hideLater:s}=e,a=t.querySelector(`.${this.prefix}_time__item.--now`);if(i&&a){const{dateFormatted:e,pickup:t}=i,r=a.querySelector(`.${this.prefix}_time__value`);r&&(r.textContent=e);const s=a.querySelector(`.${this.prefix}_time__label`);s&&(s.textContent=t?`${this.txt["Odbiór zamówienia możliwy"]}:`:`${this.txt["Przewidywana dostawa"]}:`)}const n=t.querySelector(`.${this.prefix}_time__item.--later`);if(n&&(s&&n.classList.remove("--active"),r)){const{dateFormatted:e,pickup:t}=r,i=n.querySelector(`.${this.prefix}_time__value`);i&&(i.textContent=e),n.classList.add("--active")}}async getRegisterRecaptchaToken(){const e=await(window?.getRecaptchaToken?.());return e?`reCaptchaToken: "${e||""}"`:""}async prepareRegisterClientInput(e,t,i="RegisterClientInput"){const r=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!r)return`${i}: {}`;const s=new FormData(r),a=this.getClientDeliveryData(s),n=this.getClientDeliveryOtherAddressData(s),o=this.getClientBillingOtherData(s),c=this.getTypeData(s),l=this.getBirthdateData(s),u=this.getTaxNumberData(s),d=this.getEmailData(s),p=this.getLoginData(s),h=this.getPasswordData(s);return`${i}: {\n      clientData: {\n        ${a}\n        ${n}\n        ${o}\n        ${c}\n        ${l}\n        ${u}\n        ${d}\n        ${this.getSaveToMailingData(s)}\n        ${this.getSaveToSmsData(s)}\n      }\n      ${!e||t?`\n      loginAndPassword: {\n        ${p}\n        ${h}\n      }\n      `:""}\n      ${await this.getRegisterRecaptchaToken()}\n      ${t?"isOnceUserCreatingAccount: true":""}\n      ${!t&&e?"isOnceUserCreatingAccount: false":""}\n    }`}prepareUpdateClientInput(e){const t=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!t)return"UpdateClientData: {}";const i=e||new FormData(t);return`UpdateClientInput: {\n      ${this.getClientDeliveryData(i)}\n      ${this.getTypeData(i)}\n      ${this.getBirthdateData(i)}\n      ${this.getTaxNumberData(i)}\n      ${this.getEmailData(i)}\n      ${this.getDeliveryAddressId(i,t)}\n      ${this.getInvoiceAddressId(i,t)}\n    }`}prepareUpdateClientDeliveryOtherAddressInput(){const e=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!e)return"UpdateDeliveryAddressInput: {}";const t=new FormData(e),i=(e.querySelector('input[name="deliver_to_billingaddr"]'),app_shop.vars.isOtherAddressChange?this.getClientDeliveryOtherAddressData(t,"ClientDeliveryData"):"");return i?this.queries.INSERT_CLIENT_OTHER_ADDRESS(i):""}prepareClientBillingOtherAddressInput(){const e=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!e)return"UpdateInvoiceAddressInput: {}";const t=new FormData(e),i=e.querySelector('input[name="invoice_to_billingaddr"]'),r=i?.getAttribute("data-id")||0,s="true"===i?.getAttribute("data-edit")&&0!==r?"update":"insert",a=app_shop.vars.isBillingOtherAddressChange?this.getClientBillingOtherData(t,"update"===s?"clientInvoiceData":"ClientInvoiceData"):"";return"insert"===s?a?this.queries.INSERT_CLIENT_BILLING_OTHER_ADDRESS(a):"":a?this.queries.UPDATE_CLIENT_BILLING_OTHER_ADDRESS(`UpdateInvoiceAddressInput: {\n      id: ${r}\n      ${a}\n    }`):""}async registerClient(){const e=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!e)return!1;if(!new FormData(e).has("register_client"))return!1;const t=await this.prepareRegisterClientInput();return await super.fetchData({data:this.queries.REGISTER_CLIENT(t),linkParameter:`?mutation=copModulesRegisterClient&type=${this.type}`})}async updateClient(){const e=this.prepareUpdateClientInput(),t=this.prepareUpdateClientDeliveryOtherAddressInput(),i=this.prepareClientBillingOtherAddressInput();if(this.vars.initUpdateClientInput===e&&!t&&!i)return!0;const r=JSON.stringify({query:`mutation {\n        ${i}\n        ${this.vars.initUpdateClientInput!==e?this.queries.UPDATE_CLIENT(e):""}\n        ${t}\n      }`});return await super.fetchData({data:r,linkParameter:`?mutation=copModulesUpdateClient&type=${this.type}`,alert:!1})}async setOnceOrderClient(){const e=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!e)return!1;const t=new FormData(e),i=await this.prepareRegisterClientInput(!0,t.has("register_client"),"SetUserOnceInput"),r=await super.fetchData({data:this.queries.SET_USER_ONCE(i),linkParameter:`?mutation=copModulesUserOnceClient&type=${this.type}`});return"success"===r?.data?.setUserOnce?.status&&sessionStorage.setItem("userOnceData","true"),r}getDeliveryCostData(e){const t=e.get("shipping"),i=e.get("calendar_services");if(!t&&!i)return"";const[r,s]=i?i.split("-"):t.split("-");return`delivery: {courierId: "${r}", prepaid: ${!!+s}}`}getDeliveryDivisionCostData(e){const t=e.get("shipping_division"),i=e.get("calendar_services_division");if(!t&&!i)return"";const[r,s]=i?i.split("-"):t.split("-");return`deliveryDivision: {courierId: "${r}", prepaid: ${!!+s}}`}getForPointsCostData(e){if(!e.has("shipping_for_points")&&!e.has("calendar_services_points"))return"";const t=e.get("shipping_for_points")||e.get("calendar_services_points");return`shippingForPoints: ${"1"===t||t}`}getForPointsDivisionCostData(e){if(!e.has("shipping_for_points_division"))return"";const t=e.get("shipping_for_points_division");return`shippingForPointsLater: ${"1"===t||t}`}getPaymentCostData(e){const t=e.get("payform_id"),i=e.get("first_payment_id");return t||i?t?`paymentMethodId: ${t}`:`paymentMethodId: ${i}`:""}getServicesCostData(e){return e.has("calendar_services")?"deliveryCalendarServices: true":""}getServicesPointsCostData(e){return e.has("calendar_services_points")?"deliveryCalendarServicesPoints: true":""}getServicesAdditionalCostData(e){if(!e.has("calendar_services")&&!e.has("shipping"))return"";const t=e.get("calendar_services")?.split?.("-")?.[2]||e.get("shipping")?.split?.("-")?.[2];if(!t)return"";let i="SERVICE_WEEKEND_DELIVERY";return"2"===t&&(i="SERVICE_SATURDAY_DELIVERY"),"3"===t&&(i="ATYPICAL_PRODUCT_SIZE"),`deliveryAdditionalServicesId: ${i}`}prepareBasketCostInput(){const e=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!e||this.vars.cheapestCourier){const{courier:{fullId:e}={}}=this.vars.cheapestCourier||{};return e?`BasketCostInput: {\n        delivery: {\n          courierId: "${e.split("-")[0]}",\n          prepaid: ${"1"===e.split("-")[1]},\n        },\n      }`:"BasketCostInput: {}"}const t=new FormData(e);return`BasketCostInput: {\n      ${this.getDeliveryCostData(t)}\n      ${this.getDeliveryDivisionCostData(t)}\n      ${this.getForPointsCostData(t)}\n      ${this.getForPointsDivisionCostData(t)}\n      ${this.getPaymentCostData(t)}\n      ${this.getServicesCostData(t)}\n      ${this.getServicesPointsCostData(t)}\n      ${this.getServicesAdditionalCostData(t)}\n    }`}updateWorth(e){const t=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--worth`);if(!t)return;const{formatted:i}=e?.totalProductsCost||{};if(!i)return void t.classList.remove("--active");const r=t.querySelector(`.${this.prefix}_costs__value`);r&&(r.textContent=i,t.classList.add("--active"))}updateWorthPoints(e){const t=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--worth-points`);if(!t)return;const{value:i}=e?.totalProductsCostAtPoints||{};if(!i)return void t.classList.remove("--active");const r=t.querySelector(`.${this.prefix}_costs__value`);r&&(r.textContent=`${i} ${this.txt.pkt}.`,t.classList.add("--active"))}updateRebate(e){const t=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--rebate`);if(!t)return;const{formatted:i,value:r}=e?.totalRebateWithoutShipping||{};if(!i||!r)return void t.classList.remove("--active");const s=t.querySelector(`.${this.prefix}_costs__value`);s&&(s.textContent=i,t.classList.add("--active"))}updatePaymentCost(e){const t=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--paymentcost`);if(!t)return;const{formatted:i,value:r}=e?.prepaidCost||{};if(!i||!r)return void t.classList.remove("--active");const s=t.querySelector(`.${this.prefix}_costs__value`);s&&(s.textContent=i,t.classList.add("--active"))}updateCheapestShippingCost(e,t){const i=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--${t}`);if(!i)return;const r="shipping-to-door"===t?"cheapestShippingToDoorCourier":"cheapestShippingToPickupPoint",{shippingCost:s,icon:a}=e?.basketShippingCost?.[r]||{};if(!s||!a)return;const n=i.querySelector(`.${this.prefix}_costs__value`),o=i.querySelector(`.${this.prefix}_costs__img`);if(n&&o){if(o.setAttribute("src",a),!s||!parseFloat(s.replace(",",".")))return i.classList.add("--active"),n.textContent=`${this.txt.Gratis}!`,void n.classList.remove("--plus");n.classList.add("--plus"),n.textContent=s,i.classList.add("--active")}else i.classList.remove("--active")}updateShippingCost(e){const t=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--shipping`);if(!t)return;const{formatted:i,value:r}=e?.basketShippingCost?.shippingCostAfterRebate||{},{shippingCostPoints:s}=e?.basketShippingCost||{},a=t.querySelector(`.${this.prefix}_costs__value`),n=t.querySelector(`.${this.prefix}_costs__label`);if(a&&n){if(!(s||i&&r))return t.classList.add("--active"),n.textContent=`${this.txt["Koszt przesyłki"]}:`,a.textContent=`${this.txt.Gratis}!`,void a.classList.remove("--plus");if(a.classList.add("--plus"),s)return a.textContent=`${s} ${this.txt.pkt}.`,void t.classList.add("--active");a.textContent=i,t.classList.add("--active")}else t.classList.remove("--active")}updateInsurance(e){const t=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--insurance`);if(!t)return;const{formatted:i,value:r}=e?.insuranceCost||{};if(!i||!r)return void t.classList.remove("--active");const s=t.querySelector(`.${this.prefix}_costs__value`);s&&(s.textContent=i,t.classList.add("--active"))}updateBalance(e){const t=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--balance`);if(!t)return;const{formatted:i,value:r,type:s}=e?.paymentAmountFromClientBalance||{};if(!i||!r)return void t.classList.remove("--active");const a=t.querySelector(`.${this.prefix}_costs__value`),n=t.querySelector(`.${this.prefix}_costs__label`);a&&n&&(a.textContent=i,t.classList.add("--active"),"underpayment"===s&&(n.innerHTML=`${this.txt["Opłacone z salda"]}:<br>(${this.txt["niedopłata na koncie klienta"]})`,a.classList.remove("--minus"),a.classList.add("--plus")))}updateDeposit(e){const t=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--deposit`);if(!t)return;const{formatted:i,value:r}=e?.totalDeposit||{};if(!i||!r)return void t.classList.remove("--active");const s=t.querySelector(`.${this.prefix}_costs__value`);s&&(s.textContent=i,t.classList.add("--active"),"function"==typeof app_shop.fn.addDepositInfo&&app_shop.fn.addDepositInfo(".cop_costs__label_deposit",{priceDirect:i}))}checkDeliveryType(){const e=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!e)return"";const t=new FormData(e);if(!t.has("shipping"))return"";return"1"===t.get("shipping").split("-")[1]?"prepaid":"dvp"}showHideAdvance(e,t){const i=this.checkDeliveryType();i&&i!==t&&"both"!==t?e.classList.remove("--active"):e.classList.add("--active")}updateAdvance(e){const t=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--advance`);if(!t)return;const i=super.getFormDataFromSessionStorage(),{basket_cost_advance:r,basket_cost_advance_type:s}=i||{},a=r?{value:r,formatted:r,type:s||"both"}:e?.advancePay,{formatted:n,value:o,type:c}=a||{};if(!n||!o)return void t.classList.remove("--active");const l=t.querySelector(`.${this.prefix}_costs__value`),u=t.querySelector(`.${this.prefix}_costs__label`);if(l&&u){if(this.showHideAdvance(t,c),l.textContent=n,"prepaid"===c)return t.classList.add("--prepaid"),t.classList.remove("--dvp"),void(u.innerHTML=`${this.txt["Wymagana zaliczka"]}:<br>(${this.txt["przy zamówieniu za przedpłatą"]})`);if("dvp"===c)return t.classList.add("--dvp"),t.classList.remove("--prepaid"),void(u.innerHTML=`${this.txt["Wymagana zaliczka"]}:<br>(${this.txt["przy zamówieniu z płatnością przy odbiorze"]})`);u.innerHTML=`${this.txt["Wymagana zaliczka"]}:`,t.classList.remove("--prepaid","--dvp")}}updateTotal(e){const t=this.summaryElement.querySelector(`.${this.prefix}_total__item.--value .${this.prefix}_total__value`);if(!t)return;const{formatted:i}=e?.totalToPay||{};if(!i)return;t.textContent=`${i}`;const r=document.querySelector(".progress__item.--shopping-cart .progress__description");if(!r)return;r.textContent=`${i}`;const s=this.summaryElement.querySelector(`.${this.prefix}_buttons__cost`);s&&(s.textContent=`${i}`)}updateTotalPoints(e){const t=this.summaryElement.querySelector(`.${this.prefix}_total__item.--points`);if(!t)return;const i=t.querySelector(`.${this.prefix}_total__value`);if(!i)return;const{value:r}=e?.totalToPayAtPoints||{};r?(t.classList.add("--active"),i.textContent=`${r} ${this.txt.pkt}.`):t.classList.remove("--active")}updateSubscription(e){const t=this.summaryElement.querySelector(`.${this.prefix}_subscription_term`);if(!t)return;if(!e?.length)return void t.classList.remove("--active");const i=e.find((e=>e.types.includes("subscription")));if(!i)return void t.classList.remove("--active");const{formatted:r,value:s}=i?.worthTotal?.gross||{};r&&s?(t.textContent=t.textContent.replace(/%s/g,r),t.classList.add("--active")):t.classList.remove("--active")}getDelayTime(e){const t=Date.now()-e;let i=0;return t<super.minDelayTime&&(i=super.minDelayTime-t),i}getBasketCostData(){const e=super.getFormDataFromSessionStorage(),{basket_cost_total:t,basket_cost_worth:i}=e||{};if(!t||!i)return!1;const{basket_cost_worth_points:r,basket_cost_rebate:s,basket_cost_shipping:a,basket_cost_shipping_to_door:n,basket_cost_shipping_to_pickup:o,basket_cost_shipping_to_door_icon:c,basket_cost_shipping_to_pickup_icon:l,basket_cost_balance:u,basket_cost_balance_type:d,basket_cost_total_points:p,basket_cost_subscription:h,basket_cost_advance:m,basket_cost_advance_type:_,basket_cost_deposit:v}=e||{};return{data:{basket:{basketCost:{totalToPay:{formatted:t},totalProductsCost:{formatted:i},...r?{totalProductsCostAtPoints:{value:r}}:{},...s?{totalRebateWithoutShipping:{value:s,formatted:s}}:{},...a||n||o?{basketShippingCost:{shippingCostAfterRebate:{value:a,formatted:a},cheapestShippingToDoorCourier:{shippingCost:n,icon:c},cheapestShippingToPickupPoint:{shippingCost:o,icon:l}}}:{},...u?{paymentAmountFromClientBalance:{value:u,formatted:u,type:d}}:{},...p?{totalToPayAtPoints:{value:p}}:{},...m?{advancePay:{value:m,formatted:m,type:_||"both"}}:{},...v?{totalDeposit:{value:v,formatted:v}}:{}},...h?{basketGroups:[{types:["subscription"],worthTotal:{gross:{value:h,formatted:h}}}]}:{basketGroups:[]}}}}}async updateCosts(){if(!this.summaryElement)return;this.summaryElement.classList.add("--loading");const e=this.prepareBasketCostInput(),t=Date.now(),i=this.getBasketCostData()||await super.fetchData({data:this.queries.BASKET_COST(e),linkParameter:`?query=copModulesBasketCost&type=${this.type}`}),{basketCost:r,basketGroups:s}=i?.data?.basket||{};r&&(this.updateWorth(r),this.updateWorthPoints(r),this.updateRebate(r),this.updatePaymentCost(r),this.updateShippingCost(r),this.updateInsurance(r),this.updateBalance(r),this.updateAdvance(r),this.updateTotal(r),this.updateTotalPoints(r),this.updateSubscription(s),this.updateDeposit(r),setTimeout((()=>{this.summaryElement.classList.remove("--loading")}),this.getDelayTime(t)))}updateFreeDelivery(){const e=this.summaryElement.querySelector(`.${this.prefix}_free_delivery`);e&&("order1"!==this.type&&"order2"!==this.type&&"oscop"!==this.type||e.remove())}updateClause(e=[]){const t=this.summaryElement.querySelector(`.${this.prefix}_clauses`);if(!t)return;if("basket"===this.type||"order1"===this.type)return void t.remove();if(t.innerHTML="",t.classList.remove("--active"),!e?.length)return;e.forEach((e=>{const{clause:i,type:r}=e;if(!i)return;const s=document.getElementById(`${this.prefix}_clause_item_template`)?.content.cloneNode(!0);s&&(s.firstChild.innerHTML=i,s.firstChild.setAttribute("data-type",r),t.appendChild(s))}));t.querySelector(`.${this.prefix}_clauses__item`)&&t.classList.add("--active")}updateAgreeTerms(e){const t=this.summaryElement.querySelector(`.${this.prefix}_terms__item.--agree`);if(!t)return;const i=t.querySelector(".f-label");i&&e?i.innerHTML=e:t.remove()}updateEmailProcessingTerms(e,t){const i=this.summaryElement.querySelector(`.${this.prefix}_terms__item.--email-processing`);if(!i)return;const r=i.querySelector(".f-label"),s=i.querySelector(".f-control");r&&s&&e?(r.innerHTML=e,s.checked=t):i.remove()}updateVirtualProductsTerms(e=[]){const t=this.summaryElement.querySelector(`.${this.prefix}_terms__item.--virtual`);t&&!e.length&&t.remove()}updateServiceProductsTerms(e=[]){const t=this.summaryElement.querySelector(`.${this.prefix}_terms__item.--service`);t&&!e.length&&t.remove()}updateTerms(){const e=this.summaryElement.querySelector(`.${this.prefix}_terms`);if(!e)return;if("basket"===this.type||"order1"===this.type)return void e.remove();const{order:{personalDataProcessing:{dataProcessingText:t,emailProcessingText:i,emailProcessingChecked:r}={}}={}}=this.vars.settings||{};this.updateAgreeTerms(t),this.updateEmailProcessingTerms(i,r);const{products:s=[]}=this.vars.basket||{},a=s.filter((e=>"virtual"===e.data?.type));this.updateVirtualProductsTerms(a);const n=s.filter((e=>"service"===e.data?.type));this.updateServiceProductsTerms(n)}updateBuyButton(e){if(!e)return;if("basket"===this.type||"order1"===this.type)return void e.remove();const t=e.querySelector(`.${this.prefix}_buttons__button_text`);if(!t)return;const i=super.getFormDataFromSessionStorage(),{buy_button_text:r=this.txt["Akceptuję, zamawiam i płacę"]}=i||{};r&&(t.textContent=r)}afterChangePayment(e){const t=this.summaryElement.querySelector(`.${this.prefix}_buttons__button.--buy`);if(!t)return;const i=t.querySelector(`.${this.prefix}_buttons__button_text`);i&&(i.textContent="203"===e?this.txt["Zamawiam i płacę później"]:this.txt["Akceptuję, zamawiam i płacę"])}updateNextButton(e){e&&("order2"!==this.type&&"oscop"!==this.type||e.remove())}updateButtons(){const e=this.summaryElement.querySelector(`.${this.prefix}_buttons`);e&&(this.updateBuyButton(e.querySelector(`.${this.prefix}_buttons__button.--buy`)),this.updateNextButton(e.querySelector(`.${this.prefix}_buttons__button.--next`)))}updateInpostPay(e){if(!e)return;(e=>{const t=`\n        .inpostizi-bind-button-body,\n        div[role="button"],\n        button {\n          width: 100% !important;\n          max-width: none !important;\n          border-radius: ${getComputedStyle(e).getPropertyValue("--border-radius")||"0px"} !important;\n        }\n      `,i=document.createElement("style");i.id="inpostPayStyle",i.innerHTML=t;const r=e=>{e.querySelector("style#inpostPayStyle")||e.appendChild(i.cloneNode(!0))},s=e=>{const t=()=>{var i;e.shadowRoot?(r(e.shadowRoot),i=e.shadowRoot,new MutationObserver((()=>{r(i)})).observe(i,{childList:!0,subtree:!0})):requestAnimationFrame(t)};requestAnimationFrame(t)},a=new MutationObserver((()=>{const t=e.querySelector("inpost-izi-button");t&&(s(t),a.disconnect())}));a.observe(e,{childList:!0})})(e),"function"==typeof renderInpostPayButton&&renderInpostPayButton("basket","copInpostPay")}updateOneClick(e){if(!e)return;e.querySelectorAll(`.${this.prefix}_oneclick_pay__item`).forEach((e=>{if("undefined"!=typeof expressCheckoutApi&&"function"==typeof expressCheckoutApi.basketCheckout){const t=e.getAttribute("data-id");expressCheckoutApi.basketCheckout(t,e)}}))}updateOneClicks(){const e=this.summaryElement?.querySelector(`.${this.prefix}_oneclick`);e&&("order1"!==this.type&&"order2"!==this.type&&"oscop"!==this.type?(this.updateInpostPay(e.querySelector(`.${this.prefix}_inpost_pay`)),this.updateOneClick(e.querySelector(`.${this.prefix}_oneclick_pay`))):e.remove())}updateSafe(){const e=this.summaryElement.querySelector(`.${this.prefix}_safe`);e&&("basket"!==this.type&&"order1"!==this.type||e.remove())}async validateAllData(){if(this.addLoading(),"basket"===this.type)return!0;if(!await this.validate.validateForm())return this.removeLoading(),this.formValidationFailed(),!1;if(!this.validatePayment())return this.removeLoading(),this.paymentValidationFailed(),!1;if(!this.validateDelivery())return this.removeLoading(),this.deliveryValidationFailed(),!1;return!!this.validatePickupPoint()||(this.removeLoading(),this.pickupValidationFailed(),!1)}checkFixedBuyButton(){if("oscop"!==this.type)return!1;if(0===document.documentElement.scrollTop)return!1;const e=this.summaryElement.getBoundingClientRect().top,t=this.summaryElement.querySelector(`.${this.prefix}_buttons`)?.offsetHeight||0;return!(e-window.innerHeight+t<=0)}async saveClient(){let e=!1;return e=app_shop.vars?.logged?await this.updateClient():await this.setOnceOrderClient(),!(!e||e?.errors||e?.data?.insertDeliveryAddress?.isError||e?.data?.updateClient?.isError)||(Alertek.Error(this.txt["Wystąpił błąd w zapisie danych, zweryfikuj ich poprawność i spróbuj ponownie"]),!1)}async onClickNextButton(e){if(!await this.validateAllData())return void e.preventDefault();const{target:t}=e;if(super.saveFormDataToSessionStorage(),"order1"===app_shop.vars.copModulesType){e.preventDefault();return await this.saveClient()?void document.querySelector(this.vars.formSelector)?.submit?.():(this.removeLoading(),!1)}if(t.closest("form"))return;const i=document.querySelector(this.vars.formSelector);if(!this.vars.formSelector||!i)return;const r=document.createElement("input");r.type="hidden",r.name="after_basket_change",r.value="order",i.appendChild(r),i.submit()}async onClickBuyButton(){await this.validateAllData()&&(await this.registerClient(),this.orderCreate())}onScrollFixedBuyButton(){document.documentElement.classList.toggle("--cop-fixed-button",this.checkFixedBuyButton())}initEvents(){this.summaryElement.addEventListener("click",(e=>{const{target:t}=e;if(!t.closest(`.${this.prefix}_buttons__button.--next`))return t.closest(`.${this.prefix}_buttons__button.--buy`)?(e.preventDefault(),void this.onClickBuyButton()):void 0;this.onClickNextButton(e)}))}onFocusInput(){document.documentElement.classList.add("--focus")}onBlurInput(){"INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName&&document.documentElement.classList.remove("--focus")}onResizeWindow(){window.visualViewport.height<window.innerHeight?document.documentElement.classList.add("--focus"):document.documentElement.classList.remove("--focus")}initFocus(){document.querySelectorAll(`.${this.prefix} input:not([type="checkbox"]):not([type="radio"]), .${this.prefix} textarea`).forEach((e=>{e.addEventListener("focus",this.onFocusInput),e.addEventListener("blur",this.onBlurInput)})),window.addEventListener("resize",this.onResizeWindow)}initEventsOnce(){document.addEventListener("scroll",this.onScrollFixedBuyButton.bind(this),!0);const e=app_shop.fn.copModules?.afterAllModulesInit;app_shop.fn.copModules.afterAllModulesInit=()=>{e?.(),this.initFocus()}}afterLogin(){this.saveFormData()}saveFormData(){const e=document.querySelector(this.vars.formSelector);this.vars.formSelector&&e&&(this.vars.initUpdateClientInput=this.prepareUpdateClientInput(new FormData(e)))}generate(){const e=document.getElementById(`${this.prefix}_summary_template`)?.content.cloneNode(!0);if(!e||!e.firstChild)return;const t=this.summaryElement;if(this.summaryElement=e.firstChild,this.updateFreeDelivery(),this.updateClause(),this.updateTerms(),this.updateButtons(),this.updateSafe(),this.initEvents(),t&&document.body.contains(t))return t.replaceWith(this.summaryElement),this.updateOneClicks(),this.validate.reInit(),void this.saveFormData();super.move({element:this.summaryElement,...this.vars.move}),this.updateOneClicks(),this.validate.reInit(),this.saveFormData()}init(e={}){this.type=e.type||app_shop.vars.copModulesType||"order1",this.vars={afterReady:e.afterReady||(()=>{}),move:e.move||this.vars?.move||{},formSelector:e.formSelector||!1,basket:e.basket||{},settings:e.settings||{}},this.generate(),this.vars.afterReady(this.summaryElement)}}try{app_shop.fn.copModulesSummary=new SummaryCOP,app_shop.vars.copModulesClasses.push((()=>{app_shop.fn.copModulesSummary=new SummaryCOP}))}catch(e){window?.errorLog?.(e)}