class SubscrRemarks extends Subscr{constructor(e={}){super(e)}setWcagAttributes(e){e.setAttribute("aria-hidden","true"),e.querySelectorAll("a, button, textarea").forEach((e=>e.setAttribute("tabindex","-1")))}removeWcagAttributes(e){e.removeAttribute("aria-hidden"),e.querySelectorAll("a, button, textarea").forEach((e=>e.removeAttribute("tabindex")))}async updateRemarkSubscription({type:e="subscription",text:t}){if(this.vars[`${e}Note`]===t)return{status:"same"};this.remarksElement.classList.add("--loading");const r=this.getRemarkInputQuery({type:e,text:t}),s=await this.fetchData({data:this.queries.UPDATE_SUBSCRIPTION(r),linkParameter:`?mutation=subscriptionAddRemark&type=${e}`}),{status:i}=s?.data?.updateSubscription||{};return"success"!==i?(this.remarksElement.classList.remove("--loading"),{status:"error"}):(this.vars[`${e}Note`]=t,this.callbacks.afterChangeRemark?.(),{status:"success"})}getRemarkInputQuery({type:e="subscription",text:t}){return`subscriptionEditModel: {\n      subscriptionId: ${this.vars.subscrId},\n      ${"subscription"===e?`subscriptionNote: "${t}",`:`courierNote: "${t}",`}\n    }`}initFilled(){if(!this.vars.courierNote&&!this.vars.subscriptionNote)return;const e=this.remarksElement.querySelector(`.${this.prefix}_remarks__item.--delivery`);this.vars.courierNote&&e&&this.onClickSaveRemark(e,this.vars.courierNote);const t=this.remarksElement.querySelector(`.${this.prefix}_remarks__item.--shop`);this.vars.subscriptionNote&&t&&this.onClickSaveRemark(t,this.vars.subscriptionNote)}async onClickShowTextarea(e){const t=e.closest(`.${this.prefix}_remarks__item`);if(!t)return;const r=t.querySelector(`.${this.prefix}_remarks__textarea`);if(!r)return;const s=t.querySelector(`.${this.prefix}_remarks__textarea_wrapper`);if(!s)return;const i=t.querySelector(`.${this.prefix}_remarks__text`);if(!i)return;const a=t.querySelector(`.${this.prefix}_remarks__input`);if(!a)return;const o=t.classList.contains("--shop")?"subscription":"courier",{status:n}=await this.updateRemarkSubscription({type:o,text:r.value});if("success"===n)return;if("error"===n)return void t.classList.add("--error");t.classList.remove("--filled","--error"),t.classList.toggle("--active");return t.classList.contains("--active")?(r.disabled=!1,a.disabled=!1,a.value=r.value,setTimeout((()=>{r.focus()}),200),void this.removeWcagAttributes(s)):""===r.value?(t.classList.remove("--filled"),i.textContent="",a.value="",a.disabled=!0,void this.setWcagAttributes(s)):(t.classList.add("--filled"),i.textContent=r.value,a.value=r.value,a.disabled=!1,void this.setWcagAttributes(s))}async onClickSaveRemark(e,t){const r=e.closest(`.${this.prefix}_remarks__item`);if(!r)return;const s=r.querySelector(`.${this.prefix}_remarks__input`);if(!s)return;const i=r.querySelector(`.${this.prefix}_remarks__textarea`);if(!i)return;const a=r.querySelector(`.${this.prefix}_remarks__text`);if(!a)return;const o=r.querySelector(`.${this.prefix}_remarks__message_wrapper`);if(!o)return;const n=r.querySelector(`.${this.prefix}_remarks__textarea_wrapper`);if(n){if(!t){const e=r.classList.contains("--shop")?"subscription":"courier",{status:t}=await this.updateRemarkSubscription({type:e,text:i.value});if("success"===t)return;if("error"===t)return void r.classList.add("--error")}if(r.classList.remove("--active","--error"),""===i.value&&!t)return r.classList.remove("--filled"),a.textContent="",s.value="",s.disabled=!0,this.setWcagAttributes(o),void this.setWcagAttributes(n);r.classList.add("--filled"),a.textContent=t||i.value,s.disabled=!1,s.value=t||i.value,i.value=t||i.value,this.removeWcagAttributes(o),this.setWcagAttributes(n)}}async onClickRemoveRemark(e){const t=e.closest(`.${this.prefix}_remarks__item`);if(!t)return;const r=t.querySelector(`.${this.prefix}_remarks__input`);if(!r)return;const s=t.querySelector(`.${this.prefix}_remarks__textarea`);if(!s)return;const i=t.querySelector(`.${this.prefix}_remarks__text`);if(!i)return;const a=t.querySelector(`.${this.prefix}_remarks__message_wrapper`);if(!a)return;const o=t.classList.contains("--shop")?"subscription":"courier",{status:n}=await this.updateRemarkSubscription({type:o,text:""});"success"!==n&&("error"!==n?(t.classList.remove("--active","--filled","--error"),s.disabled=!0,s.value="",r.value="",r.disabled=!0,setTimeout((()=>{i.textContent=""}),200),this.setWcagAttributes(a)):t.classList.add("--error"))}onInputRemark(e){const{target:t}=e,r=t.closest(`.${this.prefix}_remarks__item`);if(!r)return;const s=r.querySelector(`.${this.prefix}_remarks__input`);if(!s)return;const i=r.querySelector(`.${this.prefix}_remarks__textarea`);i&&(s.value=i.value)}initEvents(){this.remarksElement.addEventListener("click",(e=>{const{target:t}=e;(t.closest(`.${this.prefix}_remarks__label`)||t.closest(`.${this.prefix}_remarks__link.--edit`))&&(e.preventDefault(),this.onClickShowTextarea(t)),t.closest(`.${this.prefix}_remarks__save`)&&(e.preventDefault(),this.onClickSaveRemark(t)),t.closest(`.${this.prefix}_remarks__link.--remove`)&&(e.preventDefault(),this.onClickRemoveRemark(t))}));this.remarksElement.querySelectorAll(`.${this.prefix}_remarks__textarea`).forEach((e=>{e.addEventListener("input",this.onInputRemark.bind(this))}))}async generate(){const e=document.getElementById(`${this.prefix}_remarks_template`)?.content.cloneNode(!0);if(!e||!e.firstChild)return;const t=this.remarksElement;if(this.vars.status===this.statuses.finished)return t?.remove(),void document.querySelector(this.vars.move.moveSelector)?.remove();this.remarksElement=e.firstChild,this.initFilled(),this.initEvents(),t&&document.body.contains(t)?t.replaceWith(this.remarksElement):super.move({element:this.remarksElement,...this.vars.move})}async init(e={}){this.vars={afterReady:e.afterReady||(()=>{}),move:e.move||this.vars?.move||{},subscrId:e.subscrId||this.vars?.subscrId||null,status:e.status||this.vars?.status||this.statuses.active,courierNote:e.courierNote||"",subscriptionNote:e.subscriptionNote||""},this.callbacks={afterChangeRemark:e.afterChangeRemarkCallback||this.callbacks?.afterChangeRemark},await this.generate(),this.vars.afterReady(this.remarksElement)}}app_shop.fn.subscrRemarks=new SubscrRemarks;