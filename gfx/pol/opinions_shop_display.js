const OpinionsShop=function(e){const t=this;return this.params=e,this.vars={opinions:document.getElementById("opinions_shop"),opinionSorters:document.querySelectorAll(".opinions_shop__sort"),opinionContent:document.querySelector(".opinions_shop__block.--opinions"),opinionWrapper:document.querySelector(".opinions_shop__wrapper"),opinionSkeleton:document.querySelector(".opinions_shop__opinion.--skeleton").outerHTML,moreSkeleton:document.querySelector(".opinions_shop__more_wrapper.--skeleton").outerHTML,blockAjaxFetch:!1},this.txt={opinion_unconfirmed:"Opinia niepotwierdzona zakupem",opinion_confirmed:"Opinia potwierdzona zakupem"},this.fetchData=async e=>{if(this.vars.blockAjaxFetch)return!1;if(this.vars.blockAjaxFetch=!0,this.vars.opinions.classList.add("load-content"),""!==e.join("")&&sessionStorage.getItem(e.join("")))return JSON.parse(sessionStorage.getItem(e.join("")));if(""===e.join("")&&sessionStorage.getItem("allOpinionsShop"))return JSON.parse(sessionStorage.getItem("allOpinionsShop"));try{const t=await fetch(`/ajax/opinions.php?action=get&type=order${e.join("")}`),o=await t.json();return""!==e.join("")?sessionStorage.setItem(e.join(""),JSON.stringify(o)):sessionStorage.setItem("allOpinionsShop",JSON.stringify(o)),o}catch(e){return!1}},this.buildHtmlOpinion=e=>{const o=document.querySelectorAll(".opinions_shop__opinion.--skeleton")[0];o.setAttribute("data-rate",e.rating),o.setAttribute("data-usefull",e.scorePositive),o.setAttribute("data-lang",e.language),o.setAttribute("data-opinion_id",e.id),e.rating>.5&&o.querySelectorAll(".opinions_shop__opinion_note i")[0].classList.add("--active"),e.rating>1.5&&o.querySelectorAll(".opinions_shop__opinion_note i")[1].classList.add("--active"),e.rating>2.5&&o.querySelectorAll(".opinions_shop__opinion_note i")[2].classList.add("--active"),e.rating>3.5&&o.querySelectorAll(".opinions_shop__opinion_note i")[3].classList.add("--active"),e.rating>4.5&&o.querySelectorAll(".opinions_shop__opinion_note i")[4].classList.add("--active"),o.querySelector(".opinions_shop__opinion_score").innerHTML=`${e.rating}/5`,o.querySelector(".opinions_element_confirmed").classList.add(e.confirmedByPurchase?"--true":"--false"),o.querySelector(".opinions_element_confirmed_text").innerHTML=e.confirmedByPurchase?t.txt.opinion_confirmed:t.txt.opinion_unconfirmed,o.querySelector(".opinions_shop__date").innerHTML=e.createDate.match(/\d{4}-\d{2}-\d{2}/g),o.querySelector(".opinions_shop__text").innerHTML=e.content,o.querySelector(".opinions_shop__author").innerHTML=e.author,o.querySelector(".opinions_shop__thumbs.--up .opinions_shop__rate_count").innerHTML=e.scorePositive,o.querySelector(".opinions_shop__thumbs.--down .opinions_shop__rate_count").innerHTML=e.scoreNegative,""!==e.answer?(o.querySelector(".opinions_shop__response_date").innerHTML=e.answerDatetime.match(/\d{4}-\d{2}-\d{2}/g),o.querySelector(".opinions_shop__response_bottom").innerHTML=e.answer):o.removeChild(o.querySelector(".opinions_shop__response")),o.classList.remove("--skeleton")},this.buildHtmlNextPage=e=>{if(document.querySelector(".opinions_shop__more_wrapper:not(.--skeleton)")&&this.vars.opinionContent.removeChild(this.vars.opinionContent.querySelector(".opinions_shop__more_wrapper:not(.--skeleton)")),(e.resultsPage+1)*e.resultsLimit<e.resultsNumberAll){this.vars.opinionWrapper.insertAdjacentHTML("afterend",this.vars.moreSkeleton);const t=document.querySelectorAll(".opinions_shop__more_wrapper.--skeleton")[0];t.querySelector(".opinions_shop__more").setAttribute("data-page",e.resultsPage),t.querySelector(".opinions_shop__more").setAttribute("data-limited",e.resultsLimit),t.querySelector(".opinions_shop__more").setAttribute("data-all",e.resultsNumberAll),t.querySelector("span").innerHTML=e.resultsNumberAll-(e.resultsPage+1)*e.resultsLimit<e.resultsLimit?e.resultsNumberAll-(e.resultsPage+1)*e.resultsLimit:e.resultsLimit,t.classList.remove("--skeleton")}},this.updateOpinions=async e=>{const t=[];this.vars.opinionSorters.forEach((e=>{e.classList.contains("--active")&&t.push(`&rating[]=${e.getAttribute("data-rate")}`)})),e&&t.push(`&resultsPage=${parseInt(e.getAttribute("data-page"),10)+1}`),await this.fetchData(t).then((t=>{if(this.vars.opinions.classList.remove("load-content"),this.vars.blockAjaxFetch=!1,t.results&&t.results.length?(this.vars.opinionContent.classList.remove("--empty"),e||(this.vars.opinionWrapper.innerHTML=""),t.results.forEach((e=>{this.vars.opinionWrapper.innerHTML+=this.vars.opinionSkeleton,this.buildHtmlOpinion(e)})),this.buildHtmlNextPage(t),this.initEventsReload()):t.errors&&!t.errors.length&&(this.vars.opinionContent.classList.add("--empty"),this.vars.opinionWrapper.innerHTML="",this.vars.opinionContent.querySelector(".opinions_shop__more_wrapper:not(.--skeleton)")&&this.vars.opinionContent.removeChild(this.vars.opinionContent.querySelector(".opinions_shop__more_wrapper:not(.--skeleton)"))),!e&&app_shop.vars.view>2){const e=document.getElementById("opinions_shop");e&&e.scrollIntoView({behavior:"smooth"})}}))},this.usefull=e=>{const t=e.closest(".opinions_shop__opinion"),o=t.getAttribute("data-opinion_id"),n=e.classList.contains("--up")?"positive":"negative";fetch("/ajax/opinions.php?action=rate",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`id=${o}&operation=${n}`}).then((e=>e.json())).then((e=>{Object.keys(e.errors).length&&Alertek.Start(e.errors.faultString),e.result&&(t.querySelector(".opinions_shop__thumbs.--up .opinions_shop__rate_count").innerHTML=e.result.score_positive,t.querySelector(".opinions_shop__thumbs.--down .opinions_shop__rate_count").innerHTML=e.result.score_negative,sessionStorage.clear())})).catch((e=>{}))},this.initEvents=()=>{this.vars.opinionSorters.forEach((e=>{e.addEventListener("click",(function(e){e.preventDefault(),t.vars.blockAjaxFetch||(this.classList.toggle("--active"),t.updateOpinions())}))}))},this.initEventsReload=()=>{document.querySelectorAll(".opinions_shop__thumbs").forEach((e=>{e.addEventListener("click",(function(e){e.preventDefault(),t.vars.blockAjaxFetch||t.usefull(this)}))}));const e=document.getElementById("more_opinion");e&&e.addEventListener("click",(function(e){e.preventDefault(),t.vars.blockAjaxFetch||t.updateOpinions(this)}))},this.init=()=>{const{header:e}=this.params;this.headerHeight=e||0,this.initEvents(),this.initEventsReload()},this.init()};app_shop.run((function(){new OpinionsShop({})}),"all","#opinions_shop");