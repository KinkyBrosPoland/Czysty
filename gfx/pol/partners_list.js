const partnersListText={notFound:"Nie znaleziono",loadingPoints:"Trwa ładowanie punktów na mapie"},PartnersSite=function(e){this.params=e||{},this.vars={partners:[]},this.fetchChunkLimit=5,this.leafletScreenLoadingThreshold=30,this.fetchGoogleChunkLimit=100,this.googleVars={key:!1,loaded:!1,map:!1,markerClusters:!1,markerInfo:!1,callbackFnName:"app_shop.fn.partnersSite.initGoogleMap"},this.leafletVars={url:"https://nominatim.openstreetmap.org/search?format=json&q=",loaded:!1,map:!1,markerClusters:!1},this.elementInViewport=e=>{if(!e)return!1;const t=e.getBoundingClientRect(),{top:s,left:r,right:a,bottom:n}=t,{innerWidth:i,innerHeight:o}=window,{clientWidth:l,clientHeight:h}=document.documentElement;return s>=0&&r>=0&&a<=(i||l)&&n<=(o||h)},this.getMarkerListFetchChunks=async({list:e=[],batchSize:t=20,listItemTransform:s=()=>{},afterBatchUpdate:r=e=>{}})=>{const a=[];for(let n=0;n<e.length;n+=t){const i=e.slice(n,n+t).map(s),o=(await Promise.allSettled(i)).map((e=>e?.value)).filter(Boolean);r(o),a.push(...o)}return a},this.scrollToElement=(e={})=>{const{element:t,additionalYOffset:s=(app_shop.vars.view<3?50:0),callback:r}=e;if(!t)return;if(this.elementInViewport(t))return void r?.();const a=t.getBoundingClientRect(),n=document.querySelector(".--fixed-header header"),i=n?n.offsetHeight:0,{top:o}=a,l=o+window.pageYOffset-60-i-(s||0),h=l.toFixed(),p=()=>{window.pageYOffset.toFixed()===h&&(window.removeEventListener("scroll",p),r?.())};window.addEventListener("scroll",p),p(),window.scrollTo({top:l,behavior:"smooth"})},this.buildMarkerInfo=e=>{const{name:t,street:s,zipcode:r,city:a,country:n,phone1:i,phone2:o,email:l,www:h,icon:p}=e||{};return`<div class="partners_marker${p?" --icon":""}">\n        <strong class="partners_marker__item --name">${t}</strong>\n        <span class="partners_marker__item --address">${s}</span>\n        <span class="partners_marker__item --city">${r}&nbsp;${a}</span>\n        <span class="partners_marker__item --country">${n}</span>\n        ${i?`<a class="partners_marker__item --phone --first" href="tel:${i}">${i}</a>`:""}\n        ${o?`<a class="partners_marker__item --phone --second" href="tel:${o}">${o}</a>`:""}\n        ${l?`<a class="partners_marker__item --email" href="mailto:${l}">${l}</a>`:""}\n        ${h?`<a class="partners_marker__item --www" href="${h}">${h}</a>`:""}\n        ${p?`<div class="partners_marker__item --icon">\n          <img src="${p}" alt="${t}" />\n        </div>`:""}\n      </div>`},this.getLeafletPlace=e=>{if(!e)return!1;return e.find((e=>e.lat&&e.lon))},this.getLeafletLocation=e=>!!e&&{lat:e.lat,lng:e.lon},this.findAddress=async e=>{if(this.googleVars.key){const t=await this.googleVars.geocoder.geocode({address:e}),{results:[{geometry:{location:s}={},formatted_address:r}={}]=[]}=t||{};return!!s&&{lat:s?.lat(),lng:s?.lng(),name:r}}const t=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e)}`),s=await t.json(),r=this.getLeafletPlace(s);return this.getLeafletLocation(r)},this.findGoogleMarker=e=>this.googleVars.markerClusters.markers.find((t=>t.position.lat===+e.lat&&t.position.lng===+e.lng)),this.findLeafletMarker=e=>this.leafletVars.markerClusters.getLayers().find((t=>t._latlng.lat===+e.lat&&t._latlng.lng===+e.lng)),this.findMarker=e=>this.googleVars.key?this.findGoogleMarker(e):this.findLeafletMarker(e),this.centerGoogleMarker=(e,t)=>{this.googleVars.map.setOptions({center:e.position,zoom:15}),this.googleVars.markerInfo.setContent(this.buildMarkerInfo(t)),this.googleVars.markerInfo.open(this.googleVars.map,e)},this.centerLeafletMarker=e=>{e&&(this.leafletVars.map.setView(e.getLatLng(),15),e.openPopup())},this.centerMarker=(e,t)=>{this.googleVars.key?this.centerGoogleMarker(e,t):this.centerLeafletMarker(e)},this.getAddress=e=>{const{street:t,zipcode:s,city:r,country:a}=e||{};return`${t},${this.googleVars.key?` ${s}`:""} ${r}, ${a}`},this.centerGoogleMap=e=>{if(!e.length)return;const t=new google.maps.LatLngBounds;e.forEach((e=>t.extend(e.position))),this.googleVars.map.fitBounds(t)},this.updateGoogleMarkers=async()=>{const e=await this.getMarkerListFetchChunks({list:this.vars.partners,batchSize:this.fetchGoogleChunkLimit,listItemTransform:async e=>{let{lat:t,lng:s}=e;const r=this.getAddress(e);if(!t||!s){const a=await this.findAddress(r);if(!a)return!1;t=a.lat,s=a.lng,e.lat=t,e.lng=s}const a=new google.maps.marker.AdvancedMarkerElement({position:{lat:+t,lng:+s}});return a.addListener("click",(()=>{this.googleVars.markerInfo.setContent(this.buildMarkerInfo(e)),this.googleVars.markerInfo.open(this.googleVars.map,a)})),a}});this.googleVars.markerClusters.addMarkers(e),this.centerGoogleMap(e),this.removeLoading()},this.initGoogleMap=()=>{this.googleVars.geocoder=new google.maps.Geocoder,this.googleVars.map=new google.maps.Map(document.getElementById("partners_map"),{center:{lat:52.237049,lng:21.017532},zoom:10,fullscreenControl:!1,mapTypeControl:!1,streetViewControl:!1,mapId:"DEMO_MAP_ID"}),this.googleVars.markerClusters=new markerClusterer.MarkerClusterer({map:this.googleVars.map}),this.googleVars.markerInfo=new google.maps.InfoWindow({disableAutoPan:!0,content:""}),this.googleVars.loaded=!0,this.updateGoogleMarkers()},this.centerLeafletMap=e=>{if(!e.length)return;const t=L.latLngBounds();e.forEach((e=>t.extend(e.getLatLng()))),this.leafletVars.map.fitBounds(t)},this.shouldUpdateLeafletDynamically=()=>this.vars.partners.length>=this.leafletScreenLoadingThreshold,this.updateLeafletMarkers=async()=>{const e=this.shouldUpdateLeafletDynamically();let t=0,s=!1;const r=await this.getMarkerListFetchChunks({list:this.vars.partners,batchSize:this.fetchChunkLimit,listItemTransform:async e=>{let{lat:t,lng:s}=e;const r=this.getAddress(e);if(!t||!s){const a=await this.findAddress(r);if(!a)return!1;t=a.lat,s=a.lng,e.lat=t,e.lng=s}const a=new L.Marker([+t,+s]);return a.bindPopup(this.buildMarkerInfo(e)),this.leafletVars.markerClusters.addLayer(a),a},afterBatchUpdate:r=>{e&&(0===t&&(this.removeLoading(),this.showLoadingToast()),this.leafletVars.map.addLayer(this.leafletVars.markerClusters),t+=r.length,s||(s=!0,this.centerLeafletMap(this.leafletVars.markerClusters),this.leafletVars.map.setZoom(4)))}});this.hideLoadingToast(),e||(this.leafletVars.map.addLayer(this.leafletVars.markerClusters),this.centerLeafletMap(r),this.removeLoading())},this.initLeafletMap=()=>{this.leafletVars.map=L.map("partners_map",{center:{lat:52,lng:19.5},zoom:13,zoomControl:!1}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:3,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(this.leafletVars.map),this.leafletVars.loaded=!0,this.leafletVars.markerClusters=new L.MarkerClusterGroup({maxClusterRadius:50}),this.updateLeafletMarkers()},this.initMap=()=>{if(this.googleVars.key){const e=document.createElement("script");return e.src=`https://maps.googleapis.com/maps/api/js?key=${this.googleVars.key}&loading=async&libraries=places,marker&callback=${this.googleVars.callbackFnName}`,e.async=!0,void document.body.appendChild(e)}this.initLeafletMap()},this.getPartners=()=>{this.vars.partners=[...document.querySelectorAll(".partners_list__partner")].map((e=>{const t={};return Object.entries(e.dataset).forEach((([e,s])=>{t[e]=s})),t}))},this.showLoadingToast=()=>{const e=document.querySelector("#partners_map");if(!e)return;const t=document.createElement("div");t.id="partners_list__loading_toast",t.classList.add("partners_list__loading_toast"),t.innerHTML=`${partnersListText.loadingPoints} <span class="loader"></span>`,e.appendChild(t)},this.hideLoadingToast=()=>{document.querySelectorAll("#partners_map #partners_list__loading_toast").forEach((e=>e.remove()))},this.showPartner=e=>{const t=this.vars.partners.find((t=>t.id===e));if(!t)return void Alertek.Start(`${partnersListText.notFound}`);const s=this.findMarker(t);if(!s)return void Alertek.Start(`${partnersListText.notFound} ${this.getAddress(t)}`);this.centerMarker(s,t);const r=document.getElementById("partners_map");r&&this.scrollToElement({element:r})},this.showDescription=e=>{const t=e.closest(".partners_list__item.--desc");if(!t)return;const s=t.querySelector(".partners_list__partner_desc");s&&new Modal({element:s})},this.showOnMap=e=>{const t=e.closest(".partners_list__partner");if(!t)return;const s=t.dataset.id;this.showPartner(s)},this.initEvents=()=>{const e=document.querySelector(".partners_list");e&&e.addEventListener("click",(e=>{const{target:t}=e;if(t.closest(".partners_list__item.--map"))return e.preventDefault(),void this.showOnMap(t);t.closest(".partners_list__show_desc")&&this.showDescription(t)}))},this.addLoading=()=>{const e=document.getElementById("partners_map");e?.classList.add("--loading")},this.removeLoading=()=>{const e=document.getElementById("partners_map");e?.classList.remove("--loading")},this.init=e=>{this.addLoading(),this.vars.initOptions=e||{},this.getPartners(),this.vars.partners.length?(this.initMap(),this.initEvents()):this.removeLoading()}};app_shop.fn.partnersSite=new PartnersSite,app_shop.run((function(){app_shop.fn.partnersSite.googleVars.key=window.google_api_key,app_shop.fn.partnersSite.init()}),"all","#partners_map");