class SubscrCode extends Subscr{constructor(e={}){super(e)}rebateSuccess(e){const t=this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__input`);if(!t)return;e&&(t.value=e);const s=this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__text`);s&&(this.rebateCodeElement.classList.remove("--active"),this.rebateCodeElement.classList.add("--filled"),this.rebateCodeElement.setAttribute("data-rebate-code",t.value),super.toggleTabindexes({wrapper:this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__message`),add:!1}),s.textContent=t.value,this.removeErrorFromInput(t),document.activeElement.blur(),e||this.callbacks.afterAdd?.())}removeRebateSuccess(){const e=this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__input`);if(!e)return;const t=this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__text`);t&&(this.rebateCodeElement.classList.remove("--active","--filled"),e.disabled=!0,e.value="",super.toggleTabindexes({wrapper:this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__message`),add:!0}),super.toggleTabindexes({wrapper:this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__field`),add:!0}),this.rebateCodeElement.removeAttribute("data-rebate-code"),setTimeout((()=>{t.textContent=""}),200),this.callbacks.afterRemove?.())}addErrorToInput(e,t){const s=e.closest(".f-feedback")||e.parentNode;s.classList.remove("--success");const r=s.querySelector(".f-message");s.classList.add("--error"),r.textContent=t||`${this.txt["Proszę wypełnić to pole"]}.`}removeErrorFromInput(e){const t=e.closest(".f-feedback")||e.parentNode;t.classList.remove("--error");t.querySelector(".f-message").textContent=""}initFilled(){if(!this.vars.rebateCodeData)return;const{code:e,orderUsages:t,maxUsages:s}=this.vars.rebateCodeData,r=this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__info`);r&&(r.textContent=this.txt["Wykorzystano dla %s z %s zamówień"].format(t,s)),this.rebateSuccess(e)}focusOut(){this.rebateCodeElement.classList.remove("--active"),super.toggleTabindexes({wrapper:this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__field`),add:!0}),super.toggleTabindexes({wrapper:this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__message`),add:!this.rebateCodeElement.getAttribute("data-rebate-code")}),this.rebateCodeElement.getAttribute("data-rebate-code")&&this.rebateCodeElement.classList.add("--filled")}onClickShowInput(){const e=this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__input`);if(!e)return;this.removeErrorFromInput(e),this.rebateCodeElement.classList.remove("--filled"),this.rebateCodeElement.classList.add("--active"),super.toggleTabindexes({wrapper:this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__message`),add:!0}),super.toggleTabindexes({wrapper:this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__field`),add:!1}),e.disabled=!1;const t=e.value.length;e.setSelectionRange(t,t),setTimeout((()=>{e.focus()}),200)}async onClickSaveCode(){const e=this.rebateCodeElement.querySelector(`.${this.prefix}_rebate_code__input`);if(!e)return;const{value:t}=e;if(""===t)return void this.addErrorToInput(e);if(e.closest(".f-feedback.--error"))return;this.removeErrorFromInput(e),this.rebateCodeElement.classList.add("--loading");const s=await this.fetchData({data:this.queries.ACTIVATE_REBATE_CODE(this.vars.subscrId,t),linkParameter:"?mutation=subscriptionActivateRebateCode"}),{status:r}=s?.data?.activateSubscriptionRebateCode||{};if("success"===r)return void this.rebateSuccess();this.rebateCodeElement.classList.remove("--loading");const{message:a}=s?.data?.activateSubscriptionRebateCode?.error||{};this.addErrorToInput(e,a)}async onClickRemoveCode(e){this.rebateCodeElement.classList.add("--loading");const t=await this.fetchData({data:this.queries.DEACTIVATE_REBATE_CODE(this.vars.subscrId),linkParameter:"?mutation=subscriptionDeactivateRebateCode"});this.rebateCodeElement.classList.remove("--loading");const{status:s}=t?.data?.deactivateSubscriptionRebateCode||{};"success"===s&&this.removeRebateSuccess()}onKeydown(e){13===(e.which||e.keyCode||0)&&e.preventDefault()}onKeyup(e){const t=e.which||e.keyCode||0,{target:s}=e,{value:r}=s;""!==r?(this.removeErrorFromInput(s),13===t&&this.onClickSaveCode(s)):this.addErrorToInput(s)}initEvents(){this.rebateCodeElement.addEventListener("click",(e=>{const{target:t}=e;(t.closest(`.${this.prefix}_rebate_code__add`)||t.closest(`.${this.prefix}_rebate_code__link.--edit`))&&(e.preventDefault(),this.onClickShowInput()),t.closest(`.${this.prefix}_rebate_code__save`)&&(e.preventDefault(),this.onClickSaveCode()),t.closest(`.${this.prefix}_rebate_code__link.--remove`)&&(e.preventDefault(),this.onClickRemoveCode(t))}));const e=this.rebateCodeElement.querySelector("#rebate_code_input");e&&(e.addEventListener("keydown",this.onKeydown.bind(this)),e.addEventListener("keyup",this.onKeyup.bind(this))),document.addEventListener("click",(e=>{const{target:t}=e;t.closest(`.${this.prefix}_rebate_code`)||this.rebateCodeElement&&this.focusOut()})),document.addEventListener("focusin",(e=>{const{target:t}=e;t.closest(`.${this.prefix}_rebate_code`)||this.rebateCodeElement&&this.focusOut()}))}async generate(){const e=document.getElementById(`${this.prefix}_rebate_code_template`)?.content.cloneNode(!0);if(!e||!e.firstChild)return;const t=this.rebateCodeElement;if(this.vars.status===this.statuses.finished)return t?.remove(),void document.querySelector(this.vars.move.moveSelector)?.remove();this.rebateCodeElement=e.firstChild,this.initFilled(),this.initEvents(),t&&document.body.contains(t)?t.replaceWith(this.rebateCodeElement):super.move({element:this.rebateCodeElement,...this.vars.move})}async init(e={}){this.vars={afterReady:e.afterReady||(()=>{}),move:e.move||this.vars?.move||{},status:e.status||this.vars?.status||this.statuses.active,rebateCodeData:e.rebateCodeData||null,subscrId:e.subscrId||this.vars?.subscrId||null},this.callbacks={afterAdd:e.afterAddCallback||this.callbacks?.afterAdd,afterRemove:e.afterRemoveCallback||this.callbacks?.afterRemove},await this.generate(),this.vars.afterReady(this.codeElement)}}app_shop.fn.subscrCode=new SubscrCode;