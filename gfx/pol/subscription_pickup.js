class SubscrPickupPoints extends Subscr{constructor(e={}){super(e),this.firstInit=!0,this.typing={timeout:null,delay:500},this.location={lng:"",lat:""}}addLoadingInfo(e){const t=document.querySelector(".modal .modal__content")||this.pickupPointsElement.parentNode;if(!t)return;const i=document.createElement("div");i.classList.add(`${this.prefix}_pickup_loading_info`),i.innerHTML=e,t.appendChild(i)}removeLoadingInfo(){const e=document.querySelector(`.${this.prefix}_pickup_loading_info`);e&&e.remove()}addLoading(){const e=document.querySelector(".modal");e?e.classList.add("--loading"):this.pickupPointsElement?.classList.add("--loading")}removeLoading(){const e=document.querySelector(".modal");e?e.classList.remove("--loading"):this.pickupPointsElement?.classList.remove("--loading")}async getSearchResult(e){const t=e||this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search__input`)?.value;if(!t)return[];const i=`SearchPickupPointsInput: {\n      shippingId: ${this.vars.couriers[0].id},\n      query: "${t.replace(/"/g,'\\"')}",\n      cashOnDelivery: ${this.vars.cashOnDelivery},\n    }`,s=await super.fetchData({data:this.queries.SEARCH_PICKUP_POINTS(i),linkParameter:"?query=subscriptionSearchPickupPoints",alert:!1}),{searchPickupPoints:r=[]}=s?.data||{};return r?.length?r:[]}async findAddressMap(e){const t=e||this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search__input`)?.value;if(!t)return!1;if(this.checkGoogleMap())try{return await this.googleVars.geocoder.geocode({address:t})}catch(e){return!1}try{const e=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${t}`);return await e.json()}catch{return!1}}async findAddress(e){const t=e||this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search__input`)?.value;if(!t)return;if(this.currentAddress===t)return;this.addLoading();const{latitude:i,longitude:s,name:r}=await this.fillLatLngFromAddress(t)||{};i&&s?(this.location={lat:i,lng:s},this.currentAddress=r,this.updatePickups()):this.notFoundPickups()}async buildSearchResult(){const e=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search`);if(!e)return;const t=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search__input`);if(!t)return;const i=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search__results`);if(!i)return;if(!t.value)return e.classList.remove("--open"),void(i.innerHTML="");if(t.value===t.getAttribute("data-value"))return;e.classList.add("--loading-results");const s=await this.getSearchResult(t.value);e.classList.remove("--loading-results"),i.innerHTML="",s.length?(e.classList.add("--open"),i.innerHTML=s.map((e=>`<a class="${this.prefix}_pickup_search__result" tabindex="1" href="#selectThisLocation" ${e.gps.latitude?`data-latitude="${e.gps.latitude}"`:""} ${e.gps.longitude?`data-longitude="${e.gps.longitude}"`:""}>${e.data}</a>`)).join("")):e.classList.remove("--open")}closeSearchResults(){const e=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search`);e?.classList.remove("--focus","--open")}updateSearchInputValue(){const e=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search__input`);if(!e)return;if(this.currentAddress)return void(e.value=this.currentAddress);const t=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_item.--active`);if(!t)return;const{uid:i}=t.dataset,s=this.pickups.find((e=>e.uid===i));if(!s)return;const{address:{street:r,city:o,postcode:a,buildingAndHouseNumber:n}={}}=s||{},c=n?`${r} ${n}, ${a} ${o}`:`${r}, ${a} ${o}`;e.value=c,this.currentAddress=c}setPickupItemDistance(e,t){const i=e.querySelector(`.${this.prefix}_pickup_item__distance`);if(!i)return;const{formatted:s,value:r}=t;r?i.innerText=s:i.remove()}setPicukpItemName(e,t){const i=e.querySelector(`.${this.prefix}_pickup_item__name`);i&&(i.innerText=t)}setPickupItemAddress(e,t){const{street:i,city:s,postcode:r,buildingAndHouseNumber:o}=t,a=e.querySelector(`.${this.prefix}_pickup_item__street`);a&&(a.innerText=o?`${i} ${o}`:i);const n=e.querySelector(`.${this.prefix}_pickup_item__city`);n&&(n.innerText=s);const c=e.querySelector(`.${this.prefix}_pickup_item__zipcode`);c&&(c.innerText=r)}setRequiredClientNumber(e,t){const i=e.querySelector(`.${this.prefix}_pickup_item__client_courier_number`);i&&(t||i.remove())}setPickupItemPrice(e,t){const i=e.querySelector(`.${this.prefix}_pickup_item__price`);if(!i)return;const{formatted:s}=t||{};s?i.innerText=s:i.remove()}setPickupItemDescription(e,t){const i=e.querySelector(`.${this.prefix}_pickup_item__description`);i&&(t?i.innerText=t:i.remove())}getPickupItem(e){const t=document.getElementById(`${this.prefix}_pickup_points_item_template`)?.content.cloneNode(!0);if(!t)return!1;const{address:i,name:s,id:r,courierId:o,fullId:a,uid:n,distance:c,price:l,requiredClientNumber:u,coordinates:{latitude:p,longitude:h}={},location:d}=e;this.setPickupItemDistance(t,c),this.setPicukpItemName(t,s),this.setPickupItemAddress(t,i),this.setPickupItemPrice(t,l),this.setPickupItemDescription(t,d),this.setRequiredClientNumber(t,u),p&&h&&(t.firstChild.setAttribute("data-latitude",p),t.firstChild.setAttribute("data-longitude",h)),t.firstChild.setAttribute("data-id",r),t.firstChild.setAttribute("data-courier-id",o.replace(/courier_/,"")),t.firstChild.setAttribute("data-courier-full-id",a),t.firstChild.setAttribute("data-uid",n),this.inpostId=["100209","100149","100148","100161","100197","100150","100162","100198","100189","100190","100199","100153","100160"];const m=o.replace(/courier_/,"");return this.inpostId.includes(m)&&t.firstChild.classList.add("--inpost"),t.firstChild}clearPickups(){const e=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_items`);if(!e)return;e.classList.remove("--message","--more","--show");const t=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_items__wrapper`);t&&(t.innerHTML="")}notFoundPickups(){this.removeLoading(),this.clearPickups(),this.clearMarkers(),this.centerMap(),this.pickupPointsElement.classList.contains("--map")&&Alertek.Info(this.txt["Brak punktów odbioru, sprawdź inny adres"]),document.querySelector(`.${this.prefix}_pickup_search__input`)?.focus();const e=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_items`);e&&e.classList.add("--message")}checkVisibleLastPickupItem(){const e=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_items`);e&&(e.classList.remove("--more"),e.classList.add("--show"))}updatePickupItems(){if(!this.pickups.length)return void this.notFoundPickups();this.clearPickups();const e=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_items`);if(!e)return;const t=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_items__wrapper`);if(!t)return;t.scrollTop=0,this.pickups.forEach(((e,i)=>{const s=this.getPickupItem(e);s&&(t.appendChild(s),0===i&&this.onClickActivatePickup(s))}));this.pickups.find((e=>e.distance.value))||e.classList.add("--not-distance"),this.checkVisibleLastPickupItem()}async fillLatLngFromAddress(e){const t=await this.findAddressMap(e);if(this.checkGoogleMap()){const{results:[{geometry:{location:e}={},formatted_address:i}={}]=[]}=t||{};return!!e&&{latitude:e?.lat(),longitude:e?.lng(),name:i}}const[{lat:i,lon:s,display_name:r}={}]=t||[];return!(!i||!s)&&{latitude:i,longitude:s,name:r}}sortPickups(e){const t=[],i=[];return e.forEach((e=>{if(!e.price?.value)return void i.push(e);const s=parseInt(e.price.value.toFixed(2).toString().replace(".",""),10);t[s]||(t[s]=[]),t[s].push(e)})),t.forEach(((e,s)=>{e.sort(((e,t)=>e.distance.value-t.distance.value)),t[s]=e.filter((e=>!(e.distance.value>.5&&0!==e.distance.value)||(i.push(e),!1)))})),t[t.length]=i,t.flat(1)}async getFormattedPickups(e){const t=[];Object.entries(e).forEach((([e,i])=>{const s=this.vars.couriers.find((t=>`courier_${t.id}`===e))||{},r=i.pickupPoints.map((t=>({...t,courierId:e,uid:`${e}-${t.id}`,distance:{formatted:t.coordinates.distance?`${(1e3*parseFloat(t.coordinates.distance)).toFixed(0)} m`:0,value:+t.coordinates.distance??1/0},price:s.price,fullId:s.fullId,elementCallback:this.vars.elementCallback})));t.push(...r)}));const i=this.sortPickups(t),s=i.map((async e=>{if(e.coordinates.latitude&&e.coordinates.longitude)return;const{address:{street:t,city:i,postcode:s}={}}=e||{},r=this.checkGoogleMap()?`${t}+${s}+${i}`:`${t}+${i}`,{latitude:o,longitude:a}=await this.fillLatLngFromAddress(r)||{};o&&a&&(e.coordinates.latitude=o,e.coordinates.longitude=a)}));return await Promise.all(s),i}async updatePickups(){if(!this.location.lat||!this.location.lng)return;const e=e=>`courierId: ${e}, location: {latitude: ${this.location.lat}, longitude: ${this.location.lng}}, prepaid: ${this.vars.cashOnDelivery?"dvp":"prepaid"}, radius: ${this.location.radius||2}`;this.vars.couriers.sort(((e,t)=>e.price-t.price));const t=this.vars.couriers.map((t=>({name:`courier_${t.id}`,input:e(t.id)}))),i=this.queries.PICKUP_ALL_POINTS(t.reduce(((e,t)=>e+=this.queries.PICKUP_POINTS(t)),"")),s=await super.fetchData({data:i,linkParameter:"?query=subscriptionPickupPoints",alert:!1}),{data:r}=s||{};if(!r)return void this.notFoundPickups();Object.values(r).some((e=>e.pickupPoints))?(this.pickups=await this.getFormattedPickups(r),this.updatePickupItems(),this.updateMarkers(),this.updateSearchInputValue(),this.removeLoading(),document.querySelector(this.vars.firstFocusElement)?.focus(),setTimeout((()=>{document.querySelector(this.vars.firstFocusElement)?.focus()}),200)):this.notFoundPickups()}clearMarkers(){this.checkGoogleMap()?this.googleVars.markerClusters.clearMarkers():this.leafletVars.markerClusters.clearLayers()}updateMarkers(){this.clearMarkers(),this.checkGoogleMap()?this.updateGoogleMarkers():this.updateLeafletMarkers()}findMarker(e){return this.checkGoogleMap()?this.googleVars.markerClusters.markers.find((t=>t.uid===e)):this.leafletVars.markerClusters.getLayers().find((t=>t.uid===e))}centerMarker(e){this.checkGoogleMap()?this.centerGoogleMarker(e):this.centerLeafletMarker(e)}setMarkerDistance(e,t){const i=e.querySelector(`.${this.prefix}_pickup_marker__distance`);if(!i)return;const{formatted:s,value:r}=t;r?i.innerText=s:i.remove()}setMarkerName(e,t){const i=e.querySelector(`.${this.prefix}_pickup_marker__name`);i&&(i.innerText=t)}setMarkerAddress(e,t){const{street:i,city:s,postcode:r,buildingAndHouseNumber:o}=t,a=e.querySelector(`.${this.prefix}_pickup_marker__street`);a&&(a.innerText=o?`${i} ${o}`:i);const n=e.querySelector(`.${this.prefix}_pickup_marker__city`);n&&(n.innerText=s);const c=e.querySelector(`.${this.prefix}_pickup_marker__zipcode`);c&&(c.innerText=r)}setMarkerDescription(e,t){const i=e.querySelector(`.${this.prefix}_pickup_marker__description`);i&&(t?i.innerText=t:i.remove())}buildMarkerInfo(e){const t=document.getElementById(`${this.prefix}_pickup_points_marker_template`)?.content.cloneNode(!0);if(!t)return!1;const{address:i,name:s,id:r,courierId:o,fullId:a,uid:n,distance:c,coordinates:{latitude:l,longitude:u}={},location:p,link:h}=e;return this.setMarkerDistance(t,c),this.setMarkerName(t,s),this.setMarkerAddress(t,i),this.setMarkerDescription(t,p),l&&u&&(t.firstChild.setAttribute("data-latitude",l),t.firstChild.setAttribute("data-longitude",u)),t.firstChild.setAttribute("data-id",r),t.firstChild.setAttribute("data-courier-id",o.replace(/courier_/,"")),t.firstChild.setAttribute("data-courier-full-id",a),t.firstChild.setAttribute("data-uid",n),t.firstChild}updateGoogleMarkers(){const e=this.pickups.map(((e,t)=>{const{latitude:i,longitude:s}=e.coordinates;if(!i||!s)return!1;this.pickups.filter((e=>e.coordinates.latitude===i&&e.coordinates.longitude===s)).length>1&&(this.pickups[t].coordinates.latitude+=1e-5,e.coordinates.latitude+=1e-5);const r={position:{lat:e.coordinates.latitude,lng:s},title:this.txt["Zobacz punkt odbioru"]};if(e.markerIconUrl){const t=document.createElement("img");t.src=e.markerIconUrl,t.alt=this.txt["Zobacz punkt odbioru"],r.content=t}const o=new google.maps.marker.AdvancedMarkerElement(r);return o.uid=e.uid,o.pickupData=e,o.addListener("click",(()=>{this.googleVars.markerInfo.setContent(this.buildMarkerInfo(e)),this.googleVars.markerInfo.open(this.googleVars.map,o);const t=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_item[data-uid="${e.uid}"]`);t&&this.onClickActivatePickup(t)})),o}));e.filter((e=>e)).length&&(this.googleVars.markerClusters.addMarkers(e),this.centerGoogleMarker(e[0]))}centerGoogleMarker(e){e&&(this.googleVars.map.setOptions({center:e.position,zoom:16}),this.googleVars.markerInfo.setContent(this.buildMarkerInfo(e.pickupData)),this.googleVars.markerInfo.open(this.googleVars.map,e),document.querySelector(this.vars.firstFocusElement)?.focus(),setTimeout((()=>{document.querySelector(this.vars.firstFocusElement)?.focus()}),100),this.vars.mobileView?setTimeout((()=>{this.googleVars.map.panBy(0,-window.screen.height/5)}),50):setTimeout((()=>{this.googleVars.map.panBy(0,-window.screen.height/10)}),50))}initGoogleMap(){this.googleVars={};const e=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_map__wrapper`);e&&(this.googleVars.geocoder=new google.maps.Geocoder,this.googleVars.map=new google.maps.Map(e,{center:{lat:52.237049,lng:21.017532},zoom:10,fullscreenControl:!1,mapTypeControl:!1,streetViewControl:!1,mapId:"DEMO_MAP_ID"}),this.googleVars.markerClusters=new markerClusterer.MarkerClusterer({map:this.googleVars.map}),this.googleVars.markerInfo=new google.maps.InfoWindow({disableAutoPan:!0,content:"",ariaLabel:this.txt["Wybierz punkt odbioru"]}),this.googleVars.markerInfo.addListener("closeclick",(function(){document.querySelector(this.vars.firstFocusElement)?.focus()})),this.googleVars.loaded=!0,this.setInitPosition())}updateLeafletMarkers(){this.pickups.forEach((e=>{const{latitude:t,longitude:i}=e.coordinates;if(!t||!i)return;const s=e.markerIconUrl?{icon:L.icon({iconUrl:e.markerIconUrl,iconAnchor:[16,20],popupAnchor:[0,-20]})}:"",r=new L.Marker({lat:t,lng:i},s);r.uid=e.uid,r.bindPopup(this.buildMarkerInfo(e)),this.leafletVars.markerClusters.addLayer(r)})),this.leafletVars.map.addLayer(this.leafletVars.markerClusters);const e=this.findMarker(this.pickups[0].uid);this.centerLeafletMarker(e)}centerLeafletMarker(e){e&&(app_shop.vars.view<3&&!this.pickupPointsElement.classList.contains("--map")?this.leafletVars.map.setView(e.getLatLng()):this.leafletVars.markerClusters.zoomToShowLayer(e,(()=>{const t=this.vars.mobileView?this.leafletVars.map._size.y/2-150:this.leafletVars.map._size.y/2-250;let i=this.leafletVars.map.project(e.getLatLng());i=new L.point(i.x+0,i.y-t);const s=this.leafletVars.map.unproject(i);e.openPopup(),setTimeout((()=>{this.leafletVars.map.setView(s)}),100)})))}initLeafletMap(){this.leafletVars?.map&&this.leafletVars.map.remove(),this.leafletVars={};const e=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_map__wrapper`);e&&(this.leafletVars.map=L.map(e,{center:{lat:52.237049,lng:21.017532},zoom:10,zoomControl:!1}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:7,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(this.leafletVars.map),L.control.zoom({position:"bottomright"}).addTo(this.leafletVars.map),this.leafletVars.loaded=!0,this.leafletVars.markerClusters=new L.MarkerClusterGroup({maxClusterRadius:50}),this.leafletVars.markerClusters.on("click",(e=>{const t=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_item[data-uid="${e?.layer?.uid}"]`);t&&this.onClickActivatePickup(t)})),this.setInitPosition(),document.querySelector(this.vars.firstFocusElement)?.focus(),setTimeout((()=>{document.querySelector(this.vars.firstFocusElement)?.focus()}),200))}defaultPosition(){if(this.removeLoadingInfo(),this.checkGoogleMap()){if(!this.googleVars.loaded)return;const e=this.googleVars.map?.center?.lat(),t=this.googleVars.map?.center?.lng();if(!e||!t)return;return this.location={lat:e,lng:t,radius:10},void this.updatePickups()}const e=this.leafletVars.map.getCenter().lat,t=this.leafletVars.map.getCenter().lng;e&&t&&(this.location={lat:e,lng:t,radius:10},this.updatePickups())}async myLocation(e=!1){if(!navigator.geolocation&&!e)return void this.removeLoading();if(!navigator.geolocation)return void this.defaultPosition();const{state:t}=await(navigator.permissions?.query({name:"geolocation"}))||{};if("denied"===t&&!e)return this.removeLoading(),void Alertek.Info(this.txt["Mapa nie ma uprawnień do twojej lokalizacji. Zmień ustawienia prywatności w przeglądarce, by korzystać z usługi lokalizacji"]);"prompt"===t&&this.addLoadingInfo(`${this.txt["Przeglądarka prosi o udostępnienie Twojej lokalizacji. Zezwól lub zablokuj udostępnienie lokalizacji, aby wyświetlić mapę"]}.`),navigator.geolocation.getCurrentPosition((e=>{this.removeLoadingInfo();const t=e.coords.latitude,i=e.coords.longitude;t&&i&&(this.location={lat:t,lng:i,radius:10},this.updatePickups())}),(()=>{if(!e)return this.removeLoadingInfo(),void this.removeLoading();this.defaultPosition()}))}setInitPosition(){if(this.addLoading(),this.vars.lat&&this.vars.lng)return this.location={lat:this.vars.lat,lng:this.vars.lng},void this.updatePickups();if(this.vars.address){return this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search__input`).value=this.vars.address,void this.findAddress()}this.myLocation(!0)}centerMap(){if(this.location.lat&&this.location.lng){if(this.checkGoogleMap())return this.googleVars.map.setCenter({lat:this.location.lat,lng:this.location.lng}),void this.googleVars.map.setZoom(12);this.leafletVars.map.setView({lat:this.location.lat,lng:this.location.lng}),this.leafletVars.map.setZoom(12)}}initMap(){if(!this.checkGoogleMap())return void this.initLeafletMap();const e=document.createElement("script");e.src=`https://maps.googleapis.com/maps/api/js?key=${this.vars.googleApiKey}&loading=async&libraries=places,marker&callback=app_shop.fn.subscrPickupPoints.initGoogleMap`,e.async=!0,document.body.appendChild(e)}initFilters(){this.pickupPointsElement.classList.add("--no-filters")}disableClientCourierNumber(e){this.pickupPointsElement.querySelectorAll(`.${this.prefix}_pickup_item__client_courier_number`).forEach((e=>e.setAttribute("disabled","disabled"))),e.removeAttribute("disabled")}clientCourierNumber(e){const{uid:t}=e,i=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_item[data-uid="${t}"]`);if(!i)return;const s=i.querySelector(`.${this.prefix}_pickup_item__client_courier_number`);if(s){if(s.value)return this.disableClientCourierNumber(s),e.clientCourierNumber=s.value,this.modal&&document.querySelector(".modal")&&this.modal.closeModal(),void this.vars.callback(e);this.modal&&!document.querySelector(".modal")&&(this.modal.init(),this.removeLoading()),this.pickupPointsElement.classList.remove("--map","--filters"),this.pickupPointsElement.classList.add("--search"),this.onClickActivatePickup(i),app_shop.vars.view<3&&i.scrollIntoView({behavior:"smooth"}),s.classList.add("--highlight"),setTimeout((()=>{s.classList.remove("--highlight")}),2e3),s.focus(),document.querySelector(this.vars.firstFocusElement)?.focus()}}checkGoogleMap(){return!!this.vars.googleApiKey&&!this.vars.googleApiFailure}onClickChangeView(e){if(this.pickupPointsElement.classList.remove("--search","--map","--filters"),e.classList.contains("--map"))return this.pickupPointsElement.classList.add("--map"),void(this.leafletVars&&this.leafletVars.map.invalidateSize());e.classList.contains("--filters")?this.pickupPointsElement.classList.add("--filters"):(this.pickupPointsElement.classList.add("--search"),this.checkVisibleLastPickupItem())}onClickSearch(){this.findAddress(),document.activeElement.blur(),this.closeSearchResults()}onClickClear(){const e=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search`);if(!e)return;const t=e.querySelector(`.${this.prefix}_pickup_search__input`);t&&(t.value="",this.closeSearchResults(),e.classList.remove("--filled"),t.focus(),e.classList.add("--focus"))}async onClickSearchResult(e){const t=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search__input`);if(!t)return;if(t.value=e.innerText,this.currentAddress=e.innerText,this.closeSearchResults(),e.getAttribute("data-latitude")&&e.getAttribute("data-longitude"))return this.location={lat:e.getAttribute("data-latitude"),lng:e.getAttribute("data-longitude")},void this.updatePickups();const{latitude:i,longitude:s,name:r}=await this.fillLatLngFromAddress(e.innerText)||{};i&&s?(this.location={lat:i,lng:s,radius:10},this.currentAddress=r,this.updatePickups()):this.notFoundPickups()}onClickFindPointsInArea(){this.currentAddress="",this.addLoading();const e=this.checkGoogleMap()?this.googleVars.map.center.lat():this.leafletVars.map.getCenter().lat,t=this.checkGoogleMap()?this.googleVars.map.center.lng():this.leafletVars.map.getCenter().lng;this.location={lat:e,lng:t,radius:10},this.updatePickups()}onClickFindPointsInMyLocation(){this.currentAddress="",this.addLoading(),this.myLocation()}onClickShowOnMap(e){this.pickupPointsElement.classList.remove("--search","--map","--filters"),this.pickupPointsElement.classList.add("--map"),this.pickupPointsElement.scrollIntoView({behavior:"smooth"}),this.leafletVars&&this.leafletVars.map.invalidateSize();const t=e.closest("[data-uid]");t&&this.onClickActivatePickup(t,!0)}onClickChoosePickup(e){const t=e?.closest("[data-uid]")||this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_item.--active`);if(!t)return void this.vars.callback(null);const{uid:i}=t.dataset,s=this.pickups.find((e=>e.uid===i));if(!s)return;const{requiredClientNumber:r,clientCourierNumber:o}=s;!r||o?this.vars.callback(s):this.clientCourierNumber(s)}onClickActivatePickup(e,t){const i=e.closest("[data-uid]");if(!i)return;const s=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_items`);if(!s)return;this.pickupPointsElement.querySelectorAll(`.${this.prefix}_pickup_item`).forEach((e=>e.classList.remove("--active"))),i.classList.add("--active");const r=i.querySelector(`.${this.prefix}_pickup_item__client_courier_number`);r&&this.disableClientCourierNumber(r);if(super.elementInViewport(i,s)||(s.classList.add("--show"),i.scrollIntoView({behavior:"smooth",block:"nearest"})),!t)return;const{uid:o}=i.dataset,a=this.findMarker(o);a&&this.centerMarker(a)}onInputSearch(e){const t=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search`);if(!t)return;const{target:i}=e;i.setAttribute("data-value",i.value),t.classList.add("--focus"),this.typing.timeout&&clearTimeout(this.typing.timeout);if(13===(e.which||e.keyCode||0))return this.findAddress(),document.activeElement.blur(),void this.closeSearchResults();this.typing.timeout=setTimeout(this.buildSearchResult.bind(this),this.typing.delay)}onKeyUpSearch(e){const t=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search`);if(!t)return;const{target:i}=e;t.classList.toggle("--filled",!!i.value)}onFocusSearch(e){const t=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search`);if(!t)return;const{target:i}=e;t.classList.add("--focus"),t.classList.toggle("--filled",!!i.value)}initEvents(){this.pickupPointsElement.addEventListener("click",(e=>{const{target:t}=e;return t.closest(`.${this.prefix}_pickup_nav__item`)?(e.preventDefault(),void this.onClickChangeView(t.closest(`.${this.prefix}_pickup_nav__item`))):t.closest(`.${this.prefix}_pickup_search__button`)?(e.preventDefault(),void this.onClickSearch()):t.closest(`.${this.prefix}_pickup_search__clear`)?(e.preventDefault(),void this.onClickClear()):t.closest(`.${this.prefix}_pickup_search__result`)?(e.preventDefault(),void this.onClickSearchResult(t.closest(`.${this.prefix}_pickup_search__result`))):t.closest(`.${this.prefix}_pickup_items__show`)?(e.preventDefault(),void this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_items`).classList.add("--show")):t.closest(`.${this.prefix}_pickup_item__map`)?(e.preventDefault(),void this.onClickShowOnMap(t.closest(`.${this.prefix}_pickup_item__map`))):t.closest(`.${this.prefix}_pickup_item__choose`)&&app_shop.vars.view>2?(e.preventDefault(),void this.onClickChoosePickup(t.closest(`.${this.prefix}_pickup_item`))):t.closest(`.${this.prefix}_pickup_item`)&&!t.closest(`.${this.prefix}_pickup_item__client_courier_number`)?(e.preventDefault(),app_shop.vars.view<3?void this.onClickShowOnMap(t.closest(`.${this.prefix}_pickup_item`)):void this.onClickActivatePickup(t.closest(`.${this.prefix}_pickup_item`),!0)):t.closest(`.${this.prefix}_pickup_marker__choose_link`)?(e.preventDefault(),void this.onClickChoosePickup(t.closest(`.${this.prefix}_pickup_marker__choose_link`))):t.closest(`.${this.prefix}_pickup_map__area_button.--area`)?(e.preventDefault(),void this.onClickFindPointsInArea()):void(t.closest(`.${this.prefix}_pickup_map__area_button.--gps`)&&(e.preventDefault(),this.onClickFindPointsInMyLocation()))})),document.addEventListener("click",(e=>{const{target:t}=e;t.closest(`.${this.prefix}_pickup_search`)||this.closeSearchResults()}));const e=this.pickupPointsElement.querySelector(`.${this.prefix}_pickup_search__input`);e&&(e.addEventListener("keydown",this.onInputSearch.bind(this)),e.addEventListener("keyup",this.onKeyUpSearch.bind(this)),e.addEventListener("focus",this.onFocusSearch.bind(this)))}generate(){const e=document.getElementById(`${this.prefix}_pickup_points_template`)?.content.cloneNode(!0);if(!e||!e.firstChild)return;const t=this.pickupPointsElement;if(this.pickupPointsElement=t||e.firstChild,this.firstInit&&(this.initMap(),this.initEvents()),this.initFilters(),!this.vars.move.moveSelector&&!this.vars.move.moveElement)return this.clearPickups(),void(this.modal=new Modal({element:this.pickupPointsElement,allowedElementsForTabIndex:!1,classList:"--subscr --pickup --large --mobile"+(this.pickupPointsElement.classList.contains("--loading")?" --loading":""),afterShow:e=>{e&&(e.setAttribute("aria-label",this.txt["Wybierz punkt odbioru"]),e.querySelector(".modal__close").setAttribute("tabindex","0"))},afterClose:this.onClickChoosePickup.bind(this)}));t&&document.body.contains(t)?t.replaceWith(this.pickupPointsElement):super.move({element:this.pickupPointsElement,...this.vars.move})}init(e={}){this.vars={afterReady:e.afterReady||(()=>{}),move:e.move||this.vars?.move||{},googleApiKey:e.googleApiKey||this.vars?.googleApiKey||!1,address:e.address||"",lat:e.lat||"",lng:e.lng||"",couriers:e.couriers||this.vars?.couriers||[],cashOnDelivery:e.cashOnDelivery||this.vars?.cashOnDelivery||!1,mobileView:window.screen.width<768,callback:e.callback||(()=>{}),elementCallback:e.elementCallback||!1,googleApiFailure:e.googleApiFailure??this.vars?.googleApiFailure??!1,firstFocusElement:`.${this.prefix}_pickup_item__choose_link`},this.vars.couriers.length&&(this.currentAddress="",this.generate(),this.firstInit||this.setInitPosition(),this.vars.afterReady(this.pickupPointsElement),this.firstInit&&this.leafletVars&&this.leafletVars.map.invalidateSize(),this.firstInit=!1)}}try{app_shop.fn.subscrPickupPoints=new SubscrPickupPoints,window.gm_authFailure=()=>{app_shop.fn.subscrPickupPoints&&(app_shop.fn.subscrPickupPoints.vars.googleApiKey=!1,app_shop.fn.subscrPickupPoints.vars.googleApiFailure=!0,app_shop.fn.subscrPickupPoints.initMap())}}catch(e){window?.errorLog?.(e)}