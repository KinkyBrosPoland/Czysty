class Subscr{constructor(t={}){this.prefix=t.prefix||"subscr",this.minDelayTime=700,this.queries={...SUBSCR_GQL},this.txt={...SUBSCR_TXT},this.initData={...SUBSCR_INIT_DATA},this.language=t.language||app_shop?.vars?.language?.symbol||"pl",this.typesOfProductThatCannotBeEdited=["bundle","collection","configurable"],this.statuses={active:"active",hold:"hold",finished:"finished"},this.locale={shortWeekdays:[],weekdays:[this.txt.Dzisiaj,this.txt["Poniedziałek"],this.txt.Wtorek,this.txt["Środa"],this.txt.Czwartek,this.txt["Piątek"],this.txt.Sobota,this.txt.Niedziela],onWeekdays:[this.txt.dzisiaj,this.txt["w poniedziałek"],this.txt["we wtorek"],this.txt["w środę"],this.txt["w czwartek"],this.txt["w piątek"],this.txt["w sobotę"],this.txt["w niedzielę"]]},this.getLocale()}getLocale(){for(let t=0;t<7;t++){let e=new Date(0,0,t).toLocaleString(this.language,{weekday:"short"});e=`${e.charAt(0).toUpperCase()}${e.substring(1,e.length)}`,this.locale.shortWeekdays.push(e)}}debounce(t,e=this.minDelayTime){let i;return(...s)=>{clearTimeout(i),i=setTimeout((()=>t(...s)),e)}}getDelayTime(t,e=this.minDelayTime){const i=Date.now()-t;let s=0;return i<e&&(s=e-i),s}createInfo(t){const e=document.createElement("div");e.classList.add("menu_messages_message");const i=document.createElement("p");return i.textContent=t,e.appendChild(i),e}calculateDate(t){const{days:e=0,hours:i=0,minutes:s=0}=t,a=new Date(Date.now()+24*e*60*60*1e3+60*i*60*1e3+60*s*1e3);return{day:a.getDate()<10?`0${a.getDate()}`:a.getDate(),month:a.getMonth()+1<10?`0${a.getMonth()+1}`:a.getMonth()+1,year:a.getFullYear()}}getFormattedDate(t,e={}){if(!t)return"";const{brackets:i=!1,onlyDate:s=!1,alwaysWithDate:a=!1}=e,r=new Date(t.replace(/-/g,"/")),n=new Date,o=Math.floor((r-n)/864e5)+1,c=Math.floor(o/7),h=this.locale.weekdays[r.getDay()],u=t.split("-")[2],l=t.split("-")[1];return s&&i?`(${u}.${l})`:s?`${u}.${l}`:a&&i?`${h} (${u}.${l})`:a?`${h} ${u}.${l}`:0===c?h:i?`${h} (${u}.${l})`:`${h} ${u}.${l}`}findFirstFailedElement(t){if(!t)return!1;return t.querySelector(".f-feedback.--error")||t.querySelector(".f-group.--error")}elementInViewport(t,e){if(!t)return!1;const i=t.getBoundingClientRect();let s;s=e?e.getBoundingClientRect():{top:0,left:0,right:window.innerWidth,bottom:window.innerHeight};const{top:a,left:r,right:n,bottom:o}=i,{top:c,left:h,right:u,bottom:l}=s;return a>=c&&r>=h&&n<=u&&o<=l}scrollToElement(t={}){const{element:e,additionalYOffset:i=(app_shop.vars.view<3?50:0),callback:s=()=>{},container:a,yOffset:r=60}=t;if(!e)return;if(this.elementInViewport(e))return void s();if(a){const t=e.offsetTop-(i||0);a.scrollTo({top:t,behavior:"smooth"});const r=()=>{Math.abs(a.scrollTop-t)<1&&(a.removeEventListener("scroll",r),s())};return void a.addEventListener("scroll",r)}const n=e.getBoundingClientRect(),o=document.querySelector(".--fixed-header header"),c=o?o.offsetHeight:0,{top:h}=n,u=h+window.pageYOffset-r-c-(i||0);window.scrollTo({top:u,behavior:"smooth"});const l=u.toFixed(),p=()=>{window.pageYOffset.toFixed()===l&&(window.removeEventListener("scroll",p),s())};window.addEventListener("scroll",p)}move(t={}){const{element:e,moveSelector:i,moveType:s}=t;if(!e)return;let{moveElement:a}=t;if((a||i)&&(i&&(a=document.querySelector(i)),a))switch(s){case"append":default:a.append(e);break;case"prepend":a.prepend(e);break;case"after":a.after(e);break;case"before":a.before(e);break;case"replace":a.replaceWith(e)}}changeLiteral(t,e={}){const{numerals:i=[],withValue:s=!0}=e,[a="",r="",n=""]=i;if(1===t)return s?`${t} ${r}`:`${r}`;const o=t%10,c=t%100;return 0===t||o>=0&&o<=1||o>=5&&o<=9||c>10&&c<20?s?`${t} ${a}`:`${a}`:(c<10||c>20)&&o>=2&&o<=4?s?`${t} ${n}`:`${n}`:s?`${t}`:""}setParametersWithContext(t,e,i){if(e?.length){const i=this.initData?.wholesaler?"WHOLESALE":"RETAIL",s={[`CONTEXT_MAX_QUANTITY_PER_${i}_ORDER`]:"max_q",[`CONTEXT_MAX_SIZE_QUANTITY_PER_${i}_ORDER`]:"max_s",[`CONTEXT_MIN_QUANTITY_PER_${i}_ORDER`]:"min_q",[`CONTEXT_MIN_SIZE_QUANTITY_PER_${i}_ORDER`]:"min_s"};e.reduce(((t,e)=>{const{name:i}=e.values?.[0]||{},a=s[e.contextValue];return+i&&a?(t.push({value:i,label:a}),t):t}),[]).forEach((e=>{t.setAttribute(`data-${e.label}`,e.value)}))}i&&t.setAttribute("data-min_q",i)}numberCheck(t){const{quantity:e,quantitySizes:i,amount:s,unit_sellby:a,unit:r,unit_precision:n,max_q:o,max_s:c,min_q:h,min_s:u}=t;if(!e)return!1;let l=parseFloat(e);const p=parseFloat(n),d=parseFloat(o),m=parseFloat(c),g=parseFloat(h),b=parseFloat(u),y=parseFloat(parseFloat(a).toFixed(p)),w=1/Math.pow(10,p),D=t=>t%y!==0?D(parseFloat((t+w).toFixed(p))):t.toFixed(p);if(l=parseFloat(D(l)),isNaN(d)&&isNaN(m)&&isNaN(g)&&isNaN(b)&&-1===parseFloat(s))return l;let f=parseFloat(s),$=y,S=-1;return isNaN(d)||(S=d-i,S=S<0?"end":S,f=f>d?d:f),isNaN(m)||(f=f>m?m:f),isNaN(g)||($=g>$?g:$),isNaN(b)||($=b>$?b:$),-1!==f&&($=f>$?$:y),$&&l<$&&0!=l?(Alertek.show_alert(`${this.txt["Minimalnie musisz zamówić"]}: ${Math.ceil(parseFloat($)/y)*y} ${r}`),Math.ceil(parseFloat($)/y)*y):"end"===S?(Alertek.show_alert(`${this.txt["Maksymalnie możesz zamówić"]}: ${Math.floor(parseFloat(d)/y)*y} ${r}`),Math.floor(parseFloat(d)/y)*y):l>f&&-1!==f?(Alertek.show_alert(`${this.txt["Maksymalnie możesz zamówić"]}: ${Math.floor(parseFloat(f)/y)*y} ${r}`),Math.floor(parseFloat(f)/y)*y):l}formatPrice(t){return format_price(t,{mask:app_shop.vars.currency?.format||"###,##0.00",currency:app_shop.vars.currency?.symbol||"zł",currency_space:app_shop.vars.currency?.space??!0,currency_before_price:app_shop.vars.currency?.beforeValue??!1})}decodeGraphQLHTMLString(t){try{if(!t)return"";return(new DOMParser).parseFromString(t,"text/html").documentElement.textContent}catch(t){return""}}checkLastOrderIsShipped(t={}){const{status:e}=t;return!!["t","k","i","s"].includes(e)}toggleTabindexes({wrapper:t,add:e=!0}){t&&(t.querySelectorAll("a, button, input, select, textarea").forEach((t=>{if(e)return t.setAttribute("tabindex","-1"),void(t.disabled=!0);t.removeAttribute("tabindex"),t.disabled=!1})),e?t.setAttribute("aria-hidden",!0):t.removeAttribute("aria-hidden"))}clearCache(t){if(t?.length)t.forEach((t=>{sessionStorage.removeItem(t)}));else for(let t=0;t<sessionStorage.length;){const e=sessionStorage.key(t);e.startsWith(this.prefix)?sessionStorage.removeItem(e):t+=1}}setSessionStorageWithExpiry(t,e,i=30){const s={value:e,expiry:Date.now()+60*i*1e3};sessionStorage.setItem(t,JSON.stringify(s))}getSessionStorageWithExpiry(t){const e=sessionStorage.getItem(t);if(!e)return null;const i=JSON.parse(e),s=Date.now();return i.expiry<s?(sessionStorage.removeItem(t),null):i.value}async fetchData(t={}){const{data:e,link:i,linkParameter:s="",alert:a=!0,cacheName:r=!1,onlyFromCache:n=!1,checkCardChangeInProgress:o=!1}=t;if(r&&this.getSessionStorageWithExpiry(r)||n)return this.getSessionStorageWithExpiry(r);if(!e)return!1;try{const t=await fetch(`${i||app_shop.urls.graphql||"/graphql/v1/"}${s}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:e}),a=await t.json();return!r||a.error?a:o?(a?.data?.subscriptionsView?.subscriptions?.[0]?.subscriptionOptions?.isCardChangeInProgress||this.setSessionStorageWithExpiry(r,a),a):(this.setSessionStorageWithExpiry(r,a),a)}catch(t){return a&&Alertek.Error(this.txt["Wystąpił błąd połączenia. Sprawdź łącze internetowe lub spróbuj ponownie później"]),!1}}getCleanedQuery(t){return t.replace(/\\n|^{"query":"(?:query|mutation) {| \}"}$/g," ").replace(/\\"/g,'"').replace(/\s+/g," ").trim()}async getData(t={}){const{name:e,state:i,onlyFromCache:s=!1,onlyQuery:a=!1}=t;switch(e){case"view":{if(a)return this.getCleanedQuery(this.queries.VIEW(this.initData?.id));const t=await this.fetchData({data:this.queries.VIEW(this.initData?.id),linkParameter:"?query=subscriptionView",cacheName:`subscriptionViewID${this.initData?.id}`,onlyFromCache:s,checkCardChangeInProgress:!0});return t?.data}case"products":{if(a)return this.getCleanedQuery(this.queries.PRODUCTS(this.initData?.id));const t=await this.fetchData({data:this.queries.PRODUCTS(this.initData?.id),linkParameter:"?query=subscriptionProducts",cacheName:`subscriptionProductsID${this.initData?.id}`,onlyFromCache:s});return t?.data}case"productsToAdd":{if(a)return this.getCleanedQuery(this.queries.PRODUCTS_TO_ADD(i?.period,i?.text,i?.productsId));const t=await this.fetchData({data:this.queries.PRODUCTS_TO_ADD(i?.period,i?.text,i?.productsId),linkParameter:"?query=subscriptionProductsToAdd",cacheName:`subscriptionProductsToAddPERIOD${i?.period}${i?.text?`TEXT${i?.text}`:""}${i?.productsId?`PRODUCTS${i?.productsId.sort(((t,e)=>t-e)).map((t=>t)).join(",")}`:""}`,onlyFromCache:s});return t?.data}case"orders":{if(a)return this.getCleanedQuery(this.queries.ORDERS(this.initData?.id,i?.page));const t=await this.fetchData({data:this.queries.ORDERS(this.initData?.id,i?.page),linkParameter:"?query=subscriptionOrders",cacheName:`subscriptionOrdersID${this.initData?.id}Page${i?.page||0}`,onlyFromCache:s});return t?.data}case"init":{const t=await this.getData({name:"view",onlyFromCache:!0}),e=await this.getData({name:"products",onlyFromCache:!0}),i=await this.getData({name:"orders",onlyFromCache:!0});if(t&&e&&i){return{...t,...e,...i}}const s=t?"":await this.getData({name:"view",onlyQuery:!0}),a=e?"":await this.getData({name:"products",onlyQuery:!0}),r=i?"":await this.getData({name:"orders",onlyQuery:!0}),n=JSON.stringify({query:`query {\n            ${s}\n            ${a}\n            ${r}\n          }`}),{data:o}=await this.fetchData({data:n,linkParameter:"?query=subscriptionInit"})||{},{subscriptionsView:c,subscriptionBasket:h,subscriptionOrders:u}=o||{},l={...t,...e,...u};return""!==s&&c&&(l.subscriptionsView=c,c?.subscriptions?.[0]?.subscriptionOptions?.isCardChangeInProgress||this.setSessionStorageWithExpiry(`subscriptionViewID${this.initData?.id}`,{data:{subscriptionsView:c}})),""!==a&&h&&(l.subscriptionBasket=h,this.setSessionStorageWithExpiry(`subscriptionProductsID${this.initData?.id}`,{data:{subscriptionBasket:h}})),""!==r&&u&&(l.subscriptionOrders=u,this.setSessionStorageWithExpiry(`subscriptionOrdersID${this.initData?.id}Page0`,{data:{subscriptionOrders:u}})),l}default:return!1}}async updateData(t={}){const{type:e}=t;switch(e){case"products":{this.clearCache([`subscriptionProductsID${this.initData?.id}`]);const t=await this.getData({name:"products"});this.vars.products=t?.subscriptionBasket?.products||[],this.vars.basketCost=t?.subscriptionBasket?.basketCost||{};break}case"view":{this.clearCache([`subscriptionViewID${this.initData?.id}`]);const t=await this.getData({name:"view"});this.vars.view=t?.subscriptionsView?.subscriptions?.[0]||{};break}case"init":this.clearCache([`subscriptionViewID${this.initData?.id}`,`subscriptionProductsID${this.initData?.id}`,`subscriptionOrdersID${this.initData?.id}Page0`]),await this.getInitData()}}async getInitData(){if(!this.initData?.id)return;const t=await this.getData({name:"init"});this.vars={view:t?.subscriptionsView?.subscriptions?.[0]||{},products:t?.subscriptionBasket?.products||[],basketCost:t?.subscriptionBasket?.basketCost||{},orders:t?.subscriptionOrders||{}}}async init(){await this.getInitData()}async reInit(){this.clearCache(),await this.getInitData()}}app_shop.fn.subscr=new Subscr;