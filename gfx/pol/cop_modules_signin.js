class LoginCOP extends COPModules{constructor(e={}){super(e),this.servicesHash="#servicesLogin"}removeHashFromUrl(){const e=new URL(window.location.href);e.hash.includes(this.servicesHash)&&(e.hash=e.hash.replace(this.servicesHash,""),window.history.replaceState({},document.title,e.toString()))}prepareProspectData(e){return{data:{client:{billingAddress:{firstname:e.deliveryAddress?.[0]?.firstname||"",lastname:e.deliveryAddress?.[0]?.lastname||""},deliveryAddresses:e.deliveryAddress,birthDate:e.birthDate,phone:e.phone,email:e.email}}}}async servicesLogin(){this.removeHashFromUrl();const{data:e}=await super.fetchData({data:this.queries.CLIENT_PROSPECT(),linkParameter:`?query=copModulesClientProspect&type=${this.type}`}),{clientProspect:i}=e||{};if(!i)return;const t=this.prepareProspectData(i);this.callbacks.afterLogin(t)}async loginSuccess(e){e||(this.logged=1,this.loginElement?.remove?.(),app_shop.vars.logged=1);const i=await super.fetchData({data:this.queries.CLIENT(),linkParameter:`?query=copModulesClient&type=${this.type}`,alert:!1});this.callbacks.afterLogin(i)}initTitle(){const e=this.loginElement.querySelector(`.${this.prefix}__title`);e&&("oscop"!==this.type&&"order1"!==this.type||e.remove())}initLabel(){const e=this.loginElement.querySelector(`.${this.prefix}_login__label`);e&&"oscop"!==this.type&&"order1"!==this.type&&e.remove()}initSignin(){const e=document.getElementById(`${this.prefix}_signin_template`)?.content.cloneNode(!0);e&&e.firstChild&&(this.signinElement=e.firstChild,this.validateSignin=new FormValidation({form:this.signinElement}),this.validateSignin.init(),super.addFocus(this.signinElement),super.addFocusEvents(this.signinElement),this.signinModal=new Modal({element:this.signinElement,classList:"--signin --extrasmall",notInit:!0,setFocusOnFirstElement:!0,afterShow:()=>{document.querySelector(".modal.--signin").setAttribute("aria-label",this.txt.logowanie)}}))}onClickSignin(){this.signinModal.init()}async onClickService(e){const{target:i}=e,t=i.closest(`.${this.prefix}_login__service`);if(!t)return;if(t.classList.contains("--fetched"))return;e.preventDefault();const s=t.closest(`.${this.prefix}_login__services`);if(!s)return;s.classList.add("--loading");const n=`${window.location.href}${this.servicesHash}`,{data:o}=await super.fetchData({data:this.queries.LOGIN_OPTIONS(`LoginOptionsInput: {\n        redirectUrl: "${n.replace(/"/g,'\\"')}",\n        isWholesaler: false,\n      }`),linkParameter:`?query=copModulesLoginOptions&type=${this.type}`}),{options:a}=o?.loginOptions||{};if(!a)return void s.classList.remove("--loading");const r=t.getAttribute("data-id"),{loginUrl:l}=a.filter((e=>e.id===r))[0]||{};l?window.location.href=l:s.classList.remove("--loading")}async onClickSubmitSignin(){const e=this.signinElement.querySelector('input[name="login"]');if(!e)return;const i=this.signinElement.querySelector('input[name="password"]');if(!i)return;if(!await this.validateSignin.validateForm())return;super.status({element:this.signinElement,status:"loading"});if((await super.fetchData({data:this.queries.SIGNIN(`\n        login: "${e.value.replace(/"/g,'\\"')}",\n        password: "${i.value.replace(/"/g,'\\"')}",\n      `),linkParameter:`?mutation=copModulesSignin&type=${this.type}`,alert:!1})).errors)return super.status({element:this.signinElement,status:"error"}),void this.validateSignin.setValidityState(i,this.txt["Podany login lub hasÅ‚o nie jest poprawne"]);super.status({element:this.signinElement,status:"success",afterRemove:()=>{this.signinElement.remove()}}),this.signinModal?.closeModal?.(),this.loginSuccess()}onKeyupSignin(e){13===(e.which||e.keyCode||0)&&this.onClickSubmitSignin()}initEvents(){if(this.loginElement.addEventListener("click",(e=>{const{target:i}=e;i.closest(`.${this.prefix}_login__service`)?this.onClickService(e):i.closest(`.${this.prefix}_login__link`)&&(e.preventDefault(),this.onClickSignin())})),!this.signinElement)return;this.signinElement.addEventListener("click",(e=>{const{target:i}=e;i.closest(`.${this.prefix}_signin__button`)&&(e.preventDefault(),this.onClickSubmitSignin(i))}));this.signinElement.querySelectorAll(`.${this.prefix}_signin input.f-control`).forEach((e=>{e.addEventListener("keyup",this.onKeyupSignin.bind(this))}))}async generate(){const e=document.getElementById(`${this.prefix}_login_template`)?.content.cloneNode(!0);if(!e||!e.firstChild)return void this.removeHashFromUrl();const i=this.loginElement;this.loginElement=i||e.firstChild;const{href:t}=window.location;-1===t.search(this.servicesHash)?(this.removeHashFromUrl(),this.initTitle(),this.initLabel(),this.initSignin(),this.initEvents(),i&&document.body.contains(i)?i.replaceWith(this.loginElement):super.move({element:this.loginElement,...this.vars.move})):this.servicesLogin()}async init(e={}){this.type=e.type||app_shop.vars.copModulesType||"oscop",this.vars={afterReady:e.afterReady||(()=>{}),move:e.move||this.vars?.move||{}},this.callbacks={afterLogin:e.afterLoginCallback||(()=>{})},await this.generate(),this.vars.afterReady(this.loginElement)}}app_shop.fn.copModulesLogin=new LoginCOP,app_shop.vars.copModulesClasses.push((()=>{app_shop.fn.copModulesLogin=new LoginCOP}));