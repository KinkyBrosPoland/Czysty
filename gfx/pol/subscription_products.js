class SubscrProducts extends Subscr{constructor(t={}){super(t),this.elementsMap=new WeakMap,this.changeLiteralProducts=[this.txt["produktów"],this.txt.produkt,this.txt.produkty]}async changeProductQuantity(t){const e=t.closest(`.${this.prefix}_product`);if(!e)return;const{product:s}=this.elementsMap.get(e)||{};if(!s)return;const{value:i}=t||{};if(!i)return;if(+i===+s.quantity)return;document.documentElement.classList.remove("--dropdown-open"),this.productsElement.querySelector(`.${this.prefix}_products__wrapper`)?.classList.add("--loading");const r=this.getChangeQuantityInputQuery({product:s,quantity:i});await super.fetchData({data:this.queries.CHANGE_PRODUCT_QUANTITY(r),linkParameter:"?mutation=subscriptionChangeProductQuantity"}),this.callbacks.afterChangeQuantity?.()}async saveChangeProductVersion({product:t,selectedSize:e,selectedProductId:s}){this.changeProductVersionElement.closest(".modal")?.classList.add("--loading"),this.productsElement.querySelector(`.${this.prefix}_products__wrapper`)?.classList.add("--loading");const i=this.getRemoveProductInputQuery({product:t}),r=this.getAddProductInputQuery({product:t,selectedSize:e,selectedProductId:s}),o=super.getCleanedQuery(this.queries.REMOVE_PRODUCT_FROM_SUBSCRIPTION(i)),n=super.getCleanedQuery(this.queries.ADD_PRODUCT_TO_SUBSCRIPTION(r)),a=JSON.stringify({query:`mutation {\n        ${n}\n        ${o}\n      }`});await super.fetchData({data:a,linkParameter:"?mutation=subscriptionChangeProductVersion"}),this.vars.modal.closeModal(),this.callbacks.afterChangeProductVersion?.()}async removeProductFromSubscription({product:t}){this.productsElement.querySelector(`.${this.prefix}_products__wrapper`)?.classList.add("--loading");const e=this.getRemoveProductInputQuery({product:t});await super.fetchData({data:this.queries.REMOVE_PRODUCT_FROM_SUBSCRIPTION(e),linkParameter:"?mutation=subscriptionRemoveProductFromSusbcription"}),this.callbacks.afterRemoveProduct?.()}getAddProductInputQuery({product:t,selectedSize:e,selectedProductId:s}){const{amount:i}=t.data.sizes.find((t=>t.id===e))||{},{quantity:r}=t||{},o=-1!==i&&i<r?i:r;return`\n      subscriptionId: ${this.vars.view.id},\n      product: {\n        id: ${s},\n        size: "${e}",\n        quantity: ${o},\n      }\n    `}getChangeQuantityInputQuery({product:t,quantity:e}){const{id:s,size:i,additional:r}=t||{};return`\n      subscriptionId: ${this.vars.view.id},\n      product: {\n        id: ${s},\n        size: "${i}",\n        additional: "${r}",\n        quantity: ${e},\n      }\n    `}getRemoveProductInputQuery({product:t}){const{id:e,size:s,additional:i}=t||{};return`\n      subscriptionId: ${this.vars.view.id},\n      product: {\n        id: ${e},\n        size: "${s}",\n        additional: "${i}",\n        bonus: false,\n      }\n    `}getQuantitySizes(t){const{productId:e}=t.dataset;return[...this.productsElement.querySelectorAll(`.${this.prefix}_product__input[data-product-id="${e}"]`)].map((t=>+t.value)).reduce(((t,e)=>t+e))}validateInput(t){const{target:e}=t;if(""===e.value)return;const s=this.getQuantitySizes(e)??e.value,i={...e.dataset,quantity:e.value,quantitySizes:s},r=super.numberCheck(i);r&&(e.setAttribute("data-prev",r),e.value=r,this.changeProductQuantity(e))}dropdownNumberAfterClick(t){const e=t.querySelector(".f-dropdown-item"),s=t.closest(`.${this.prefix}_product__quantity`),i=s.querySelector(`.${this.prefix}_product__input`);if(e.hasAttribute("data-more"))return s.classList.add("--more"),i.focus(),void(i.value="");s.classList.remove("--more"),i.value=e.getAttribute("data-value"),this.validateInput({target:i})}getProductSizeByID(t,e){return null!=e&&t?.data?.sizes?.filter((t=>t?.id?.toString()===e?.toString()))?.[0]}prepareSizesVersions(t){return t.flatMap((t=>t.sizes?.map((e=>({productId:t.id,sizeId:e.id,name:`${t.versionName}${"uniw"!==e.id?`: ${e.name}`:""}`,amount:e.amount}))))).filter((t=>t))}async getSizesProductVersion(t){const{products:{products:e=[]}={}}=await super.getData({name:"productsToAdd",state:{period:this.vars.view.daysInPeriod,productsId:t.map((t=>t.id))}})||{},s=t.flatMap((t=>e.find((e=>e.id===t.id)))).filter((t=>void 0!==t));return this.prepareSizesVersions(s)}setSubLabelChangeProductVersion(t){const e=this.changeProductVersionElement.querySelector(`.${this.prefix}_change_product_version__sub_label`);if(!e)return;const{group:{name:s,versions:i}={}}=t?.data||{};!i||i?.length<2||(e.textContent=this.txt["Wybierz %s"].format(s.toLowerCase()))}async setSelectChangeProductVersion(t){const e=this.changeProductVersionElement.querySelector(`.${this.prefix}_change_product_version__select`);if(!e)return;const{id:s,size:i}=t||{},{sizes:r=[],group:{versions:o}={}}=t?.data||{};if(!o||o?.length<2)return void r.forEach((t=>{const r=document.createElement("option");if(r.value=t.id,r.textContent=t.name,i===t.id&&(r.selected=!0),0===t.amount)return r.classList.add("--disabled"),void r.setAttribute("label",`${t.name} (${this.txt.wyprzedane})`);t.productId=s,e.append(r),this.elementsMap.set(r,t)}));(await this.getSizesProductVersion(o)).forEach((t=>{const r=document.createElement("option");if(r.value=t.sizeId,r.textContent=t.name,i===t.sizeId&&s===t.productId&&(r.selected=!0),0===t.amount)return r.classList.add("--disabled"),void r.setAttribute("label",`${t.name} (${this.txt.wyprzedane})`);e.append(r),this.elementsMap.set(r,t)}))}async getChangeProductVersionModalElement(t){const e=document.getElementById(`${this.prefix}_change_product_version_template`)?.content.cloneNode(!0);return!(!e||!e.firstChild)&&(this.changeProductVersionElement=e.firstChild,this.setSubLabelChangeProductVersion(t),await this.setSelectChangeProductVersion(t),this.elementsMap.set(this.changeProductVersionElement,{product:t}),this.changeProductVersionElement)}addVisibilityClasses(t){t.forEach(((e,s)=>{s+1===this.vars.numberOfVisibleProducts&&e.classList.add("--last-visible"),s+1===t.length&&e.classList.add("--last"),s+1>this.vars.numberOfVisibleProducts&&(e.classList.add("--hide"),e.setAttribute("aria-hidden",!0),super.toggleTabindexes({wrapper:e,add:!0}))}))}visibility(){const t=this.productsElement.querySelectorAll(`.${this.prefix}_product`);this.addVisibilityClasses(t)}updateWorth(t){const e=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--worth`);if(!e)return;const{formatted:s}=t?.totalProductsCost||{};if(!s)return void e.classList.remove("--active");const i=e.querySelector(`.${this.prefix}_costs__value`);i&&(i.textContent=s,e.classList.add("--active"))}updateWorthPoints(t){const e=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--worth-points`);if(!e)return;const{value:s}=t?.totalProductsCostAtPoints||{};if(!s)return void e.classList.remove("--active");const i=e.querySelector(`.${this.prefix}_costs__value`);i&&(i.textContent=`${s} ${this.txt.pkt}.`,e.classList.add("--active"))}updateRebate(t){const e=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--rebate`);if(!e)return;const{formatted:s,value:i}=t?.totalRebateWithoutShipping||{};if(!s||!i)return void e.classList.remove("--active");const r=e.querySelector(`.${this.prefix}_costs__value`);r&&(r.textContent=s,e.classList.add("--active"))}updatePaymentCost(t){const e=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--paymentcost`);if(!e)return;const{formatted:s,value:i}=t?.prepaidCost||{};if(!s||!i)return void e.classList.remove("--active");const r=e.querySelector(`.${this.prefix}_costs__value`);r&&(r.textContent=s,e.classList.add("--active"))}updateShippingCost(t){const e=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--shipping`);if(!e)return;const{formatted:s,value:i}=t?.basketShippingCost?.shippingCostAfterRebate||{},{shippingCostPoints:r}=t?.basketShippingCost||{},o=e.querySelector(`.${this.prefix}_costs__value`),n=e.querySelector(`.${this.prefix}_costs__label`);if(o&&n){if(!(r||s&&i))return e.classList.add("--active"),o.textContent=`${this.txt.Gratis}!`,void o.classList.remove("--plus");if(o.classList.add("--plus"),r)return o.textContent=`${r} ${this.txt.pkt}.`,void e.classList.add("--active");o.textContent=s,e.classList.add("--active")}else e.classList.remove("--active")}updateInsurance(t){const e=this.summaryElement.querySelector(`.${this.prefix}_costs__item.--insurance`);if(!e)return;const{formatted:s,value:i}=t?.insuranceCost||{};if(!s||!i)return void e.classList.remove("--active");const r=e.querySelector(`.${this.prefix}_costs__value`);r&&(r.textContent=s,e.classList.add("--active"))}updateTotal(t){const e=this.summaryElement.querySelector(`.${this.prefix}_total__item.--value .${this.prefix}_total__value`);if(!e)return;const{formatted:s}=t?.totalToPay||{};if(!s)return;e.textContent=`${s}`;const i=this.summaryElement.querySelector(`.${this.prefix}_buttons__cost`);i&&(i.textContent=`${s}`)}updateTotalLabel(){const t=this.summaryElement.querySelector(`.${this.prefix}_total__item.--value .${this.prefix}_total__label`);if(!t)return;const[e]=this.vars.orders;super.checkLastOrderIsShipped(e)||(t.textContent=`${this.txt["Do zapłaty przy następnym odnowieniu"]}:`)}updateTotalPoints(t){const e=this.summaryElement.querySelector(`.${this.prefix}_total__item.--points`);if(!e)return;const s=e.querySelector(`.${this.prefix}_total__value`);if(!s)return;const{value:i}=t?.totalToPayAtPoints||{};i?(e.classList.add("--active"),s.textContent=`${i} ${this.txt.pkt}.`):e.classList.remove("--active")}updateAccept(){const t=this.summaryElement.querySelector(`.${this.prefix}_summary_accept`);if(!t)return;const{subscriptionAcceptData:{acceptanceIsRequired:e}={}}=this.vars.view;if(!e||this.vars.view.status===this.statuses.finished)return void t.remove();const{subscriptionAcceptData:{totalCostBeforeChange:s}={}}=this.vars.view;if(!s)return void t.remove();this.summaryElement.querySelector(`.${this.prefix}_total`)?.remove();const i=t.querySelector(`.${this.prefix}_summary_accept__item.--before .${this.prefix}_summary_accept__value`);i&&(i.textContent="1 058,53 zł");const r=t.querySelector(`.${this.prefix}_summary_accept__item.--after .${this.prefix}_summary_accept__value`);r&&(r.textContent=this.vars.basketCost?.totalToPay?.formatted)}updateCosts(){this.vars.basketCost&&(this.updateWorth(this.vars.basketCost),this.updateWorthPoints(this.vars.basketCost),this.updateRebate(this.vars.basketCost),this.updatePaymentCost(this.vars.basketCost),this.updateShippingCost(this.vars.basketCost),this.updateInsurance(this.vars.basketCost),this.updateTotal(this.vars.basketCost),this.updateTotalLabel(),this.updateTotalPoints(this.vars.basketCost),this.updateAccept())}initSummary(){const t=document.getElementById(`${this.prefix}_products_summary_template`)?.content.cloneNode(!0);t&&t.firstChild&&(this.summaryElement=t.firstChild,this.updateCosts(),this.productsElement.querySelector(`.${this.prefix}_products__wrapper`)?.append(t))}setAcceptDiff(t){const e=this.acceptElement.querySelector(`.${this.prefix}_accept__diff`);e&&(t?e.innerHTML=this.txt["Aktualna cena zmieniła się o %s względem wartości ostatniego zamówienia w subskrypcji"].format(`<b>${t?.formatted}</b>`):e.remove())}setAcceptInfo(t){const e=this.acceptElement.querySelector(`.${this.prefix}_accept__info`);e&&(e.innerHTML=t?`${this.txt["Akceptacja nowej ceny subskrypcji jest warunkiem kontynuowania usługi. Jeśli nie zaakceptujesz nowej ceny%s, usługa subskrypcji zostanie wstrzymana i nie pobierzemy opłaty za najbliższe zamówienie"].format(` ${this.txt["do %s"].format(t)}`)}.`:`${this.txt["Akceptacja nowej ceny subskrypcji jest warunkiem kontynuowania usługi. Jeśli nie zaakceptujesz nowej ceny%s, usługa subskrypcji zostanie wstrzymana i nie pobierzemy opłaty za najbliższe zamówienie"].format("")}.`)}initAccept(){const{subscriptionAcceptData:{acceptanceIsRequired:t,acceptationDeadline:e,diffTotalCost:s}={}}=this.vars.view;if(!t||this.vars.view.status===this.statuses.finished)return;const i=document.getElementById(`${this.prefix}_products_accept_template`)?.content.cloneNode(!0);i&&i.firstChild&&(this.acceptElement=i.firstChild,this.setAcceptDiff(s),this.setAcceptInfo(e),this.productsElement.querySelector(`.${this.prefix}_products__wrapper`)?.append(i))}setProductIcon(t,e){const s=e.querySelector(`.${this.prefix}_product__icon`),i=e.querySelector(`.${this.prefix}_product__icon img`);if(!s||!i)return;const{link:r,name:o,icon:n}=t?.data||{};s.href=r,i.alt=o,i.src=n}setProductName(t,e){const s=e.querySelector(`.${this.prefix}_product__name`);if(!s)return;const{link:i,name:r}=t?.data||{};s.href=i,s.textContent=r}setProductTrait(t){const{element:e,trait:s,traitLabel:i,type:r}=t;if(!e)return;if(!s)return void e.parentNode.removeChild(e);if("size"===r&&"uniw"===s)return void e.parentNode.removeChild(e);const o=e.querySelector(`.${this.prefix}_product__trait_value`);if(!o)return void e.parentNode.removeChild(e);o.textContent=s;const n=e.querySelector(`.${this.prefix}_product__trait_label`);i&&n&&(n.textContent=`${i}: `)}setProductTraits(t,e,s){const i=e.querySelector(`.${this.prefix}_product__trait.--quantity`),{unit:{singular:r,plural:o}={}}=t?.data||{};this.setProductTrait({element:i,trait:!this.vars.canEdit||s?`${t?.quantity} ${t?.quantity>1?o:r}`:""});const n=e.querySelector(`.${this.prefix}_product__trait.--barcode`);this.setProductTrait({element:n,trait:t?.data?.code});const a=e.querySelector(`.${this.prefix}_product__trait.--version`);this.setProductTrait({element:a,trait:t?.data?.versionName,traitLabel:t?.data?.group?.name});const c=e.querySelector(`.${this.prefix}_product__trait.--size`),u=this.getProductSizeByID(t,t?.size)?.name;this.setProductTrait({element:c,trait:"uniw"===t?.size?"":u,type:"size"});const d=e.querySelector(`.${this.prefix}_product__traits`);d&&!d.hasChildNodes()&&d.parentNode.removeChild(d)}setProductBundle(t,e){const s=e.querySelector(`.${this.prefix}_product__bundle`);if(!s)return;const i=s.querySelector(`.${this.prefix}_product__bundle_label`);if(!i)return;const r=s.querySelector(`.${this.prefix}_product__bundle_items`);if(!r)return;const{bundleProducts:o=[]}=t||{};if(!o?.length)return void s.remove();const{type:n}=t?.data||{};"collection"===n&&(i.textContent=`${this.txt["Składowe kolekcji"]}: `),o.forEach((t=>{const e=document.createElement("span");e.classList.add(`${this.prefix}_product__bundle_item`),e.innerHTML=`${t.name}${"uniw"!==t.sizeId?` (${this.txt.Rozmiar}: <b>${t.sizeName}</b>)`:""}`,r.append(e)}))}setProductVersion(t,e,s){const i=e.querySelector(`.${this.prefix}_product__version`);if(!i)return;if(!this.vars.canEdit||s)return void i.remove();const{sizes:r=[],versionName:o,group:{name:n,versions:a}={}}=t?.data||{};if(r.length<2&&(!a||a?.length<2))return void i.remove();const c=i.querySelector(`.${this.prefix}_product__version_label`),u=i.querySelector(`.${this.prefix}_product__version_value`);c&&u&&(c.textContent=n||`${this.txt.Rozmiar}:`,u.innerHTML=`<span class="sr-only">${this.txt["Zmień"]} ${n||`${this.txt.Rozmiar}`}</span>\n      ${o||this.getProductSizeByID(t,t?.size)?.name}`)}setProductRemove(t,e,s){if(this.vars.canEdit&&this.vars.products.length>1&&!s)return;e.querySelectorAll(`.${this.prefix}_product__remove`).forEach((t=>t.remove()))}setProductQuantity(t,e,s){const i=e.querySelector(`.${this.prefix}_product__quantity`);if(!i)return;if(!this.vars.canEdit||s)return void i.remove();const r=e.querySelector(`.${this.prefix}_product__input`);if(!r)return;const{quantity:o,size:n,data:a,id:c}=t||{},{unit:{singular:u,plural:d,precision:l,sellBy:p=1}={},parametersWithContext:h,subscription:m}=a||{},{minimumQuantity:_}=m||{},f=this.getProductSizeByID(t,n)?.amount||o;r.value=o,r.setAttribute("data-product-id",c),r.setAttribute("data-amount",f),r.setAttribute("data-unit_sellby",p),r.setAttribute("data-step",p),r.setAttribute("data-unit",f>1?d:u),r.setAttribute("data-unit_precision",l),super.setParametersWithContext(r,h,_);const v=e.querySelector(`.${this.prefix}_product__select`);if(!v)return;if(1!==p){v.querySelectorAll("option[value]").forEach((t=>{t.value=+t.value*p,t.textContent=+t.textContent*p}))}const y=v.querySelector(`option[value="${o}"]`),b=v.querySelector("option[data-more]");y?y.setAttribute("selected","selected"):b.setAttribute("selected","selected")}setProductPrice(t,e){const s=e.querySelector(`.${this.prefix}_product__sum_value`);if(!s)return;const{forPoints:i,worthPoints:{value:r}}=t||{};if(i)return void(s.textContent=`${r} ${this.txt.pkt}.`);const{worth:{gross:{value:o,formatted:n}}}=t||{};s.textContent=0!==o?n:`${this.txt.Gratis}!`}setProductPeriod(t){const e=t.querySelector(`.${this.prefix}_product__sum_period`);e&&(e.textContent=`/ ${this.txt["co %s dni"].format(this.vars.view.daysInPeriod)}`)}getProduct(t){const e=document.getElementById(`${this.prefix}_product_template`)?.content.cloneNode(!0);if(!e||!e.firstChild)return!1;e.firstChild.dataset.id=t.id,e.firstChild.dataset.sizeId=t.size;const{type:s}=t?.data||{},i=this.typesOfProductThatCannotBeEdited.includes(s);return e.firstChild.classList.toggle("--cant-edit",i),this.setProductIcon(t,e),this.setProductName(t,e),this.setProductTraits(t,e,i),this.setProductBundle(t,e),this.setProductVersion(t,e,i),this.setProductRemove(t,e,i),this.setProductQuantity(t,e,i),this.setProductPrice(t,e),this.setProductPeriod(e),this.elementsMap.set(e.firstChild,{product:t}),e.firstChild}initProducts(){const t=this.productsElement.querySelector(`.${this.prefix}_products__items`);t&&this.vars.products.forEach((e=>{const s=this.getProduct(e);s&&t.appendChild(s)}))}getMoreLiteral({hide:t=!1}={}){if(t)return`- ${this.txt["Zwiń listę"]}`;const e=this.vars.products.length-this.vars.numberOfVisibleProducts;return`+${super.changeLiteral(e,{numerals:this.changeLiteralProducts})} ${this.txt["z subskrypcji"]}`}initMore(){const t=this.productsElement.querySelector(`.${this.prefix}_products__more`);if(!t)return;const e=this.productsElement.querySelector(`.${this.prefix}_products__more_link`);e&&(this.vars.products.length<=this.vars.numberOfVisibleProducts?t.remove():(e.textContent=this.getMoreLiteral({hide:this.vars.showMoreProducts}),this.productsElement.classList.toggle("--more",this.vars.showMoreProducts),this.productsElement.querySelectorAll(`.${this.prefix}_product.--hide`).forEach((t=>{super.toggleTabindexes({wrapper:t,add:!this.vars.showMoreProducts})}))))}initTitle(){const t=this.productsElement.querySelector(`.${this.prefix}__title`);t&&(t.textContent=this.txt["Produkty w subskrypcji"])}initDropdowns(){this.vars.dropdowns=new SelectToDropdown({disableMobileView:!!app_shop.fn.isIos?.()??!1,selector:`.${this.prefix}_product__select:not(.f-dropdown)`,afterClickDropdownCallback:this.dropdownNumberAfterClick.bind(this)})}initChangeProductVersionDropdown(){this.vars.changeProductVersionDropdown=new SelectToDropdown({disableMobileView:!!app_shop.fn.isIos?.()??!1,selector:`.${this.prefix}_change_product_version__select:not(.f-dropdown)`})}async onClickChangeProductVersion(t){const e=t.closest(`.${this.prefix}_product`);if(!e)return;const{product:s}=this.elementsMap.get(e)||{};if(!s)return;this.productsElement.classList.add("--loading");const i=await this.getChangeProductVersionModalElement(s);this.productsElement.classList.remove("--loading"),i&&(this.vars.modal=new Modal({element:i,classList:"--subscr --change-product-version --mobile",afterClose:()=>document.documentElement.classList.remove("--dropdown-open")}),this.initChangeProductVersionEvents(),this.initChangeProductVersionDropdown(),this.vars.modal?.assignTabIndexes?.())}onClickEditProductVersion(){const[{value:t,selectedIndex:e,options:s}]=this.vars.changeProductVersionDropdown.selects||[],{productId:i}=this.elementsMap.get(s[e])||{};if(!t)return;const{product:r}=this.elementsMap.get(this.changeProductVersionElement)||{},{size:o,id:n}=r||{};o&&(document.documentElement.classList.remove("--dropdown-open"),o!==t||n!==i?this.saveChangeProductVersion({product:r,selectedSize:t,selectedProductId:i}):this.vars.modal.closeModal())}initChangeProductVersionEvents(){this.changeProductVersionElement.addEventListener("click",(t=>{const{target:e}=t;e.closest(`.${this.prefix}_change_product_version__button.--return`)?this.vars.modal.closeModal():e.closest(`.${this.prefix}_change_product_version__button.--edit`)&&this.onClickEditProductVersion()}))}onClickShowHideProducts(){const t=this.productsElement.querySelector(`.${this.prefix}_products__more_link`);t&&(this.productsElement.classList.toggle("--more"),this.productsElement.querySelectorAll(`.${this.prefix}_product.--hide`).forEach((t=>{super.toggleTabindexes({wrapper:t,add:!this.productsElement.classList.contains("--more")})})),t.textContent=this.getMoreLiteral({hide:this.productsElement.classList.contains("--more")}),this.vars.showMoreProducts=this.productsElement.classList.contains("--more"),this.productsElement.classList.contains("--more")?this.productsElement.querySelector(`.${this.prefix}_product.--last-visible`)?.nextElementSibling?.querySelector(`.${this.prefix}_product__name`)?.focus():super.scrollToElement({element:this.productsElement.querySelector(`.${this.prefix}_product`)}))}onClickRemoveProduct(t){const e=t.closest(`.${this.prefix}_product`);if(!e)return;const{product:s}=this.elementsMap.get(e);this.removeProductFromSubscription({product:s})}async onClickAccept(){this.productsElement.classList.add("--loading"),await super.fetchData({data:this.queries.UPDATE_SUBSCRIPTION(`subscriptionEditModel: {\n        subscriptionId: ${this.vars.view.id},\n        acceptPrice: true,\n      }`),linkParameter:"?mutation=subscriptionAcceptNewPrice"}),this.callbacks.afterAcceptNewPrice?.()}onBlurInput(){""===this.value&&(this.value=this.dataset.prev)}initEvents(){this.productsElement.addEventListener("click",(t=>{const{target:e}=t;if(!e.closest(`.${this.prefix}_product__version_value`))return e.closest(`.${this.prefix}_products__more_link`)?(t.preventDefault(),void this.onClickShowHideProducts()):e.closest(`.${this.prefix}_product__remove_link`)?(t.preventDefault(),void this.onClickRemoveProduct(e)):void(e.closest(`.${this.prefix}_accept__button`)&&this.onClickAccept(e));this.onClickChangeProductVersion(e)})),this.productsElement.querySelectorAll(`.${this.prefix}_product__input`).forEach((t=>{t.addEventListener("keyup",this.debounces.validateInput),t.addEventListener("blur",this.onBlurInput)}))}checkCanEdit(){return this.vars.view.status!==this.statuses.finished&&this.vars.view.subscriptionOptions.canCustomerEditSubscriptionBasket}async generate(){const t=document.getElementById(`${this.prefix}_products_template`)?.content.cloneNode(!0);if(!t||!t.firstChild)return;const e=this.productsElement;if(this.productsElement=t.firstChild,this.vars.canEdit=this.checkCanEdit(),this.initTitle(),this.initProducts(),this.initMore(),this.initSummary(),this.initAccept(),this.initEvents(),e&&document.body.contains(e))return e.replaceWith(this.productsElement),this.initDropdowns(),void this.visibility();super.move({element:this.productsElement,...this.vars.move}),this.initDropdowns(),this.visibility()}async init(t={}){this.vars={afterReady:t.afterReady||(()=>{}),move:t.move||this.vars?.move||{},numberOfVisibleProducts:t.numberOfVisibleProducts??this.vars?.numberOfVisibleProducts??2,products:t.products||this.vars?.products||[],basketCost:t.basketCost||this.vars?.basketCost||null,view:t.view||this.vars?.view||{},showMoreProducts:t.showMoreProducts||this.vars?.showMoreProducts||!1,orders:t.orders||this.vars?.orders||[]},this.callbacks={afterChangeProductVersion:t.afterChangeProductVersionCallback||this.callbacks?.afterChangeProductVersion,afterRemoveProduct:t.afterRemoveProductCallback||this.callbacks?.afterRemoveProduct,afterChangeQuantity:t.afterChangeQuantityCallback||this.callbacks?.afterChangeQuantity,afterAcceptNewPrice:t.afterAcceptNewPriceCallback||this.callbacks?.afterAcceptNewPrice},this.debounces={validateInput:this.debounce(this.validateInput.bind(this))},await this.generate(),this.vars.afterReady(this.productsElement)}}app_shop.fn.subscrProducts=new SubscrProducts;