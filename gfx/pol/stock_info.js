const StockSite=function(e){return this.params=e||{},this.vars={stock:{}},this.googleVars={key:!1,loaded:!1,map:!1,markerInfo:!1,marker:!1,callbackFnName:"app_shop.fn.stockSite.initGoogleMap"},this.leafletVars={url:"https://nominatim.openstreetmap.org/search?format=json&q=",loaded:!1,map:!1,marker:!1},this.elementInViewport=e=>{if(!e)return!1;const t=e.getBoundingClientRect(),{top:s,left:o,right:a,bottom:r}=t,{innerWidth:i,innerHeight:n}=window,{clientWidth:l,clientHeight:c}=document.documentElement;return s>=0&&o>=0&&a<=(i||l)&&r<=(n||c)},this.scrollToElement=(e={})=>{const{element:t,additionalYOffset:s=(app_shop.vars.view<3?50:0),callback:o}=e;if(!t)return;if(this.elementInViewport(t))return void o?.();const a=t.getBoundingClientRect(),r=document.querySelector(".--fixed-header header"),i=r?r.offsetHeight:0,{top:n}=a,l=n+window.pageYOffset-60-i-(s||0),c=l.toFixed(),h=()=>{window.pageYOffset.toFixed()===c&&(window.removeEventListener("scroll",h),o?.())};window.addEventListener("scroll",h),h(),window.scrollTo({top:l,behavior:"smooth"})},this.buildMarkerInfo=e=>{const{name:t,street:s,zipcode:o,city:a}=e||{};return`<div class="stock_marker">\n        <strong class="stock_marker__name">${t}</strong>\n        <div class="stock_marker__address">\n          <span class="stock_marker__street">${s}</span>\n          <span class="stock_marker__city">${o}&nbsp;${a}</span>\n        </div>\n      </div>`},this.getLeafletPlace=e=>{if(!e)return!1;return e.find((e=>e.lat&&e.lon))},this.getLeafletLocation=e=>!!e&&{lat:e.lat,lng:e.lon},this.findAddress=async e=>{if(this.googleVars.key){const t=await this.googleVars.geocoder.geocode({address:e}),{results:[{geometry:{location:s}={},formatted_address:o}={}]=[]}=t||{};return!!s&&{lat:s?.lat(),lng:s?.lng(),name:o}}const t=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e)}`),s=await t.json(),o=this.getLeafletPlace(s);return this.getLeafletLocation(o)},this.centerGoogleMarker=e=>{this.googleVars.map.setOptions({center:e.position,zoom:15}),this.googleVars.markerInfo.setContent(this.buildMarkerInfo(this.vars.stock)),this.googleVars.markerInfo.open(this.googleVars.map,e)},this.centerLeafletMarker=e=>{e&&(this.leafletVars.map.setView(e.getLatLng(),15),e.openPopup())},this.centerMarker=()=>{this.googleVars.key?this.centerGoogleMarker(this.googleVars.marker):this.centerLeafletMarker(this.leafletVars.marker)},this.getAddress=e=>{const{street:t,zipcode:s,city:o,country:a}=e||{};return`${t},${this.googleVars.key?` ${s}`:""} ${o}, ${a}`},this.updateGoogleMarker=async()=>{let{lat:e,lng:t}=this.vars.stock;const s=this.getAddress(this.vars.stock);if(!e||!t){const o=await this.findAddress(s);e=o.lat,t=o.lng,this.vars.stock.lat=e,this.vars.stock.lng=t}this.googleVars.marker=new google.maps.marker.AdvancedMarkerElement({position:{lat:+e,lng:+t}}),this.googleVars.marker.addListener("click",(()=>{this.googleVars.markerInfo.setContent(this.buildMarkerInfo(this.vars.stock)),this.googleVars.markerInfo.open(this.googleVars.map,this.googleVars.marker)})),this.googleVars.marker.setMap(this.googleVars.map),this.centerGoogleMarker(this.googleVars.marker),this.removeLoading()},this.initGoogleMap=()=>{this.googleVars.geocoder=new google.maps.Geocoder,this.googleVars.map=new google.maps.Map(document.getElementById("stock_map"),{center:{lat:52.237049,lng:21.017532},zoom:10,fullscreenControl:!1,mapTypeControl:!1,streetViewControl:!1,mapId:"DEMO_MAP_ID"}),this.googleVars.markerInfo=new google.maps.InfoWindow({disableAutoPan:!0,content:""}),this.googleVars.loaded=!0,this.updateGoogleMarker()},this.updateLeafletMarker=async()=>{let{lat:e,lng:t}=this.vars.stock;const s=this.getAddress(this.vars.stock);if(!e||!t){const o=await this.findAddress(s);e=o.lat,t=o.lng,this.vars.stock.lat=e,this.vars.stock.lng=t}this.leafletVars.marker=new L.Marker([+e,+t]),this.leafletVars.marker.bindPopup(this.buildMarkerInfo(this.vars.stock)),this.leafletVars.map.addLayer(this.leafletVars.marker),this.centerLeafletMarker(this.leafletVars.marker),this.removeLoading()},this.initLeafletMap=()=>{this.leafletVars.map=L.map("stock_map",{center:{lat:52,lng:19.5},zoom:13,zoomControl:!1}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:3,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(this.leafletVars.map),this.leafletVars.loaded=!0,this.updateLeafletMarker()},this.initMap=()=>{if(document.getElementById("stock_map").classList.add("--active"),this.googleVars.key){const e=document.createElement("script");return e.src=`https://maps.googleapis.com/maps/api/js?key=${this.googleVars.key}&loading=async&libraries=places,marker&callback=${this.googleVars.callbackFnName}`,e.async=!0,void document.body.appendChild(e)}this.initLeafletMap()},this.showOnMap=e=>{e.preventDefault();const t=document.getElementById("stock_map");return!!t&&(this.googleVars.loaded||this.leafletVars.loaded?(this.centerMarker(),this.scrollToElement({element:t}),!1):(this.init(),this.scrollToElement({element:t}),!1))},this.getStock=()=>{const e=document.querySelector(".stock_info");e&&Object.entries(e.dataset).forEach((([e,t])=>{this.vars.stock[e]=t}))},this.initEvents=()=>{const e=document.querySelector(".stock_info__show_on_map");e&&e.addEventListener("click",this.showOnMap)},this.addLoading=()=>{const e=document.getElementById("stock_map");e?.classList.add("--loading")},this.removeLoading=()=>{const e=document.getElementById("stock_map");e?.classList.remove("--loading")},this.init=e=>{this.addLoading(),this.vars.initOptions=e||{},this.getStock(),this.vars.stock.id?this.initMap():this.removeLoading()},this.initEvents()};app_shop.run((function(){app_shop.fn.stockSite=new StockSite,app_shop.fn.stockSite.googleVars.key=window.google_api_key}),"all","#stock_map");