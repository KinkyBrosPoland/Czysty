class DeliveriesCOP extends COPModules{constructor(e={}){super(e),this.elementsMap=new WeakMap,this.icons={online:"/gfx/standards/online_delivery.png"}}getLocale(){for(let e=0;e<7;e++){let t=new Date(0,0,e).toLocaleString(this.language,{weekday:"short"});t=`${t.charAt(0).toUpperCase()}${t.substring(1,t.length)}`,this.locale.shortWeekdays.push(t)}}prepareDataToUpdateTime(e){const t=e.closest(`.${this.prefix}_deliveries__block`);if(!t)return!1;const i=e.querySelector(`.${this.prefix}_delivery__time_value`),r=e.querySelector(`.${this.prefix}_delivery__date.--active`);if(!i&&!r)return!1;const s=i?i.textContent:super.getFormattedDate(r.getAttribute("data-date")),l=!!t.classList.contains("--now"),n=!this.vars.settings?.orderDivisionEnabled;if(l){return{now:{dateFormatted:s,pickup:!("0"!==e.getAttribute("data-id"))},hideLater:n}}return{later:{dateFormatted:s},hideLater:n}}selectDeliveryTimeLabel(e){const t=e.querySelector(`.${this.prefix}_delivery__time_value`);if(!t)return;const i=e.querySelector(`.${this.prefix}_delivery__date.--active`);if(!i)return;const r=i.getAttribute("data-date"),s=super.getFormattedDate(r);t.textContent=s}async getAddress(e){const t=document.querySelector(this.vars.formSelector),i=new FormData(t),r=i.get("delivery_street"),s=i.has("delivery_street_number")?` ${i.get("delivery_street_number")}`:"",l=this.vars.googleApiKey?i.get("delivery_zipcode"):"",n=i.get("delivery_city");if(r&&""!==r||l&&""!==l||n&&""!==n)return`${r}${s}, ${l} ${n}`;const a=i.get("client_street"),o=i.has("client_street_number")?` ${i.get("client_street_number")}`:"",c=this.vars.googleApiKey?i.get("client_zipcode"):"",d=i.get("client_city");if(a&&""!==a||c&&""!==c||d&&""!==d)return`${a}${o}, ${c} ${d}`;if(this.currentAddress)return this.currentAddress;e.classList.add("--loading");const p=await this.fetchData({data:this.queries.CLIENT(),linkParameter:`?query=copModulesClient&type=${this.type}`,alert:!1});e.classList.remove("--loading");const{deliveryAddresses:h=[]}=p?.data?.client||{};if(!h.length)return!1;const u=h.find((e=>e.isDefault))||h[0];return this.currentAddress=`${u.street}, ${this.vars.googleApiKey?u.zipcode:""} ${u.city}`,this.currentAddress}addSelectedClasses(e,t){const i=e.closest(`.${this.prefix}_deliveries__block`);if(!i)return;i.querySelectorAll(`.${this.prefix}_delivery`).forEach((e=>{const t=e.querySelector(`.${this.prefix}_delivery__input`);t&&(t.checked?e.classList.add("--checked"):e.classList.remove("--checked"))})),t||this.scrollToElement({element:i});if(!i.querySelector(`.${this.prefix}_delivery__input:checked`))return void i.classList.remove("--selected");i.classList.add("--selected");const r=i.querySelector(`.${this.prefix}_deliveries__label`);i.classList.contains("--later")?this.changeLabelLiteral({labelElement:r,division:"later",selected:!0}):this.changeLabelLiteral({labelElement:r,selected:!0})}disableInputs(e){const t=e.closest(`.${this.prefix}_deliveries__block`);if(!t)return;t.querySelectorAll(`.${this.prefix}_delivery__input`).forEach((e=>{e.parentNode.querySelectorAll(`input:not(.${this.prefix}_delivery__input):not(.--disabled), select:not(.--disabled)`).forEach((t=>{const{nextElementSibling:i}=t;if(e.checked)return t.disabled=!1,void(i?.classList?.contains("f-dropdown-toggle")&&i.classList.remove("--disabled"));t.disabled=!0,i?.classList?.contains("f-dropdown-toggle")&&i.classList.add("--disabled")}))}))}generateOptionElement(e){const{id:t,name:i,selectedForPrice:r,pointsEnabled:s,division:l}=e,{value:n,formatted:a}=e.price,{value:o,formatted:c}=e.pointCost;let d=`\n      <option\n        value="${t}"\n        data-price="${n}"\n        data-price-formatted="${a}"${r?'selected="selected"':""}\n      >${i} ${0!==n?`+${a}`:""}</option>\n    `;return l||s&&0!==o&&(d+=`\n        <option\n          value="${t}"\n          data-price="${o}"\n          data-price-formatted="${c}"\n          data-points="${s}"\n        >${i} +${c}</option>\n      `),d}setForPointsCheckbox(e,t){const i=e.querySelector(`.${this.prefix}_delivery__points`);if(!i)return;const r=i.querySelector(`.${this.prefix}_delivery__points_input`);if(!r)return;if(e.getAttribute("data-id")===t.getAttribute("data-value").split("-")[0])return r.disabled=!1,void i.classList.remove("--hidden");r.disabled=!0,i.classList.add("--hidden")}dropdownServicesCallback(e,t){const i=e.querySelector(`.${this.prefix}_delivery__services_wrapper`),r=+t.getAttribute("data-price"),s=t.getAttribute("data-price-formatted"),l=t.getAttribute("data-points");e.querySelector(`.${this.prefix}_delivery__date.--active .${this.prefix}_delivery__date_cost`).textContent=0!==r?`+${s}`:"";const n=e.closest(`.${this.prefix}_deliveries__block`).classList.contains("--later")?"_division":"";this.setForPointsCheckbox(e,t);const a=e.querySelector(`input[name="calendar_services_points${n}"]`);if(!l||!a){if(l&&!a){const e=document.createElement("input");return e.type="hidden",e.name=`calendar_services_points${n}`,e.value="1",void i.appendChild(e)}a&&a.parentNode.removeChild(a)}}generateAvailableServices(e,t){const i=e.querySelector(`.${this.prefix}_delivery__calendar_services`);if(!i)return;if("input"===t.type)return void i.parentNode.removeChild(i);const r=e.querySelector(`.${this.prefix}_delivery__services_wrapper`),s=e.querySelector(`.${this.prefix}_delivery__date.--active .${this.prefix}_delivery__date_cost`);if(!s)return;const{availableServices:l}=t;if(!l)return void i.classList.add("--no-service");i.classList.remove("--no-service");const n=e.closest(`.${this.prefix}_deliveries__block`).classList.contains("--later")?"_division":"",a=e.querySelector(`.${this.prefix}_delivery__input`)?.value;if(1===l.length){i.classList.add("--one-service");const{id:e}=l[0],{value:t,formatted:o}=l[0].price;return r.innerHTML=`\n        <input type="hidden" name="calendar_shipping${n}" value="${a}"/>\n        <input type="hidden" name="calendar_services${n}" value="${e}"/>`,void(s.textContent=0!==t?`+${o}`:"")}i.classList.remove("--one-service"),r.innerHTML=`\n      <input type="hidden" name="calendar_shipping${n}" value="${a}"/>\n      <select name="calendar_services${n}" class="${this.prefix}_delivery__services_select f-select --small">\n        ${l.map((e=>(e.division=this.vars.settings?.orderDivisionEnabled,this.generateOptionElement(e)))).join("")}\n      </select>\n    `,this.dropdownServices=new SelectToDropdown({selector:`.${this.prefix}_delivery__services_select:not(.f-dropdown)`,afterClickDropdownCallback:t=>{const i=t.querySelector(".f-dropdown-item");this.dropdownServicesCallback(e,i),i.classList.contains("--not-update")?i.classList.remove("--not-update"):this.callbacks.updateCost?.()},generateDropdownCallback:t=>{const i=t.querySelector(".f-dropdown-item.--selected");i&&this.dropdownServicesCallback(e,i)}})}generateServicesDates(e,t){const i=e.querySelector(`.${this.prefix}_delivery__calendar`);if(!i)return;if(!t?.data?.courierServices?.calendar)return void i.parentNode.removeChild(i);const r=e.querySelector(`.${this.prefix}_delivery__dates`);if(!r)return;const s=r.querySelector(`.${this.prefix}_delivery__date.--other`);s&&r.removeChild(s);const l=i.querySelector(`.${this.prefix}_delivery__calendar_hours`);l&&l.parentNode.removeChild(l);const{calendar:n}=t.data.courierServices;n.forEach(((t,i)=>{const{year:s,month:l,day:n}=t.date,a=this.generateDate(new Date(`${s}/${l}/${n}`));if(r.appendChild(a),0===i){a.classList.add("--active"),this.generateAvailableServices(e,t);const i=e.querySelector(`.${this.prefix}_delivery__calendar_input`);i&&(i.value=a.getAttribute("data-date"))}this.elementsMap.set(a,t)}))}async services(e){if(e.classList.contains("--services-loaded"))return;const t=e.getAttribute("data-company-key");if(!t)return;const i=e.getAttribute("data-company-group-key");if(!i)return;const r=e.getAttribute("data-prepaid");this.deliveriesElement.classList.add("--loading");const s=await this.fetchData({data:this.queries.SERVICES(`\n        courierKey: "${t}",\n        courierGroupKey: "${i}",\n        prepaid: ${r}\n      `),linkParameter:`?query=copModulesServices&type=${this.type}`});this.deliveriesElement.classList.remove("--loading"),e.classList.add("--services-loaded"),this.generateServicesDates(e,s)}setClientCourierNumber({deliveryElement:e,clientCourierNumber:t}){const i=e.querySelector(`.${this.prefix}_delivery__client_courier_number`);if(!i)return;const r=e.querySelector(`.${this.prefix}_delivery__client_courier_number_value`),s=e.querySelector(`.${this.prefix}_delivery__client_courier_number_input`);if(r&&s){if(!t)return s.disabled=!0,s.value="",r.textContent="",void i.classList.remove("--active");s.disabled=!1,s.value=t,r.textContent=t,i.classList.add("--active")}else i.classList.remove("--active")}setInputsPickupPoint({selectedPoint:e,deliveryElement:t}){const{name:i,id:r,address:{buildingAndHouseNumber:s,street:l,postcode:n,city:a}={},coordinates:{latitude:o,longitude:c}={}}=e,d=t.querySelector(`.${this.prefix}_delivery__pickup_input`);d&&(d.value=r);const p=t.querySelector('input[name^="pickup_point_name"]');p&&(p.value=i||r);const h=t.querySelector('input[name^="pickup_point_street"]');h&&(h.value=s?`${l} ${s}`:l);const u=t.querySelector('input[name^="pickup_point_city"]');u&&(u.value=a);const v=t.querySelector('input[name^="pickup_point_zipcode"]');v&&(v.value=n);const _=t.querySelector('input[name^="pickup_point_lat"]');_&&(_.value=o);const y=t.querySelector('input[name^="pickup_point_lng"]');y&&(y.value=c)}setTextsPickupPoint({deliveryElement:e,selectedPoint:t}){const{id:i,address:{buildingAndHouseNumber:r,street:s,postcode:l,city:n}={}}=t,a=e.querySelector(`.${this.prefix}_delivery__pickup_name`);a&&(a.textContent=i);const o=e.querySelector(`.${this.prefix}_delivery__pickup_street`);o&&(o.textContent=r?`${s} ${r}`:s);const c=e.querySelector(`.${this.prefix}_delivery__pickup_city`);c&&(c.textContent=`${l} ${n}`);const d=e.querySelector(`.${this.prefix}_delivery__pickup_other`);d&&this.elementsMap.set(d,t)}async afterSelectPickupPoint(e,t,i){if(!e)return;const{id:r,elementCallback:s,clientCourierNumber:l}=e,n=s;n&&(n.setAttribute("data-selected-point",r),this.setInputsPickupPoint({selectedPoint:e,deliveryElement:n}),this.setTextsPickupPoint({selectedPoint:e,deliveryElement:n}),this.setClientCourierNumber({deliveryElement:n,clientCourierNumber:l}),t||this.scrollToElement({element:n}),i||this.saveSelectedPickupPoint({deliveryElement:n,selectedPoint:e}),i||this.callbacks.afterChangePickup?.(e))}noShippingMethods(e){e.innerHTML="";const t=document.getElementById(`${this.prefix}_deliveries_non_standardized`)?.content.cloneNode(!0);if(!t)return void e.appendChild(this.createInfo(this.txt["Brak dostępnych kurierów"]));const{active:i=!1,isAllowed:r=!1,courierId:s}=this.vars.nonStandardized;if(i&&r){const i=t.querySelector("input");return i&&(i.value=`${s}-1`),void e.appendChild(t)}e.appendChild(this.createInfo(this.txt["Brak dostępnych kurierów"]))}isDvpDelivery(){if(!this.vars.shipping.filter((e=>"dvp"===e.prepaid)).length)return;const e=this.vars.shipping.filter((e=>"later"===e.availability&&"dvp"===e.prepaid));if(this.vars.settings?.orderDivisionEnabled&&!e.length)return;const t=super.getFormDataFromSessionStorage(),i=!this.vars.shipping.find((e=>"prepaid"===e.prepaid));this.selectedDelivery?.now?.prepaid?this.callbacks.dvpPayment?.("dvp"===this.selectedDelivery?.now?.prepaid,i):t?.shipping?this.callbacks.dvpPayment?.("0"===t?.shipping?.split("-")[1],i):this.callbacks.dvpPayment?.("0"===this.vars.settings?.checked?.split("-")[1],i)}minworthDelivery(e,t){const i=t.querySelector(`.${this.prefix}_delivery__minworth`);if(!i)return;if(e?.minworthReached)return void i.parentNode.removeChild(i);const r=t.querySelector(`.${this.prefix}_delivery__time`);r&&r.parentNode.removeChild(r);const s=t.querySelector(`.${this.prefix}_delivery__select_day`);s&&s.parentNode.removeChild(s);const l=t.querySelector(`.${this.prefix}_delivery__pickup`);l&&l.parentNode.removeChild(l);const n=t.querySelector(`.${this.prefix}_delivery__minworth_value`);n&&(n.textContent=e?.minworth?.formatted);const a=t.querySelector('input[name="shipping"]')||t.querySelector('input[name="shipping_division"]');a&&(a.disabled=!0)}selectDayDelivery(e,t,i){const r=t.querySelector(`.${this.prefix}_delivery__select_day`);if(!r)return;if(!e?.courier?.companyGroupKey)return void r.parentNode.removeChild(r);const s=t.querySelector(`.${this.prefix}_delivery__time`);s&&s.parentNode.removeChild(s);const l=t.querySelector(`.${this.prefix}_delivery__minworth`);l&&l.parentNode.removeChild(l);const n=t.querySelector(`.${this.prefix}_delivery__pickup`);n&&!e?.courier?.pickupPoint&&n.parentNode.removeChild(n);const a=t.firstChild;a&&(a.setAttribute("data-company-key",e?.courier?.companyKey),a.setAttribute("data-company-group-key",e?.courier?.companyGroupKey))}commentDelivery(e,t){const i=t.querySelector(`.${this.prefix}_delivery__comment`);if(!i)return;if(!e?.comment||""===e?.comment)return void i.parentNode.removeChild(i);const r=super.decodeGraphQLHTMLString(e?.comment);i.innerHTML=r}timeDelivery(e,t){if(!t.querySelector(`.${this.prefix}_delivery__time`))return;const i=t.querySelector(`.${this.prefix}_delivery__time_label`);0===e?.courier?.id&&i&&(i.textContent=`${this.txt["Odbierz zamówienie"]} - `);const r=t.querySelector(`.${this.prefix}_delivery__time_value`);if(!r)return;const{today:s}=e?.deliveryTime;if(s)return void([r.textContent]=this.locale.weekdays);const{weekDay:l,weekAmount:n}=e?.deliveryTime;if(n>0){const{days:t}=e?.deliveryTime?.time,{day:i,month:s}=this.calculateDate({days:t});r.textContent=`${this.locale.weekdays[l]} (${i}.${s})`}else r.textContent=this.locale.weekdays[l]}pickupDelivery(e,t){const i=t.querySelector(`.${this.prefix}_delivery__pickup`);if(!i)return;if(0!==e?.courier?.id&&!e?.courier?.pickupPoint)return void i.parentNode.removeChild(i);t.firstChild.classList.add("--pickup");const r=t.querySelector(`.${this.prefix}_delivery__pickup_input`);r&&0===e?.courier?.id&&(r.name="stock")}pointsDelivery(e,t,i){const r=t.querySelector(`.${this.prefix}_delivery__points`);if(!r)return;if(!e.pointsSelected||0===e.pointsCost?.value||this.vars.settings?.orderDivisionEnabled)return void r.parentNode.removeChild(r);const s=`for_points${i?"_division":""}_${e?.courier?.fullId||`${e?.courier?.id}-${"dvp"===e?.prepaid?"0":"1"}`}`,l=r.querySelector(`.${this.prefix}_delivery__points_input`);if(!l)return;l.id=s;const n=r.querySelector(".f-label");n&&(n.setAttribute("for",s),n.textContent=`${e.pointsCost?.value} ${this.txt.pkt}.`,e.pointsEnabled||(l.disabled=!0,l.classList.add("--disabled")))}costDelivery(e,t){const i=t.querySelector(`.${this.prefix}_delivery__cost`);i&&(i.textContent=0!==e?.cost?.value?e?.cost?.formatted:`${this.txt.Gratis}!`,e?.cost?.value&&0!==e?.cost?.value&&i.classList.add("--plus"))}generateDate(e){const t=document.getElementById(`${this.prefix}_deliveries_date`)?.content.cloneNode(!0);if(!t)return document.createElement("div");if(!e)return document.createElement("div");const i=e.getDate()<10?`0${e.getDate()}`:e.getDate(),r=e.getMonth()+1<10?`0${e.getMonth()+1}`:e.getMonth()+1,s=`${e.getFullYear()}-${r}-${i}`;t.firstChild.setAttribute("data-date",s);const l=t.querySelector(`.${this.prefix}_delivery__date_day`);if(l){const t=this.locale.shortWeekdays[e.getDay()];l.textContent=`${t} ${i}.${r}`}return t.firstChild}generateDates(e,t){const{days:i}=e?.deliveryTime?.time,{day:r,month:s,year:l}=this.calculateDate({days:i}),n=e?.workingDays;if(!n?.length){const e=t.querySelector(`.${this.prefix}_delivery__calendar`);return e.innerHTML="",void e.appendChild(this.createInfo(this.txt["Brak dostępnych terminów"]))}const a=new Date(`${l}/${s}/${r}`),o=t.querySelector(`.${this.prefix}_delivery__dates`);for(let e=0;e<5;e++){let i=!0;for(;i;){const e=a.getDate()<10?`0${a.getDate()}`:a.getDate(),t=a.getMonth()+1<10?`0${a.getMonth()+1}`:a.getMonth()+1,r=`${a.getFullYear()}-${t}-${e}`,s=0===a.getDay()?7:a.getDay(),l=n.find((e=>e===s)),o=this.vars.holidays.find((e=>e.formatted===r));if(l&&!o){i=!1;break}a.setDate(a.getDate()+1)}const r=this.generateDate(a);if(0===e){r.classList.add("--active");const e=t.querySelector(`.${this.prefix}_delivery__calendar_input`);e&&(e.value=r.getAttribute("data-date"))}o&&o.appendChild(r),a.setDate(a.getDate()+1)}o.appendChild(o.querySelector(`.${this.prefix}_delivery__date.--other`))}calendarDelivery(e,t,i){const r=t.querySelector(`.${this.prefix}_delivery__calendar`);if(!r)return;if(!e?.calendar&&!e?.courier?.companyGroupKey)return void r.parentNode.removeChild(r);if(0===e?.courier?.id)return void r.parentNode.removeChild(r);if(e?.courier?.companyGroupKey){const e=r.querySelector(`.${this.prefix}_delivery__datepicker`);return void(e&&e.parentNode.removeChild(e))}const s=t.querySelector(`.${this.prefix}_delivery__calendar_services`);s&&s.parentNode.removeChild(s),e?.calendar&&this.generateDates(e,t);const{days:l}=e?.deliveryTime?.time,{day:n,month:a,year:o}=this.calculateDate({days:l});r.setAttribute("data-first-date",`${o}-${a}-${n}`),r.setAttribute("data-working-days",e?.workingDays);const c=t.querySelector(`.${this.prefix}_delivery__calendar_hours`);c&&"days_and_hours"!==e?.calendarOption&&c.parentNode.removeChild(c)}changeDivisionInputsName(e){e.querySelectorAll("input, select").forEach((e=>{const t=e.getAttribute("name");t&&e.setAttribute("name",`${t}_division`)}))}getDelivery(e,t){const i=document.getElementById(`${this.prefix}_deliveries_item`)?.content.cloneNode(!0);if(!i)return document.createElement("div");i.firstChild.setAttribute("data-id",e?.courier?.id),i.firstChild.setAttribute("data-prepaid",e?.prepaid);const r=e?.courier?.fullId||`${e?.courier?.id}-${"dvp"===e?.prepaid?"0":"1"}`,s=i.querySelector('input[name^="shipping"]');s&&(s.value=r,s.id=t?`delivery_division_${r}`:`delivery_${r}`);const l=i.querySelector(`label.${this.prefix}_delivery__label`);l&&l.setAttribute("for",t?`delivery_division_${r}`:`delivery_${r}`);const n=i.querySelector(`img.${this.prefix}_delivery__icon`);n&&(n.alt=`${this.txt["Metoda dostawy"]}: ${e?.courier?.name}`,n.src=93!==e?.courier?.id||e?.courier?.icon?e?.courier?.icon:this.icons.online);const a=i.querySelector(`.${this.prefix}_delivery__name`);return a&&(a.textContent=e?.courier?.name),this.minworthDelivery(e,i),this.selectDayDelivery(e,i,t),this.commentDelivery(e,i),this.timeDelivery(e,i),this.pickupDelivery(e,i),this.pointsDelivery(e,i,t),this.costDelivery(e,i),this.calendarDelivery(e,i),t&&this.changeDivisionInputsName(i),i}isLastDelivery(e,t){const{prepaid:i}=e,{id:r,fullId:s}=e.courier,l=t.filter((e=>e.prepaid===i));if(s){return s===l[l.length-1].courier.fullId}return r===l[l.length-1].courier.id}changeLabelLiteral(e){const{labelElement:t,division:i,selected:r}=e||{};t&&(t.innerHTML="later"===i&&r?`${this.txt["Wybrano opcję dostawy dla przesyłki 2 z 2"]}\n        <a href="#changeDivision" class="${this.prefix}_deliveries__label_link --now">\n          ${this.txt["Wybierz opcję dostawy dla przesyłki 1 z 2"]}:\n        </a>`:"later"!==i?r?`${this.txt["Wybrano opcję dostawy dla przesyłki 1 z 2"]}\n        <a href="#changeDivision" class="${this.prefix}_deliveries__label_link --later">\n          ${this.txt["Wybierz opcję dostawy dla przesyłki 2 z 2"]}:\n        </a>`:`${this.txt["Wybierz opcję dostawy dla przesyłki 1 z 2"]}:`:`${this.txt["Wybierz opcję dostawy dla przesyłki 2 z 2"]}:`)}deliveriesLabel(e,t){const i=e.querySelector(`.${this.prefix}_deliveries__label`);i&&(this.vars.settings?.orderDivisionEnabled?t?this.changeLabelLiteral({labelElement:i,division:"later"}):this.changeLabelLiteral({labelElement:i}):i.parentNode.removeChild(i))}changeDeliveryVisibleset(e,t=[]){const i=e.querySelector(`.${this.prefix}_deliveries__change_link`);i&&(t.length>1?i.classList.remove("--hidden"):i.classList.add("--hidden"))}deliveriesBlockDeliveries(e,t){const i=e.querySelector(`.${this.prefix}_deliveries__section`);if(!i)return;if(!this.vars.shipping.length)return void this.noShippingMethods(i);if(!this.vars.settings?.orderDivisionEnabled){if(this.vars.shipping.forEach((e=>{const t=this.getDelivery(e);this.elementsMap.set(t.firstChild,e);this.isLastDelivery(e,this.vars.shipping)&&t.firstChild.classList.add("--last"),i.appendChild(t)})),"order2"!==this.type)return;const t=this.deliveriesElement.querySelector(`.${this.prefix}__title`);if(!t)return;return t.textContent=this.txt["Opcje dostawy"],t.classList.add("--show"),void this.changeDeliveryVisibleset(e,this.vars.shipping)}const r=t?this.vars.shipping.filter((e=>"later"===e.availability)):this.vars.shipping.filter((e=>"now"===e.availability));r.forEach((e=>{const s=this.getDelivery(e,t);this.elementsMap.set(s.firstChild,e);this.isLastDelivery(e,r)&&s.firstChild.classList.add("--last"),i.appendChild(s)})),this.changeDeliveryVisibleset(e,r)}deliveriesBlock(e){const t=document.getElementById(`${this.prefix}_deliveries_block`)?.content.cloneNode(!0);t&&(this.deliveriesLabel(t,e),this.deliveriesBlockDeliveries(t,e),t.firstChild.classList.add(e?"--later":"--now"),this.deliveriesElement.appendChild(t))}calendarFindDateElement(e,t){if(!e||!t)return;const i=e.querySelector(`.${this.prefix}_delivery__date[data-date="${t}"]`);if(i)return void this.onClickSelectDateCalendar(i,!0);const r=e.querySelector(`.${this.prefix}_delivery__date:last-child`);if(!r)return;const s=this.generateDate(new Date(t.replace(/-/g,"/")));r.replaceWith(s),this.onClickSelectDateCalendar(s,!0)}calendarFindHourElement(e,t){if(!e||!t)return;const i=e.querySelector(`.${this.prefix}_delivery__hours .f-dropdown-item[data-value="${t}"]`);i&&i.click()}calendarFindServiceElement(e,t,i){if(!e||!t)return;const r=i?e.querySelector(`.${this.prefix}_delivery__calendar_services .f-dropdown-item[data-value="${t}"][data-points]`):e.querySelector(`.${this.prefix}_delivery__calendar_services .f-dropdown-item[data-value="${t}"]`);r&&(r.classList.add("--not-update"),r.click())}calendarAfterSelectDate(e,t){if(!t.length)return;const i=e.target.closest(`.${this.prefix}_delivery__datepicker`);if(!i)return;i.classList.remove("--active");const r=i.closest(`.${this.prefix}_delivery`);r&&this.calendarFindDateElement(r,t[0])}calendarDays(){this.deliveriesElement.querySelectorAll(`.${this.prefix}_delivery__datepicker`).forEach((e=>{const t=e.closest(`.${this.prefix}_delivery__calendar`);if(!t)return;const i=t.getAttribute("data-first-date"),r=t.getAttribute("data-working-days").split(",").map((e=>7===+e?0:+e)),s=[];this.vars.holidays.forEach((e=>{s.push(e.formatted)})),this.elementsMap.set(e,{calendar:new VanillaCalendar(e,{date:{min:i,today:new Date(i.replace(/-/g,"/"))},settings:{workingDays:r,selected:{dates:[i],holidays:s}},actions:{clickDay:(e,t)=>this.calendarAfterSelectDate(e,t)}})}),this.elementsMap.get(e).calendar.init()}))}calendarHours(){this.calendarHoursSelect=new SelectToDropdown({selector:`.${this.prefix}_delivery__hours:not(.f-dropdown)`,generateDropdownCallback:e=>{e.querySelector(".f-dropdown-toggle").setAttribute("tabindex","-1")}})}calendar(){this.deliveriesElement.querySelectorAll(`.${this.prefix}_delivery__calendar`).length&&(this.calendarDays(),this.calendarHours())}loadingDeliveries(){this.deliveriesElement.classList.add("--loading-deliveries"),setTimeout((()=>{this.deliveriesElement.classList.remove("--loading-deliveries")}),this.minDelayTime)}dvpChange(e){if(!this.deliveriesElement)return;const t=e||this.getPrepaid();if(this.deliveriesElement.classList.contains("--dvp")&&"dvp"===t)return;if(!this.deliveriesElement.classList.contains("--dvp")&&"prepaid"===t)return;this.deliveriesElement.querySelectorAll(`.${this.prefix}_deliveries__block`).forEach((e=>{e.classList.remove("--selected");const t=e.querySelector(`.${this.prefix}_delivery__input:checked`);if(!t)return;t.checked=!1;const i=t.closest(`.${this.prefix}_delivery`);i&&(i.classList.remove("--checked"),this.disableInputs(e))})),this.loadingDeliveries(),this.deliveriesElement.classList.toggle("--dvp","dvp"===t)}changeDivision(e){const{division:t}=e||{};this.loadingDeliveries(),t&&"now"!==t?this.deliveriesElement.classList.add("--later"):this.deliveriesElement.classList.remove("--later")}saveSelectedPickupPoint({deliveryElement:e,selectedPoint:t}){const i=e.closest(`.${this.prefix}_deliveries__block`);if(!i)return;const r=i.classList.contains("--later")?"later":"now";this.selectedDelivery||(this.selectedDelivery={}),this.selectedDelivery[r]||(this.selectedDelivery[r]={}),this.selectedDelivery[r].selectedPoint=t,this.selectedPoint=t}saveSelectedDelivery(e){this.selectedDelivery||(this.selectedDelivery={});if(!e.querySelector(`.${this.prefix}_delivery__input`))return;const t=e.closest(`.${this.prefix}_deliveries__block`);if(!t)return;const{id:i,prepaid:r}=e.dataset,s=t.classList.contains("--later")?"later":"now";this.selectedDelivery[s]={},this.selectedDelivery[s].id=i,this.selectedDelivery[s].prepaid=r}getPrepaid(){const e=document.querySelector(this.vars.formSelector);if(this.vars.formSelector&&e){return"cash"===new FormData(e).get("selected_group_only")?"dvp":"prepaid"}return this.deliveriesElement.classList.contains("--dvp")?"dvp":"prepaid"}findSelectedDeliveryElement(e,t){const i=this.getPrepaid(),r=e.querySelectorAll(`.${this.prefix}_delivery[data-prepaid="${i}"]`);if(1===r.length)return e.classList.add("--one-option"),r[0];e.classList.remove("--one-option");const s=e.classList.contains("--later")?"later":"now",{shipping:l,shipping_division:n,calendar_shipping:a}=t,o=this.selectedDelivery?.[s]?.id,c="later"===s?n?.split("-")[0]:l?.split("-")[0],d=a?.split("-")[0],p=this.vars.settings.checked?.split("-")[0];return e.querySelector(`.${this.prefix}_delivery[data-id="${o}"][data-prepaid="${i}"]`)||e.querySelector(`.${this.prefix}_delivery[data-id="${c}"][data-prepaid="${i}"]`)||e.querySelector(`.${this.prefix}_delivery[data-id="${d}"][data-prepaid="${i}"]`)||e.querySelector(`.${this.prefix}_delivery[data-id="${p}"][data-prepaid="${i}"]`)}getPickupPointFromSettings(e){const{selectedPickup:t}=this.vars.settings||{};return!!t&&(null!==t.courierId&&+t.courierId===+e&&t)}getPickupPointFromSession(e,t){const i=e?"_division":"",r=t[`pickup_point${i}`],s=t[`stock${i}`];return!(!r&&!s)&&{id:r||s,name:t[`pickup_point_name${i}`],address:{street:t[`pickup_point_street${i}`],postcode:t[`pickup_point_zipcode${i}`],city:t[`pickup_point_city${i}`]},coordinates:{latitude:t[`pickup_point_lat${i}`],longitude:t[`pickup_point_lng${i}`]}}}selectDefaultPickupPoint(e,t){const i=e.closest(".--later")?"later":"now",r=this.getPickupPointFromSettings(e.dataset.id),s=this.getPickupPointFromSession("later"===i,t),l=this.selectedDelivery?.[i]?.selectedPoint||s||r;l&&(l.elementCallback=e,this.selectedPoint=l),this.afterSelectPickupPoint(l,!0)}selectDefaultCalendar(e,t){if("later"===(e.closest(".--later")?"later":"now")){const{calendar_select_date_division:i,calendar_select_hour_division:r,calendar_services_division:s,calendar_services_points_division:l}=t;return this.calendarFindDateElement(e,i),this.calendarFindHourElement(e,r),void this.calendarFindServiceElement(e,s,l)}const{calendar_select_date:i,calendar_select_hour:r,calendar_services:s,calendar_services_points:l}=t;this.calendarFindDateElement(e,i),this.calendarFindHourElement(e,r),this.calendarFindServiceElement(e,s,l)}selectDefaultForPoints(e,t){const{shipping_for_points:i}=t;if(!i)return;const r=e.querySelector(`.${this.prefix}_delivery__points_input`);r&&(r.checked=!0)}async selectingDefaultDeliveries(){if(!this.vars.selectDefault&&!this.selectedDelivery)return;const e=super.getFormDataFromSessionStorage(),t=[...this.deliveriesElement.querySelectorAll(`.${this.prefix}_deliveries__block`)].map((async t=>{const i=this.findSelectedDeliveryElement(t,e);if(!i)return;const r=i.querySelector(`.${this.prefix}_delivery__input`);r&&(r.checked=!0,await this.onChangeSelectDelivery({target:r,notPickup:!0,notUpdate:!0,notScroll:!0,notSave:!0}),this.selectDefaultPickupPoint(i,e),this.selectDefaultCalendar(i,e),this.selectDefaultForPoints(i,e))}));await Promise.all(t),this.dvpChange(),this.initSummary()}removeChecked(e){const t=e.querySelector(`input.${this.prefix}_delivery__input:checked`);if(!t)return;t.checked=!1;const i=t.closest(`.${this.prefix}_delivery`);if(!i)return;i.classList.remove("--checked"),this.disableInputs(i);const r=e.querySelector(`.${this.prefix}_deliveries__label`);e.querySelectorAll(`.${this.prefix}_deliveries__item`).forEach((e=>{const t=e.querySelector(`.${this.prefix}_deliveries__change_delivery`);this.removeWcagAttributes(e,!0),t?.setAttribute("tabindex","-1"),t?.setAttribute("aria-hidden","true")})),e.classList.contains("--later")?this.changeLabelLiteral({labelElement:r,division:"later"}):this.changeLabelLiteral({labelElement:r})}initSummary(){this.debounces.updateCost?.()}onClickHideCalendar(e){const{target:t}=e;if(t.closest(`.${this.prefix}_delivery__other_link`))return;if(!t.closest(`.${this.prefix}_delivery__datepicker`)){const e=document.querySelector(`.${this.prefix}_delivery__datepicker.--active`);e&&e.classList.remove("--active");const i=t.closest(`.${this.prefix}_delivery`);if(!i)return;i.classList.remove("--calendar-opened")}}onClickOpenCalendar(e){const t=e.parentNode.querySelector(`.${this.prefix}_delivery__datepicker`);if(!t)return;t.classList.toggle("--active");const i=t.querySelector(".vanilla-calendar-day__btn_today");i&&i.classList.remove("vanilla-calendar-day__btn_today");const r=e.closest(`.${this.prefix}_delivery`);r&&r.classList.toggle("--calendar-opened")}onClickSelectDateCalendar(e,t){const i=e.closest(`.${this.prefix}_delivery`);if(!i)return;const r=i.querySelector(`.${this.prefix}_delivery__date.--active`),s=e.closest(`.${this.prefix}_delivery__date`);if(r===s)return;r&&r.classList.remove("--active"),s.classList.add("--active");const l=this.elementsMap.get(s);l&&(this.generateAvailableServices(i,l),t||this.debounces.updateCost());const n=s.getAttribute("data-date"),a=i.querySelector(`.${this.prefix}_delivery__calendar_input`);a&&(a.value=n);const o=i.querySelector(`.${this.prefix}_delivery__datepicker`);if(o){const{calendar:e}=this.elementsMap.get(o);if(!e)return;e.date.today=new Date(n.replace(/-/g,"/")),e.settings.selected.dates=[n],e.update()}this.selectDeliveryTimeLabel(i);const c=this.prepareDataToUpdateTime(i);this.callbacks.updateTime?.(c)}async onClickOpenPickup(e){const t=e.closest(`.${this.prefix}_delivery`);if(!t)return;if(!t.classList.contains("--pickup"))return;if(e.classList.contains(`${this.prefix}_delivery__input`)&&t.hasAttribute("data-selected-point"))return;const i=t.querySelector(`.${this.prefix}_delivery__input`);i&&!i.checked&&(i.checked=!0,this.onChangeSelectDelivery({target:i,notPickup:!0}));const r=t.getAttribute("data-id"),s=t.getAttribute("data-prepaid"),l="dvp"===s,n=this.afterSelectPickupPoint.bind(this),a=t.querySelector(`.${this.prefix}_delivery__pickup_other`),o=this.elementsMap.get(a),{coordinates:{latitude:c,longitude:d}={}}=o||{},p=!o&&await this.getAddress(t),h=this.elementsMap.get(t),{cost:{value:u,formatted:v}={}}=h||{};this.vars.pickup?.init?.({lat:c,lng:d,address:p,cashOnDelivery:l,elementCallback:t,callback:n,couriers:[{id:r,fullId:`${r}-${"dvp"===s?"0":1}`,price:{value:u,formatted:0===u?this.txt.Gratis:v}}],googleApiKey:this.vars.googleApiKey})}onClickChangeDelivery(e){const t=e.closest(`.${this.prefix}_deliveries__block`),i=e.closest(`.${this.prefix}_deliveries`);t&&i&&(t.classList.remove("--selected"),this.removeChecked(t),i.classList.contains("--dvp")?t.querySelectorAll(`.${this.prefix}_deliveries__item[data-prepaid="dvp"] .${this.prefix}_deliveries__select_delivery`)?.[0]?.focus():t.querySelectorAll(`.${this.prefix}_deliveries__item[data-prepaid="prepaid"] .${this.prefix}_deliveries__select_delivery`)?.[0]?.focus())}onClickLabelLink(e){if(e.classList.contains("--now")){this.changeDivision({division:"now"});const e=document.querySelector(`.${this.prefix}_products.--division`);if(!e)return;return e.classList.remove("--later"),void e.classList.add("--now")}this.changeDivision({division:"later"});const t=document.querySelector(`.${this.prefix}_products.--division`);t&&(t.classList.remove("--now"),t.classList.add("--later"))}removeWcagAttributes(e,t){e.removeAttribute("aria-hidden");const i=t?`.${this.prefix}_delivery__label a, .${this.prefix}_deliveries__select_delivery`:`a, input:not(.${this.prefix}_delivery__input), button:not(.vanilla-calendar-day__btn_disabled)`;e.querySelectorAll(i).forEach((e=>{e?.removeAttribute("aria-hidden"),e?.removeAttribute("tabindex")}))}setWcagAttributes(e){e.setAttribute("aria-hidden","true"),e.querySelectorAll(`a, input:not(.${this.prefix}_delivery__input), button`).forEach((e=>{e?.setAttribute("tabindex","-1")}))}async onChangeSelectDelivery(e){const{target:t,notPickup:i,notUpdate:r,notScroll:s,notSave:l}=e,n=t.closest(`.${this.prefix}_delivery`),a=t.closest(`.${this.prefix}_deliveries__block`);if(!n||!a)return;this.disableInputs(n),await this.services(n),this.addSelectedClasses(n,s),r||this.debounces.updateCost(),i||this.onClickOpenPickup(t);const o=this.prepareDataToUpdateTime(n);this.callbacks.updateTime?.(o),l||this.saveSelectedDelivery(n),a.querySelectorAll(`.${this.prefix}_deliveries__item`).forEach((e=>{this.setWcagAttributes(e)})),this.removeWcagAttributes(n);const c=n.querySelector(`.${this.prefix}_deliveries__select_delivery`);c?.setAttribute("tabindex","-1"),c?.setAttribute("aria-hidden","true"),this.callbacks.afterChangeDelivery?.(n)}initEvents(){document.addEventListener("click",this.onClickHideCalendar.bind(this),!0),this.deliveriesElement.addEventListener("click",(e=>{const{target:t}=e;if(t.closest(`.${this.prefix}_deliveries__select_delivery`)||t.closest(`.${this.prefix}_deliveries__change_delivery`)){e.preventDefault();const i=t.closest(`.${this.prefix}_deliveries__select_delivery`)||t.closest(`.${this.prefix}_deliveries__change_delivery`),r=i.parentNode.querySelector(`.${this.prefix}_delivery__input`);return i.parentNode.classList.contains("--checked")?void this.onClickChangeDelivery(r):r?(r.checked=!0,void this.onChangeSelectDelivery({target:r})):void 0}if(t.closest(`.${this.prefix}_delivery__other_link`))return e.preventDefault(),void this.onClickOpenCalendar(t);if(t.closest(`.${this.prefix}_delivery__date:not(.--other)`))return e.preventDefault(),void this.onClickSelectDateCalendar(t);if(t.closest(`.${this.prefix}_delivery__pickup_find`)||t.closest(`.${this.prefix}_delivery__pickup_other`))return e.preventDefault(),void this.onClickOpenPickup(t);if(t.closest(`.${this.prefix}_deliveries__change_link`))return e.preventDefault(),void this.onClickChangeDelivery(t);if(t.closest(`.${this.prefix}_deliveries__label_link`))return e.preventDefault(),void this.onClickLabelLink(t);if(t.closest(`.${this.prefix}_deliveries__block:not(.--one-option) .${this.prefix}_delivery.--checked .${this.prefix}_delivery__label`)&&!t.closest(`.${this.prefix}_delivery__points`)){const i=t.closest(`.${this.prefix}_deliveries__block`).querySelector(`.${this.prefix}_deliveries__change_link`);if(!i)return;e.preventDefault(),this.onClickChangeDelivery(i)}})),this.deliveriesElement.addEventListener("change",(e=>{const{target:t}=e;if(t.closest(`.${this.prefix}_delivery__input`))return e.preventDefault(),void this.onChangeSelectDelivery({target:t});t.closest(`.${this.prefix}_delivery__points_input`)&&(e.preventDefault(),this.debounces.updateCost())})),this.deliveriesElement.addEventListener("focus",(e=>{const{target:t}=e;-1!==t.className.indexOf("vanilla-calendar")||t.getAttribute("birth_date")||this.onClickHideCalendar(e)}),!0)}async getPersonalPickupPoints(){return await this.fetchData({data:this.queries.PERSONALPICKUPPOIUNTS(),linkParameter:`?query=copModulesGetPersonalPickupPoints&type=${this.type}`,alert:!1})}async checkPersonalPickupPoint(){const e=this.vars?.shipping?.find((e=>0===e?.courier?.id));if(!e)return;const t=await this.getPersonalPickupPoints(),i=t?.data?.pickupPoints?.pickupPoints;if(!i||1!==i.length)return;this.deliveriesElement.querySelectorAll(`.${this.prefix}_deliveries__item[data-id="0"]`).forEach((e=>{this.afterSelectPickupPoint({...i[0],elementCallback:e},!0,!0),e.querySelector(`.${this.prefix}_delivery__pickup_other`).remove()}))}async generate(){const e=document.getElementById(`${this.prefix}_deliveries_template`)?.content.cloneNode(!0);if(!e||!e.firstChild)return;const t=this.deliveriesElement;if(this.deliveriesElement=e.firstChild,this.elementsMap=new WeakMap,this.deliveriesBlock(),this.vars.settings?.orderDivisionEnabled&&this.deliveriesBlock(!0),this.vars.checkDvp&&this.isDvpDelivery(),this.calendar(),this.selectingDefaultDeliveries(),this.checkPersonalPickupPoint(),this.initEvents(),t&&document.body.contains(t))return t.replaceWith(this.deliveriesElement),void this.calendarHoursSelect?.init?.();super.move({element:this.deliveriesElement,...this.vars.move}),this.calendarHoursSelect?.init?.()}init(e={}){this.type=e.type||app_shop.vars.copModulesType||"order1",this.vars={settings:e.shipping?.settings||{},shipping:e.shipping?.shipping||[],shippingTime:e.shipping?.shippingTime||{},shippingTimeLater:e.shipping?.shippingTimeLater||{},nonStandardized:e.shipping?.nonStandardizedInfo||{},holidays:e.holidays||this.vars?.holidays||[],checkDvp:e.checkDvp??!0,pickup:e.pickup||this.vars?.pickup,selectDefault:e.selectDefault??this.vars?.selectDefault??!1,afterReady:e.afterReady||(()=>{}),move:e.move||this.vars?.move||{},formSelector:e.formSelector??this.vars?.formSelector??!1,googleApiKey:e.googleApiKey||this.vars?.googleApiKey||!1},this.callbacks={updateCost:e.updateCostCallback||this.callbacks?.updateCost,updateTime:e.updateTimeCallback||this.callbacks?.updateTime,dvpPayment:e.dvpPaymentCallback||this.callbacks?.dvpPayment,afterChangeDelivery:e.afterChangeDeliveryCallback||this.callbacks?.afterChangeDelivery,afterChangePickup:e.afterChangePickupCallback||this.callbacks?.afterChangePickup},this.debounces={updateCost:this.debounce(this.callbacks.updateCost?.bind?.(this)||(()=>{}),300)},this.generate(),this.vars.afterReady(this.deliveriesElement)}}try{app_shop.fn.copModulesDeliveries=new DeliveriesCOP,app_shop.vars.copModulesClasses.push((()=>{app_shop.fn.copModulesDeliveries=new DeliveriesCOP}))}catch(e){window?.errorLog?.(e)}