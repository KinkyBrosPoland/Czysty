class SubscrUpcoming extends Subscr{constructor(e={}){super(e)}async renewSubscription(){this.upcomingElement?.classList.add("--loading");const e=await super.fetchData({data:this.queries.CHANGE_STATUS(this.vars.view.id,this.statuses.active),linkParameter:"?mutationy=subscriptionChangeStatus&status=active"}),{status:t}=e?.data?.changeSubscriptionStatus||{};"success"===t?this.callbacks.afterChangeStatus?.():this.upcomingElement?.classList.remove("--loading")}async saveChangeUpcoming({date:e=null,nextDate:t=null}){if(!e&&!t)return;this.changeUpcomingElement.closest(".modal")?.classList.add("--loading"),this.upcomingElement?.classList.add("--loading");const i=this.getChangeDateInputQuery({date:e,nextDate:t});await super.fetchData({data:this.queries.UPDATE_SUBSCRIPTION(i),linkParameter:"?mutation=subscriptionChangeDate"}),this.vars.modal.closeModal(),this.callbacks.afterChangeDate?.()}addDaysToDate(e,t){const i=new Date(`${e}T00:00:00Z`);i.setUTCDate(i.getUTCDate()+t);let s=i.getUTCDate(),n=i.getUTCMonth()+1;return s=s<10?`0${s}`:s,n=n<10?`0${n}`:n,`${i.getUTCFullYear()}-${n}-${s}`}getChangeDateInputQuery({date:e,nextDate:t}){return`subscriptionEditModel: {\n      subscriptionId: ${this.vars.view.id},\n      ${e?`upcomingDeliveryDate: "${e}",`:""}\n      ${t?`nextDeliveryDate: "${t}",`:""}\n    }`}getChangeUpcomingModalElement(){const e=document.getElementById(`${this.prefix}_change_upcoming_template`)?.content.cloneNode(!0);return!(!e||!e.firstChild)&&(this.changeUpcomingElement=e.firstChild,this.initModalLabel(),this.initCalendar(),this.changeUpcomingElement)}setUpcomingDate(){const e=this.upcomingInfoElement.querySelector(`.${this.prefix}_upcoming_info__item.--upcoming .${this.prefix}_upcoming_info__date`);e&&(e.textContent=this.vars.view.upcomingDeliveryDate)}setNextDate(){const e=this.upcomingInfoElement.querySelector(`.${this.prefix}_upcoming_info__item.--next .${this.prefix}_upcoming_info__date`);e&&(e.textContent=this.vars.view.nextDeliveryDate)}getUpcomingInfoModalElement(){const e=document.getElementById(`${this.prefix}_upcoming_info_template`)?.content.cloneNode(!0);return!(!e||!e.firstChild)&&(this.upcomingInfoElement=e.firstChild,this.setUpcomingDate(),this.setNextDate(),this.upcomingInfoElement)}initModalLabel(){if(this.lastOrderShipped)return;const e=this.changeUpcomingElement.querySelector(`.${this.prefix}_change_upcoming__label`);e&&(e.textContent=this.txt["Data kolejnej dostawy"])}initCalendar(){const e=this.changeUpcomingElement.querySelector(`.${this.prefix}_change_upcoming__calendar`);if(!e)return;const{upcomingDeliveryDate:t,nextDeliveryDate:i,subscriptionOptions:{minNextOrderDate:s="",maxNextOrderDate:n="",unavailableDates:a=[]}={}}=this.vars.view,o=[{date:i,class:this.lastOrderShipped?"--package-next":"--package"}];this.lastOrderShipped&&o.push({date:t,class:"--package"});const r=new Date(t),c=new Date(s),l=!this.lastOrderShipped&&c.getTime()<r.getTime()?t:s;this.vars.calendar=new VanillaCalendar(e,{customDayNames:o,date:{min:l,max:n,today:new Date(this.lastOrderShipped?t:i)},settings:{range:{disabled:a},selected:{dates:[this.lastOrderShipped?t:i]}},actions:{afterFocus:(e,t)=>{e&&e.selectedDates?.length&&"day"===t&&this.changeUpcomingElement.querySelector(`.${this.prefix}_change_upcoming__button`)?.focus()},afterRender:()=>{this.vars.modal?.assignTabIndexes?.()}}}),this.vars.calendar.init()}initSuspended(){const e=this.upcomingElement.querySelector(`.${this.prefix}_upcoming__suspended`);if(!e)return;if(this.vars.view.status!==this.statuses.hold)return void e.remove();const t=e.querySelector(`.${this.prefix}_upcoming__suspended_button`);if(!t)return;const{subscriptionAcceptData:{acceptanceIsRequired:i}={}}=this.vars.view;i&&(t.classList.remove("--solid"),t.classList.add("--outline","--accept"))}initDate(){const e=this.upcomingElement.querySelector(`.${this.prefix}_upcoming__value`);if(!e)return;if(this.vars.view.status!==this.statuses.active)return void e.remove();const t=this.lastOrderShipped?this.vars.view.upcomingDeliveryDate:this.vars.view.nextDeliveryDate;e.textContent=super.getFormattedDate(t,{alwaysWithDate:!0})}initEdit(){const e=this.upcomingElement.querySelector(`.${this.prefix}_upcoming__edit`);e&&(this.vars.view.status===this.statuses.active&&this.vars.view.subscriptionOptions.isChangeUpcomingDeliveryDatePossible||e.remove())}initLabel(){if(this.lastOrderShipped)return;const e=this.upcomingElement.querySelector(`.${this.prefix}_upcoming__label`);e&&(e.textContent=`${this.txt["Data kolejnej dostawy"]}:`)}initInfoModal(){if(this.lastOrderShipped)return;if(localStorage.getItem(`subscription${this.vars.view.id}UpcomingInfoShowed`))return;const e=this.getUpcomingInfoModalElement();e&&(this.vars.modal=new Modal({element:e,classList:"--subscr --upcoming-info --mobile",afterClose:()=>localStorage.setItem(`subscription${this.vars.view.id}UpcomingInfoShowed`,!0)}),this.initUpcomingInfoEvents())}onClickEditLink(){const e=this.getChangeUpcomingModalElement();e&&(this.vars.modal=new Modal({element:e,classList:"--subscr --change-upcoming-date --mobile"}),this.initChangeUpcomingEvents())}onClickChangeDay(){if(!this.vars.calendar.selectedDates.length)return;const[e]=this.vars.calendar.selectedDates;if(!this.lastOrderShipped&&e===this.vars.view.upcomingDeliveryDate)return void this.vars.modal.closeModal();if(!this.lastOrderShipped)return void this.saveChangeUpcoming({nextDate:e});if(e===this.vars.view.upcomingDeliveryDate)return void this.vars.modal.closeModal();const t=this.addDaysToDate(e,this.vars.view.daysInPeriod);this.saveChangeUpcoming({date:e,nextDate:t})}onClickRenewSubscription(e){e.classList.contains("--accept")?(super.scrollToElement({element:document.querySelector(`.${this.prefix}_accept`)}),document.querySelector(`.${this.prefix}_accept__button`)?.classList.add("--highlight"),Alertek.Info(this.txt["Zaakceptuj nową cenę subskrypcji"]),setTimeout((()=>{document.querySelector(`.${this.prefix}_accept__button`)?.classList.remove("--highlight")}),2e3)):this.renewSubscription()}initUpcomingInfoEvents(){this.upcomingInfoElement.addEventListener("click",(e=>{const{target:t}=e;t.closest(`.${this.prefix}_upcoming_info__button`)&&this.vars.modal.closeModal()}))}initChangeUpcomingEvents(){this.changeUpcomingElement.addEventListener("click",(e=>{const{target:t}=e;t.closest(`.${this.prefix}_change_upcoming__button`)&&this.onClickChangeDay()}))}initEvents(){this.upcomingElement.addEventListener("click",(e=>{const{target:t}=e;if(t.closest(`.${this.prefix}_upcoming__edit`))return e.preventDefault(),void this.onClickEditLink();t.closest(`.${this.prefix}_upcoming__suspended_button`)&&this.onClickRenewSubscription(t.closest(`.${this.prefix}_upcoming__suspended_button`))}))}async generate(){const e=document.getElementById(`${this.prefix}_upcoming_template`)?.content.cloneNode(!0);if(!e||!e.firstChild)return;const t=this.upcomingElement;if(this.vars.view.status===this.statuses.finished)return t?.remove(),void document.querySelector(this.vars.move.moveSelector)?.remove();this.upcomingElement=e.firstChild;const[i]=this.vars.orders;this.lastOrderShipped=super.checkLastOrderIsShipped(i),this.initLabel(),this.initEdit(),this.initDate(),this.initSuspended(),this.initInfoModal(),this.initEvents(),t&&document.body.contains(t)?t.replaceWith(this.upcomingElement):super.move({element:this.upcomingElement,...this.vars.move})}async init(e={}){this.vars={afterReady:e.afterReady||(()=>{}),move:e.move||this.vars?.move||{},view:e.view||this.vars?.view||{},orders:e.orders||this.vars?.orders||[]},this.callbacks={afterChangeDate:e.afterChangeDateCallback||this.callbacks?.afterChangeDate,afterChangeStatus:e.afterChangeStatusCallback||this.callbacks?.afterChangeStatus},await this.generate(),this.vars.afterReady(this.upcomingElement)}}app_shop.fn.subscrUpcoming=new SubscrUpcoming;