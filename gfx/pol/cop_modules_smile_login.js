const AnimateElementSmile=({element:e,afterFinish:t,options:i={duration:350,iterations:1,easing:"ease-in-out"}}={})=>{if(void 0===e)return;let n=null;return s=>{null!==n&&(n?.cancel?.(),n=null),n=e?.animate(s,i);const a=new Promise((e=>{n?.addEventListener("finish",(()=>{t?.(),e()}),{once:!0})}));return n?.play(),a}};class AnimateMobileModalSmile{constructor(){this.animationInstance=null,this.modal=null,this.modalElement=null,this.modalWrapper=null,this.modalHandler=null,this.offset=0,this.handlerTop=null,this.handlerHeight=null,this.isHandlerInitialized=!1,this.useAnimationAPI=!1,this.steps=null,this.animationClassList="--animate-modal-return",this.initFunctions()}setModalPosition(e){this.modalWrapper.setAttribute("style",`--top-distance: ${e}px;`)}resetPos(){this.modalWrapper.removeAttribute("style"),!this.useAnimationAPI&&this.animationClassList&&this.modalWrapper.classList.remove(this.animationClassList)}initHandlerProps(){const e=this.modalHandler?.getBoundingClientRect();this.handlerTop=e?.top,this.handlerHeight=e?.height}setHandlerInitialize(e){this.isHandlerInitialized=!!e}initCssAnimationEvents(){this.modalWrapper?.addEventListener("animationend",(()=>{this.resetPos()}))}initFunctions(){this.onTouchMove=e=>{if(!e?.targetTouches?.[0])return;if(app_shop.vars.view>2)return;this.isHandlerInitialized||(this.initHandlerProps(),this.setHandlerInitialize(!0)),e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault();const{clientY:t}=e.targetTouches[0];if(0!=t&&!t)return;const i=t-this.handlerTop-this.handlerHeight;if(t+this.handlerHeight<=0)return;t<window.innerHeight-this.handlerHeight-this.offset&&i>=0&&this.setModalPosition(i)},this.onTouchEnd=e=>{if(!(app_shop.vars.view>2))if(this.setHandlerInitialize(!1),this.useAnimationAPI){const t=e?.targetTouches?.[0]?.clientY,i=[{transform:`translate(0, ${t}px)`},{transform:"translate(0, 0)"}];this.animationInstance(this.steps||i).then((()=>{this.resetPos()}))}else this.modalWrapper.classList.add(this.animationClassList)}}init(e={}){const{modal:t,wrapper:i,handler:n,steps:s,modalInstanceAnimate:a,useAnimationAPI:o,animationClassList:r}=e;this.steps=s||this.steps,this.useAnimationAPI=o||this.useAnimationAPI,this.animationClassList=r||this.animationClassList,this.modal=a||this.modal,this.modalElement=t||document.querySelector("#modal.--expchck")||this.modalElement,this.modalWrapper=i||this.modalElement?.querySelector(".modal__wrapper")||this.modalWrapper,this.modalHandler=n||this.modalWrapper?.querySelector(".modal__handler")||this.modalHandler,this.initHandlerProps(),this.useAnimationAPI?this.animationInstance=AnimateElementSmile({element:this.modalWrapper}):this.initCssAnimationEvents(),this.modalHandler?.addEventListener("touchmove",this.onTouchMove),this.modalHandler?.addEventListener("touchend",this.onTouchEnd)}destroy(){this.modalHandler?.removeEventListener("touchmove",this.onTouchMove),this.modalHandler?.removeEventListener("touchend",this.onTouchEnd)}}const LOGINPIN_TXT={Logowanie:"Logowanie","Wiadomość została wysłana":"Wiadomość została wysłana","Twoje konto":"Twoje konto","Zaloguj się":"Moje Konto","Wpisz kod":"Wpisz kod","Nie udało się wygenerować pinu. Spróbuj ponownie później":"Nie udało się wygenerować pinu. Spróbuj ponownie później","Wprowadzony kod jest niepoprawny":"Wprowadzony kod jest niepoprawny","Wprowadzony kod wygasł":"Wprowadzony kod wygasł","Przekroczono limit nieudanych prób wprowadzenia kodu":"Przekroczono limit nieudanych prób wprowadzenia kodu","Wystąpił nieoczekiwany błąd. Proszę spróbować ponownie":"Wystąpił nieoczekiwany błąd. Proszę spróbować ponownie","Spróbuj ponownie za":"Spróbuj ponownie za","Wprowadź pełny kod":"Wprowadź pełny kod","Nie udało się zapisać urządzenia":"Nie udało się zapisać urządzenia","Pomyślnie zapisano urządzenie":"Pomyślnie zapisano urządzenie","Biometryczne uwierzytelnienie urządzenia nie powiodło się":"Biometryczne uwierzytelnienie urządzenia nie powiodło się"},LOGINPIN_GQL={GENERATE_PIN:e=>JSON.stringify({query:`query {\n      expressCheckoutGenerateOtp(UserIdentifier: "${e?.replace?.(/"/g,'\\"')}", IAIAccountsConsent: true) {\n        isGenerated\n        isLimitExceeded\n        exceededLimits {\n          eventType\n          eventMaxTries\n          isTimeLimited\n          timeLimit {\n            eventBlockTime\n            eventRemainingBLockTime\n          }\n        }\n      }\n    }`}),VERIFY_PIN:e=>JSON.stringify({query:`query {\n      expressCheckoutVerifyOtp(Pin: "${e?.replace?.(/"/g,'\\"')}") {\n        isVerified\n        verificationToken\n        needRegistration\n        exceededLimits {\n          eventType\n          eventMaxTries\n          isTimeLimited\n          timeLimit {\n            eventBlockTime\n            eventRemainingBLockTime\n          }\n        }\n        isLimitExceeded\n        isPinExpired\n      }\n    }`}),CHECK_USER_ACCOUNT:e=>JSON.stringify({query:`query {\n      checkUserAccount(UserIdentifier: "${e}")\n    }`})},modalInstance=new Modal({notInit:!0});class SmileLogin{constructor(e={}){this.prefix=e.prefix||"smile",this.minDelayTime=400,this.modal=modalInstance,this.modalClasses="--smilelogin --mobile",this.txt={...LOGINPIN_TXT},this.queries={...LOGINPIN_GQL},this.language=e.language||app_shop?.vars?.language?.symbol||"pl",this.cachePhoneNumbers=[],this.state={saveDevice:!0,phoneNumber:"",login:""},this.ModalAnimationClass=AnimateMobileModalSmile||e.ModalAnimationClass||null,"function"==typeof this.ModalAnimationClass&&(this.ModalAnimationClass=new this.ModalAnimationClass)}addLoading(){const e=document.querySelector(".modal");e?.classList.add("--loading")}removeLoading(){const e=document.querySelector(".modal");e?.classList.remove("--loading")}toggleBodyOverflow(e){e?document.querySelector("body").classList.add("--modal-overflow"):document.querySelector("body").classList.remove("--modal-overflow")}initModalAnimation(e){const t=e=>{const t=(()=>{const e=document.createElement("div");return e.classList.add("modal__handler"),e})();t&&e.insertAdjacentElement("afterBegin",t)};if(this.ModalAnimationClass){const i=e.querySelector(".modal__wrapper");if(!i)return;t(i),e.classList.add("--mobile-animation"),this.ModalAnimationClass.init?.({modal:e})}}destroyModalAnimation(){this.ModalAnimationClass&&this.ModalAnimationClass?.destroy?.()}getAnimationModalParams(){const e=this;return{afterShow:t=>{e.initModalAnimation(t),e.toggleBodyOverflow(!0)},afterClose:()=>{e.destroyModalAnimation(),e.toggleBodyOverflow(!1)}}}async fetchData(e={}){const{data:t,link:i,linkParameter:n="",alert:s=!0}=e;if(!t)return!1;try{const e=await fetch(`${i||app_shop.urls.graphql||"/graphql/v1"}${n}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:t});return await e.json()}catch(e){return s&&Alertek.Error(this.txt["Wystąpił błąd połączenia. Sprawdź łącze internetowe lub spróbuj ponownie później"]),!1}}validateOtpResponse(e={}){const{exceededLimits:t,isGenerated:i,isVerified:n,isLimitExceeded:s,isPinExpired:a}=e;if(n||i)return!0;if(Array.isArray(t)&&t?.length>0){const e=t.pop(),i=e.isTimeLimited,n=e?.timeLimit?.eventRemainingBLockTime,s=!0===i&&n?`${this.txt["Spróbuj ponownie za"]} ${n}`:"",a=`${this.txt["Przekroczono limit nieudanych prób wprowadzenia kodu"]}. ${s}`;return Alertek?.Error(a),!1}return!0===s?(Alertek?.Error(this.txt["Przekroczono limit nieudanych prób wprowadzenia kodu"]),!1):!1===i?(Alertek?.Error(`${this.txt["Nie udało się wygenerować pinu. Spróbuj ponownie później"]}.`),!1):!0===a?(Alertek?.Error(this.txt["Wprowadzony kod wygasł"]),!1):!1===n?(Alertek?.Error(this.txt["Wprowadzony kod jest niepoprawny"]),!1):(Alertek?.Error(`${this.txt["Wystąpił nieoczekiwany błąd. Proszę spróbować ponownie"]}.`),!1)}async registerDevice(e={}){const{userLogin:t,authorizeToken:i}=e;if(t&&i){this.addLoading(),this.state.registerDeviceShowed=!1;try{await(app_shop.fn.webAuthnSmile?.registration?.({userLogin:t,authorizeToken:i})),this.state.registerDevice="success",localStorage.setItem("expchckDeviceRegistered",!0)}catch(e){1!==e.code&&(this.state.registerDevice="error",app_shop.fn.SmileLoginCOP?.alertInfo?.(".--saveDevice"))}}}async varifyPin(e="123456"){this.addLoading();const t=this.state.verifyPinElement,i=await this.fetchData({data:this.queries.VERIFY_PIN(e),linkParameter:"?query=expressCheckoutVerifyOtp",alert:!0});if(this.validateOtpResponse(i?.data?.expressCheckoutVerifyOtp)){this.state.verifyPinData=i;const{verificationToken:e}=i.data?.expressCheckoutVerifyOtp||{},t=await(app_shop.fn.webAuthnSmile?.checkBrowserSupport?.());return this.state.saveDevice&&t&&await this.registerDevice({userLogin:this.state.login,authorizeToken:e}),this.modal?.closeModal?.(),void this.loginCallback()}t?.classList.add("--error_pin"),this.removeLoading()}async varifyPhoneNumber(e="123456"){const t=this.cachePhoneNumbers.find((t=>t.phoneNumber===e)),i=t||await this.fetchData({data:this.queries.CHECK_USER_ACCOUNT(e),linkParameter:"?query=checkUserAccount",alert:!1}),n=t?.isVarifyPhoneNumber||i?.data?.checkUserAccount||!1;return!t&&n&&window?.errorLog?.({stack:`checkUserAccount_${n}`}),this.cachePhoneNumbers.push({phoneNumber:e,isVarifyPhoneNumber:n}),n}getPin(){const e=this.state.verifyPinElement,t=document.querySelectorAll(".otc input");if(!e||!t)return!1;e?.classList.remove("--error_pin");const i=Array.prototype.slice.call(t).reduce(((e,t)=>e+=t?.value?t.value:""),"");return 6===i.length&&(this.varifyPin(i),!0)}verifyPinInput(){const e=document.getElementById("otc-1"),t=document.querySelectorAll(".otc input"),i=(e,t)=>{e.value=t[0],t=t.substring(1),e.nextElementSibling&&t.length&&i(e.nextElementSibling,t)},n=function(e){let t=e.data||e?.target?.value||e.value;t&&1!==t.length&&i(e.target||e,t)};if(e){if(t.forEach((e=>{e.addEventListener("keyup",(function(e){16!==e.keyCode&&9!=e.keyCode&&224!=e.keyCode&&18!=e.keyCode&&17!=e.keyCode&&(8===e.keyCode&&this.previousElementSibling&&"INPUT"===this.previousElementSibling.tagName?this.previousElementSibling.select():37!==e.keyCode&&39!==e.keyCode&&8!==e.keyCode&&this.nextElementSibling&&this.nextElementSibling.select(),e.target.value.length>1&&n(e))})),e.addEventListener("focus",(function(e){this.select()})),e.addEventListener("input",this.getPin.bind(this))})),e.addEventListener("input",n),e.focus(),!1 in window||!e)return!1;this.state.ac=new AbortController,navigator.credentials.get({otp:{transport:["sms"]},signal:this.state.ac.signal}).then((t=>{e.value=t.code,n(e),this.getPin()})).catch((e=>{}))}}async prepareVerifyPinToDisplay(){const e=document.getElementById(`${this.prefix}_login_verify_pin`)?.content.cloneNode(!0);e&&(await this.setSaveDevice(e),e.querySelector(`.${this.prefix}_login__pin_phone`)?.insertAdjacentHTML("afterbegin",this.state.phoneNumber),this.modal.params={...this.getAnimationModalParams(),element:e,classList:`${this.modalClasses} --verify_pin --extrasmall --${this.state.loginType}`,afterShow:()=>{document.querySelector(".modal.--verify_pin").setAttribute("aria-label",this.txt["Błyskawiczne uzupełnienie danych"])}},this.modal.init())}async sendPin(){this.addLoading();const e=await this.fetchData({data:this.queries.GENERATE_PIN(this.state.login),linkParameter:"?query=expressCheckoutGenerateOtp",alert:!0}),t=this.validateOtpResponse(e?.data?.expressCheckoutGenerateOtp);this.removeLoading(),t&&Alertek?.Success(this.txt["Wiadomość została wysłana"])}async setSaveDevice(e){const t=e.getElementById(`${this.prefix}_save_device`);if(!t)return;if(!await(app_shop.fn.webAuthnSmile?.checkBrowserSupport?.())){const e=t.closest(`.${this.prefix}_login__save_device`);return e.parentNode.removeChild(e),void(this.state.saveDevice=!1)}if(!localStorage.getItem(`${this.prefix}SaveDevice`))return localStorage.setItem(`${this.prefix}SaveDevice`,t.checked),void(this.state.saveDevice=t.checked);const i="true"===localStorage.getItem(`${this.prefix}SaveDevice`);t.checked=i,this.state.saveDevice=i}onChangeSaveDevice(e){const{checked:t}=e;localStorage.setItem(`${this.prefix}SaveDevice`,t),this.state.saveDevice=t}initEvents(){const e=document.querySelector(`.${this.prefix}_login.--verify_pin`);e&&(this.state.verifyPinElement=e,e.addEventListener("click",(e=>{const{target:t}=e;return t.closest(`.${this.prefix}_login__send_pin a`)?(e.preventDefault(),this.sendPin(),!1):t.closest(`.${this.prefix}_login__buttons a`)?(e.preventDefault(),this.getPin()||Alertek.Error(this.txt["Wprowadź pełny kod"]),!1):!t.closest(`.${this.prefix}_login__change_pin_option`)||(e.preventDefault(),this.modal?.closeModal?.(),this.changePhoneCallback(),!1)})),e.addEventListener("change",(e=>{const{target:t}=e;t.closest(`#${this.prefix}_save_device`)&&this.onChangeSaveDevice(t)})),e.addEventListener("keydown",(t=>{const{target:i}=t;if(i.closest(`label[for="${this.prefix}_save_device"]`)&&32===t.keyCode){const i=e.querySelector(`#${this.prefix}_save_device`);return!!i&&(t.preventDefault(),i.checked=!i.checked,this.onChangeSaveDevice(i),!1)}})))}async generatePin(){await this.prepareVerifyPinToDisplay(),await this.sendPin(),this.verifyPinInput(),this.initEvents()}async init(e={}){if(this.state=e.state||this?.state,this.state.login=e?.login||"",this.state.input=e?.input||"",this.state.phoneNumber=e?.phoneNumber||"",this.state.generatePinButton=e?.generatePinButton||null,this.loginCallback=e.loginCallback||(()=>{}),this.changePhoneCallback=e.changePhoneCallback||(()=>{}),this.isVarifyPhoneNumber=await this.varifyPhoneNumber(this.state.phoneNumber),this.state.input.classList.remove("--loading"),!this.isVarifyPhoneNumber)return app_shop.fn.SmileLoginCOP?.alertInfo?.(".--success_checked",1),this.state.generatePinButton?.classList?.remove?.("--active"),!1;app_shop.fn.SmileLoginCOP?.alertInfo?.(".--success_checked",null),this.state.generatePinButton?.classList?.add?.("--active")}}class SmileLoginCOP extends COPModules{constructor(e={}){super(e)}async fetchData(e){try{const t=await fetch(e),i=await t.text(),n=(new DOMParser).parseFromString(i,"text/html");this.updateDom(n),this.layoutElement&&this.layoutElement.classList.remove("load-content")}catch(e){return this.layoutElement&&this.layoutElement.classList.remove("load-content"),!1}return!0}updateDom(e){const t=document.getElementById("content"),i=e.getElementById("content");t&&i&&(t.outerHTML=i.outerHTML,app_shop.fn?.reinitOscopClasses?.(),app_shop.fn.runAjaxFn())}verifyPinInit(e){if(document.querySelector(".modal.--smilelogin.--verify_pin"))return;const t=e.target;t.classList.add("--loading");let i=t.value;const n=document.querySelector(t.getAttribute("data-concat-from")||"");n&&(i=`${n?.value||""} ${i}`),this.generatePinButtonWrapper=document.querySelector(".smile_web_authn__generate_pin_wrapper"),app_shop.fn.smileLogin.init({login:i,phoneNumber:i,input:t,generatePinButton:this.generatePinButtonWrapper,loginCallback:()=>{app_shop.fn.SmileLoginCOP.alertInfo(".--success"),document.querySelector(".smile_logout")?.classList?.add?.("--active"),document.querySelector(".smile_web_authn__link")?.classList?.remove?.("--active"),app_shop.fn.SmileLoginCOP?.alertInfo?.(".--success_checked",1),document.querySelector(".smile_web_authn__generate_pin_wrapper").classList?.remove?.("--active"),app_shop.fn.copModulesLogin.loginSuccess()},changePhoneCallback:()=>{this.phoneNumberInput.focus()}})}async getBasketForm(){if(!app_shop.vars.basketLink)return!1;try{await fetch(app_shop.vars.basketLink).then((e=>{e.text().then((e=>{const t=(new DOMParser).parseFromString(e,"text/html").querySelector('form[action*="basketchange"]');if(sessionStorage.removeItem("oldBasket"),!t)return;const i=new FormData(t),n={};for(let[e,t]of i.entries())n[e]=t;sessionStorage.setItem("oldBasket",JSON.stringify(n))}))}))}catch(e){return!1}}async buildBasket(e){if(!e)return!1;const t=new URLSearchParams(e);t.append("getAjax",!0),t.append("mode",1);try{const e=await fetch("/basketchange.php?type=multiproduct",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json"},body:t});await(app_shop.graphql?.trackingEvents(e));return await e.json()}catch(e){return!1}}async changeAccount(){this.layoutElement&&this.layoutElement.classList.add("load-content"),await this.getBasketForm(),await fetch("/login.php?operation=logout",{mode:"no-cors",headers:{"Access-Control-Allow-Origin":"*"}}),app_shop.vars.logged=!1;const e=sessionStorage.getItem("oldBasket");e&&await this.buildBasket(JSON.parse(e)),await this.fetchData(window.location.href)}initEvents(){this.phoneNumberInput=document.querySelector(`.${this.prefix}_contact__item.--phone #client_phone`),this.generatePinButton=document.querySelector(".smile_web_authn__generate_pin"),this.phoneNumberInput.addEventListener("blur",this.verifyPinInit),this.generatePinButton.addEventListener("click",(async e=>{e.preventDefault(),this.generatePinButton.classList.add("--loading"),await(app_shop.fn.smileLogin?.generatePin()),this.generatePinButton.classList.remove("--loading")})),this.webAuthnElement.addEventListener("click",(e=>{e.preventDefault(),this.webAuthnElement.classList.add("--loading"),this.webAuthnLogin()})),this.changeAccountElement.addEventListener("click",(e=>{e.preventDefault(),this.changeAccount()}))}generate(){const e=document.getElementById(`${this.prefix}_remarks_template`)?.content.cloneNode(!0);if(!e||!e.firstChild)return;const t=this.remarksElement;this.remarksElement=e.firstChild,this.initEvents(),t&&document.body.contains(t)&&t.replaceWith(this.remarksElement)}alertInfo(e,t=3e3){const i=document.querySelector(`${this.alerElementName}${e}`);if(i?.classList?.add("--active"),i.textContent=i.textContent,!t)return!1;this.alertTimeout=setTimeout((()=>{i?.classList?.remove("--active")}),t)}async webAuthnLogin(){try{await(app_shop.fn.webAuthnSmile?.login?.());this.webAuthnElement.classList.remove("--active","--loading"),this.alertInfo(".--success"),app_shop.fn.copModulesLogin.loginSuccess(),document.querySelector(".smile_logout")?.classList?.add?.("--active")}catch(e){this.alertInfo(".--authn"),this.webAuthnElement.classList.remove("--loading")}}afterLogin(){document.querySelector(".smile_web_authn__link")?.classList?.remove?.("--active")}init(e={}){if(this.type=e.type||app_shop.vars.copModulesType||"order1",this.logged=e.logged||app_shop.vars.logged||!1,this.webAuthnElement=document.querySelector(".smile_web_authn__link"),this.alerElementName=".smile_web_authn__info",this.changeAccountElement=document.querySelector(".smile_logout"),this.layoutElement=document.getElementById("layout"),this.vars={afterReady:e.afterReady||(()=>{}),move:e.move||!1},this.logged)return!1;this.initEvents(),"true"===localStorage.getItem("expchckDeviceRegistered")&&"false"!==localStorage.getItem("expchckSaveDevice")&&this.webAuthnElement&&this.webAuthnElement.classList.add("--active")}}app_shop.vars.simplyfyCop&&(app_shop.fn.webAuthnSmile=new WebAuthn({IAIAccountsUrl:app_shop.vars.IAIAccountsUrl,supportOpera:!1}),app_shop.fn.SmileLoginCOP=new SmileLoginCOP,app_shop.fn.smileLogin=new SmileLogin,app_shop.vars.copModulesClasses.push((()=>{app_shop.fn.SmileLoginCOP=new SmileLoginCOP,app_shop.fn.smileLogin=new SmileLogin})));