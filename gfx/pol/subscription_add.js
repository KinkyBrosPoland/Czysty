class SubscrAdd extends Subscr{constructor(t={}){super(t),this.elementsMap=new WeakMap}async fetchProductsToAdd(t){const{products:{products:e=[]}={}}=await super.getData({name:"productsToAdd",state:{period:this.vars.period,text:t}})||{};return e}async addProductToSubscription({product:t,quantity:e}){this.addProductModalElement.closest(".modal")?.classList.add("--loading");const s=this.getAddProductInputQuery({product:t,quantity:e});await super.fetchData({data:this.queries.ADD_PRODUCT_TO_SUBSCRIPTION(s),linkParameter:"?mutation=subscriptionAddProductToSusbcription"}),this.vars.modal.closeModal(),this.callbacks.afterAddProduct?.()}getAddProductInputQuery({product:t,quantity:e}){const{id:s,size:{id:r}={}}=t||{};return`\n      subscriptionId: ${this.vars.subscrId},\n      product: {\n        id: ${s},\n        size: "${r}",\n        quantity: ${e},\n      }\n    `}getNextRebate(){return this.vars.rebatesThresholds.find((t=>t.numberFrom>this.vars.ordersCount))}getFormattedProductData(){return this.vars.products.filter((t=>!this.typesOfProductThatCannotBeEdited.includes(t.type))).flatMap((t=>t.sizes?.filter((t=>0!==t.amount))?.filter((e=>!t.subscription?.minimumQuantity||e.amount<0||e.amount>=t.subscription?.minimumQuantity))?.map((e=>{const{sizes:s,...r}=t;return{...r,size:e}}))))}validateInput(t){const{target:e}=t;if(""===e.value)return;const s={...e.dataset,quantity:e.value,quantitySizes:e.value},r=super.numberCheck(s);r&&(e.setAttribute("data-prev",r),e.value=r)}dropdownNumberAfterClick(t){const e=t.querySelector(".f-dropdown-item"),s=t.closest(`.${this.prefix}_add_product_modal__quantity`),r=s.querySelector(`.${this.prefix}_add_product_modal__input`);if(e.hasAttribute("data-more"))return s.classList.add("--more"),r.focus(),void(r.value="");s.classList.remove("--more"),r.value=e.getAttribute("data-value"),this.validateInput({target:r})}setProductIconModal(t,e){const s=e.querySelector(`.${this.prefix}_add_product_modal__icon`),r=e.querySelector(`.${this.prefix}_add_product_modal__icon img`);if(!s||!r)return;const{link:d,name:i,icon:o}=t||{};s.href=d,r.alt=i,r.src=o}getAddProductModalElement(t){const e=document.getElementById(`${this.prefix}_add_product_modal_template`)?.content.cloneNode(!0);return!(!e||!e.firstChild)&&(this.addProductModalElement=e.firstChild,this.setProductIcon(t,this.addProductModalElement,"_modal"),this.setProductName(t,this.addProductModalElement,"_modal"),this.setProductSize(t,this.addProductModalElement,"_modal"),this.setProductPrice(t,this.addProductModalElement,"_modal"),this.setProductQuantity(t,this.addProductModalElement),this.setProductRebate(this.addProductModalElement),this.elementsMap.set(this.addProductModalElement,{product:t}),this.addProductModalElement)}setProductQuantity(t,e){const s=e.querySelector(`.${this.prefix}_add_product_modal__input`);if(!s)return;const{id:r,unit:{singular:d,plural:i,precision:o,sellBy:a=1}={},parametersWithContext:n,size:{amount:c}={},subscription:u}=t||{},{minimumQuantity:l}=u||{};s.value=l||a,s.setAttribute("data-product-id",r),s.setAttribute("data-amount",c),s.setAttribute("data-unit_sellby",a),s.setAttribute("data-step",a),s.setAttribute("data-unit",c>1?i:d),s.setAttribute("data-unit_precision",o),super.setParametersWithContext(s,n,l);const h=e.querySelector(`.${this.prefix}_add_product_modal__select`);if(!h)return;if(1!==a){h.querySelectorAll("option[value]").forEach((t=>{t.value=+t.value*a,t.textContent=+t.textContent*a}))}const p=h.querySelector(`option[value="${l||a}"]`),_=h.querySelector("option[data-more]");p?p.setAttribute("selected","selected"):_.setAttribute("selected","selected")}setProductRebate(t){const e=t.querySelector(`.${this.prefix}_add_product_modal__rebate`);if(!e)return;const s=this.getNextRebate();if(!s)return void e.remove();const r="percentage"===s.type?`${s.value}%`:super.formatPrice(s.value);e.textContent=this.txt["Od %s dostawy w ramach tej subskrypcji rabat wyniesie -%s"].format(s.numberFrom,r)}setProductIcon(t,e,s=""){const r=e.querySelector(`.${this.prefix}_add_product${s}__icon`),d=e.querySelector(`.${this.prefix}_add_product${s}__icon img`);if(!r||!d)return;const{link:i,name:o,icon:a}=t||{};r.href=i,d.alt=o,d.src=a}setProductName(t,e,s=""){const r=e.querySelector(`.${this.prefix}_add_product${s}__name`);if(!r)return;const{link:d,name:i}=t||{};r.href=d,r.textContent=i}setProductSize(t,e,s=""){const r=e.querySelector(`.${this.prefix}_add_product${s}__size`);if(!r)return;const{size:{id:d,name:i}={}}=t||{};if("uniw"===d)return void r.remove();const o=r.querySelector(`.${this.prefix}_add_product${s}__size_name`);o&&(o.textContent=i)}setProductPrice(t,e,s=""){const r=e.querySelector(`.${this.prefix}_add_product${s}__price`);if(!r)return;const{size:{price:{price:{gross:{value:d,formatted:i}={}}={}}={}}={}}=t||{};r.textContent=0!==d?i:`${this.txt.Gratis}!`}getProduct(t){const e=document.getElementById(`${this.prefix}_add_product_template`)?.content.cloneNode(!0);return!(!e||!e.firstChild)&&(this.setProductIcon(t,e),this.setProductName(t,e),this.setProductSize(t,e),this.setProductPrice(t,e),this.elementsMap.set(e.firstChild,{product:t}),e.firstChild)}initProducts(){const t=this.addElement.querySelector(`.${this.prefix}_add__products`);if(!t)return;if(!this.vars.formattedProducts.length)return void t.remove();const e=this.addElement.querySelector(`.${this.prefix}_add__products_wrapper`);e&&this.vars.formattedProducts.forEach((t=>{const s=this.getProduct(t);s&&e.appendChild(s)}))}initNotFound(){const t=this.addElement.querySelector(`.${this.prefix}_add__not_found`);t&&this.vars.formattedProducts.length&&t.remove()}initSearch(){const t=this.addElement.querySelector(`.${this.prefix}_add__search_input`);t&&(t.value=this.vars.text,t.setAttribute("data-prev",this.vars.text),this.addElement.querySelector(`.${this.prefix}_add__search`)?.classList.toggle("--filled",!!this.vars.text))}initFocus(){const t=this.addElement.querySelector(`.${this.prefix}_add__search_input`);t&&this.vars.text&&this.vars.focus&&t.focus()}async initSlider(){const{Slider:t}=await(appModules?.load?.("Slider"));if(!t)return;this.vars.slider=new t;const e=document.getElementById("content")?.offsetWidth<1170?{}:{1170:{slidesPerView:this.vars.formattedProducts.length<5?4:4.4}};await this.vars.slider.init({options:{loop:!1,autoHeight:!1,navigation:{nextEl:`.${this.prefix}_add__navigation_button.--next`,prevEl:`.${this.prefix}_add__navigation_button.--prev`},spaceBetween:30,slidesPerView:this.vars.formattedProducts.length<2?1:1.4,centeredSlidesBounds:!0,breakpoints:{550:{slidesPerView:this.vars.formattedProducts.length<3?2:2.2},757:{slidesPerView:this.vars.formattedProducts.length<4?3:3.4,centeredSlidesBounds:!1},...e}}})}setupSlider(){const t=this.addElement.querySelector(`.${this.prefix}_add__products`);t&&this.vars.slider.setupSlider({element:t})}initAddProductModalDropdown(){this.vars.addProductModalDropdown=new SelectToDropdown({disableMobileView:!!app_shop.fn.isIos?.()??!1,selector:`.${this.prefix}_add_product_modal__select:not(.f-dropdown)`,direction:"top",afterClickDropdownCallback:this.dropdownNumberAfterClick.bind(this)})}initAddProductModalEvents(){this.addProductModalElement.addEventListener("click",(t=>{const{target:e}=t;e.closest(`.${this.prefix}_add_product_modal__button`)&&this.onClickAddProductToSubscription()})),this.addProductModalElement.querySelectorAll(`.${this.prefix}_add_product_modal__input`).forEach((t=>{t.addEventListener("keyup",this.debounces.validateInput),t.addEventListener("blur",this.onBlurInput)}))}onClickAddProductToSubscription(){const{value:t}=this.addProductModalElement.querySelector(`.${this.prefix}_add_product_modal__input`)||{},{product:e}=this.elementsMap.get(this.addProductModalElement)||{};e&&t?this.addProductToSubscription({product:e,quantity:t}):this.vars.modal.closeModal()}onBlurInput(){""===this.value&&(this.value=this.dataset.prev)}onClickShowAddProductModal(t){const e=t.closest(`.${this.prefix}_add_product`);if(!e)return;const{product:s}=this.elementsMap.get(e)||{};if(!s)return;const r=this.getAddProductModalElement(s);r&&(this.vars.modal=new Modal({element:r,classList:"--subscr --add-product --mobile",afterClose:()=>document.documentElement.classList.remove("--dropdown-open")}),this.initAddProductModalEvents(),this.initAddProductModalDropdown(),this.vars.modal?.assignTabIndexes?.())}onSearch(){const{value:t=""}=this.addElement.querySelector(`.${this.prefix}_add__search_input`)||{};this.vars.text=t,this.addElement.querySelector(`.${this.prefix}_add__search`)?.classList.add("--loading-results"),this.addElement.querySelector(`.${this.prefix}_add__products`)?.classList.add("--loading"),this.addElement.querySelector(`.${this.prefix}_add__not_found`)?.classList.add("--loading"),this.callbacks?.afterSearch()}onKeyupSearch(t){const{target:e}=t,{prev:s=""}=e;if(e.value===s)return;if(13===(t.which||t.keyCode||0))return document.activeElement.blur(),this.vars.focus=!1,void this.onSearch();this.vars.focus=!0,this.onSearch()}onClickClear(){const t=this.addElement.querySelector(`.${this.prefix}_add__search_input`);t&&(t.value="",this.onSearch())}initEvents(){this.addElement.addEventListener("click",(t=>{const{target:e}=t;e.closest(`.${this.prefix}_add_product__button`)?this.onClickShowAddProductModal(e):(e.closest(`.${this.prefix}_add__search_submit`)&&this.onSearch(),e.closest(`.${this.prefix}_add__search_clear`)&&this.onClickClear(e))})),this.addElement.querySelector(`.${this.prefix}_add__search_input`)?.addEventListener("keyup",this.debounces.onSearch)}async generate(){const t=document.getElementById(`${this.prefix}_add_template`)?.content.cloneNode(!0);if(!t||!t.firstChild)return;const e=this.addElement;return this.vars.status!==this.statuses.finished&&this.vars.canEditBasket?(this.addElement=t.firstChild,this.vars.products=await this.fetchProductsToAdd(this.vars?.text)||[],this.vars.formattedProducts=this.getFormattedProductData()||[],this.vars.formattedProducts.length||this.vars.text?(await this.initSlider(),this.initSearch(),this.initProducts(),this.initNotFound(),this.initEvents(),e&&document.body.contains(e)?(e.replaceWith(this.addElement),this.setupSlider(),void this.initFocus()):(super.move({element:this.addElement,...this.vars.move}),void this.setupSlider())):(e?.remove(),void document.querySelector(this.vars.move.moveSelector)?.remove())):(e?.remove(),void document.querySelector(this.vars.move.moveSelector)?.remove())}async init(t={}){this.vars={afterReady:t.afterReady||(()=>{}),move:t.move||this.vars?.move||{},status:t.status||this.vars?.status||this.statuses.active,period:t.period||this.vars?.period||null,subscrId:t.subscrId||this.vars?.subscrId||null,ordersCount:t.ordersCount||this.vars?.ordersCount||1,rebatesThresholds:t.rebatesThresholds||this.vars?.rebatesThresholds||[],text:t.text||this.vars?.text||"",focus:this.vars?.focus||!1,canEditBasket:t?.canEditBasket??this.vars?.canEditBasket??!0},this.callbacks={afterAddProduct:t.afterAddProductCallback||this.callbacks?.afterAddProduct,afterSearch:t.afterSearchCallback||this.callbacks?.afterSearch},this.debounces={validateInput:this.debounce(this.validateInput.bind(this)),onSearch:this.debounce(this.onKeyupSearch.bind(this))},await this.generate(),this.vars.afterReady(this.addElement)}}app_shop.fn.subscrAdd=new SubscrAdd;