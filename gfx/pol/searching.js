const AdvSearch=function(){this.setLoading=e=>{document.querySelector(".searching_nodes")?.classList.toggle("load-content",e)},this.createElement=e=>{const{tag:t,classes:a,id:n,href:s,attributes:o,text:c}=e,i=document.createElement(t);return void 0!==a&&(i.className=a),void 0!==n&&(i.id=n),void 0!==s&&(i.href=s),void 0!==o&&o.forEach((e=>i.setAttribute(e.name,e.value))),void 0!==c&&(i.innerHTML=c),i},this.getParameters=()=>{const e=document.getElementById("searching_form"),t=[...e.querySelectorAll("input.searching_ajax:not(.multipleselect)"),...e.querySelectorAll("input.searching_checkbox_name:not(.multipleselect)"),...e.querySelectorAll(".searching_ajax-select:not(.multipleselect)")].filter((e=>e.value)),a={};for(let e of t){const t=e.getAttribute("name");a.hasOwnProperty(t)||(a[t]=e)}const n=Object.values(a),s=document.createElement("form");n.forEach((e=>{const t=e.cloneNode(!0);"select-one"===t.type&&(t.value=e.value),s.append(t)}));const o=new FormData(s);return`&${new URLSearchParams(o).toString()}`},this.fetchData=async e=>{try{const t=await fetch(decodeURIComponent(e),{method:"POST",headers:{"Content-Type":"application/json"}});return await t.json()}catch(e){return!1}},this.initSelects=()=>{this.selectSearching=new SelectToDropdown({selector:"#searching_form select:not(.f-dropdown)",afterClickDropdownCallback:this.onClickDropdownElement,disableMobileView:!0})},this.updateCheckedCheckboxes=()=>{document.querySelectorAll("input.searching_checkbox_name").forEach((e=>{const t=[];e.parentElement.querySelectorAll("input.searching_ajax.multipleselect").forEach((e=>{e.disabled||e.checked&&t.push(e.value)})),e.value=t.join(",")}))},this.appendCheckboxes=e=>{const{wrapper:t,data:a,inputName:n}=e,{values:s}=a||{};if(!s)return;const o=t.querySelectorAll(".searching_checkbox");if(o.length)return o.forEach((e=>{const t=e.querySelector("input.searching_ajax.multipleselect"),{value:a}=t;if(!a)return;s.find((e=>e[0]===+a))&&(t.disabled=!1,e.classList.remove("disabled"))})),void this.updateCheckedCheckboxes();const c=s.map((e=>{const t=this.createElement({tag:"label",classes:"searching_checkbox"}),a=this.createElement({tag:"input",classes:"searching_ajax multipleselect",attributes:[{name:"type",value:"checkbox"},{name:"name",value:n},{name:"value",value:e[0]}]}),s=this.createElement({tag:"span",text:e[1]});return t.append(a,s),t}));t.append(...c)},this.loadCheckboxes=async()=>{document.querySelectorAll("input.searching_checkbox_name").forEach((async e=>{const{name:t}=e,a=this.getParameters(),n=await this.fetchData(`/ajax/search.php?ajax=true&getOne=${t}${a}`);this.appendCheckboxes({wrapper:e.parentElement,data:n,inputName:t})}))},this.disableInputs=()=>{document.querySelectorAll('#searching_form input.searching_ajax:not([name="pricelimitmin"],[name="pricelimitmax"])').forEach((e=>{e.disabled=!0;const t=e.closest(".searching_checkbox");t&&t.classList.add("disabled")}));document.querySelectorAll('#searching_form .searching_ajax-select:not([name="sort"]').forEach((e=>{e.disabled=!0;const t=e.closest(".f-dropdown")?.querySelector(".f-dropdown-toggle");t&&(t.disabled=!0)}))},this.enableInput=e=>{if(!e)return;e.disabled=!1;const t=e.closest(".searching_checkbox");t&&t.classList.remove("disabled");const a=e.closest(".type_node_duallist");if(a){a.querySelectorAll("select").forEach((e=>{this.enableSelect(e)}))}},this.enableSelect=e=>{if(!e)return;e.disabled=!1;const t=e.closest(".type_node_tree");t&&(t.style.display="block");const a=e.closest(".f-dropdown")?.querySelector(".f-dropdown-toggle");a&&(a.disabled=!1,a.classList.remove("--disabled"))},this.enableInputs=e=>{const{values:t}=e||{};t&&Object.entries(t).forEach((([e,t])=>{const a=document.querySelector(`#searching_form input[name="${e}"]`);if(a){if(0===t)return;return void this.enableInput(a)}const n=document.querySelector(`#searching_form select[name="${e}"]`);if(n){if(0===t)return;this.enableSelect(n);const a=document.querySelector(`#searching_form select[name="${e}_bis"]`);this.enableSelect(a)}}))},this.getCount=async e=>{this.setLoading(!0);const t=this.getParameters();this.disableInputs();const a=await this.fetchData(`/ajax/search.php?ajax=true&getCount=1${t}`);document.querySelectorAll("#searching_form .no_update_data").forEach((t=>{t!==e&&t.classList.remove("no_update_data")})),this.enableInputs(a),this.loadCheckboxes(),this.setLoading(!1)},this.onClickDropdownElement=e=>{const t=e.closest(".f-dropdown");if(t){if(t.classList.contains("searching_duallist")){const e=t.closest(".type_node_duallist"),a=[...t.querySelectorAll("option")].map((e=>e.value)),n=[...e.querySelectorAll("[data-indexcurrent]")].map((e=>e.dataset.indexcurrent)),[s,o]=n,c=a.slice(+s,0===+o?a.length:+o).filter((e=>""!==e)),i=e.querySelector("input");if(i)return i.value=c.join(","),void this.getCount(t);const r=e.querySelector("select"),{name:l}=r,d=this.createElement({tag:"input",classes:"searching_ajax",attributes:[{name:"name",value:l},{name:"type",value:"hidden"},{name:"value",value:c.join(",")}]});return e.append(d),void this.getCount(t)}this.getCount(t)}},this.clearDropdown=e=>{e.querySelectorAll("option:not(:first-child)").forEach((e=>e.remove()))},this.appendDropdownOptions=e=>{const{wrapper:t,data:a}=e,{values:n}=a||{};if(!n)return;const s=n.map((e=>this.createElement({tag:"option",text:e[1],attributes:[{name:"value",value:e[0]}]})));t.querySelector("select").append(...s)},this.updateDropdown=e=>{const{wrapper:t,reInit:a,open:n,selectValue:s}=e;this.clearDropdown(t),this.appendDropdownOptions(e);const o=t.querySelector("select"),c=t.querySelector(`option[value="${s}"`);if(c&&(c.selected=!0),o.classList.add("no_update_data-select"),n){document.querySelectorAll("#searching .--open-select").forEach((e=>e.classList.remove("--open-select"))),o.classList.add("--open-select","no_update_data-select")}a&&this.selectSearching.reInit()},this.onClickDropdownToggle=async e=>{if(!e)return;const t=e.closest(".f-dropdown");if(!t)return;if(t.classList.contains("no_update_data"))return;e.classList.add("loading-list");const{name:a}=e.previousElementSibling,n=this.getParameters(),s=await this.fetchData(`/ajax/search.php?ajax=true&getOne=${a}${n}`),o=e.closest(".type_node_sub_duallist");if(o){const e=o.querySelectorAll(".f-dropdown"),a=e[1]===t?e[0]:e[1];if(this.updateDropdown({wrapper:t,data:s,reInit:a.classList.contains("no_update_data"),open:!0,selectValue:t.querySelector("select")?.value}),a.classList.contains("no_update_data"))return;this.updateDropdown({wrapper:a,data:s,reInit:!0,selectValue:a.querySelector("select")?.value})}else this.updateDropdown({wrapper:t,data:s,reInit:!0,open:!0,selectValue:t.querySelector("select")?.value})},this.onChangeCheckbox=()=>{this.updateCheckedCheckboxes(),this.getCount()},this.onSubmitForm=()=>{document.querySelectorAll('#searching_form [name$="_bis"]').forEach((e=>{e.disabled=!0}));document.querySelectorAll(".type_node_duallist").forEach((e=>{const t=e.querySelector("select");t&&(t.disabled=!0)}));document.querySelectorAll("#searching_form input.searching_ajax.multipleselect").forEach((e=>{e.disabled=!0}))},this.onChangePriceLimit=e=>{const t=parseInt(document.getElementById("pricelimitmin").value,10),a=parseInt(document.getElementById("pricelimitmax").value,10),n=parseInt(document.getElementById("min_price_start").value,10),s=parseInt(document.getElementById("max_price_start").value,10);return"pricelimitmin"===e.id?Number.isNaN(t)||t<n?(e.value=n,void this.getCount()):t>a?(e.value=a,void this.getCount()):void(e.value=t):Number.isNaN(a)||a>s?(e.value=s,void this.getCount()):t>a?(e.value=t,void this.getCount()):(e.value=a,void this.getCount())},this.initEvents=()=>{const e=document.getElementById("searching_form");e&&(e.addEventListener("click",(e=>{const{target:t}=e;t.closest(".searching_ajax .f-dropdown-toggle")&&(e.preventDefault(),this.onClickDropdownToggle(t.closest(".searching_ajax .f-dropdown-toggle")))})),e.addEventListener("change",(e=>{const{target:t}=e;t.closest("#searching_form input.searching_ajax[type=checkbox]")&&this.onChangeCheckbox(),(t.closest("#pricelimitmin")||t.closest("#pricelimitmax"))&&this.onChangePriceLimit(t)})),e.addEventListener("submit",(()=>{this.onSubmitForm()})))},this.init=()=>{this.initSelects(),this.loadCheckboxes(),this.initEvents()}};app_shop.fn.advSearch=new AdvSearch,app_shop.run((()=>{app_shop.fn.advSearch.init()}),"all","#searching");