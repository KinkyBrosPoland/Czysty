class SubscrDeliveries extends Subscr{constructor(e={}){super(e),this.elementsMap=new WeakMap,this.icons={online:"/gfx/standards/online_delivery.png",default:"/gfx/standards/delivery-man.svg"}}async fetchClientData(){const{data:e={}}=await super.fetchData({data:this.queries.CLIENT(),linkParameter:"?query=subscriptionClient",cacheName:"subscriptionClient"})||{};return e}async fetchDeliveriesData(){const e=this.getShippigInputQuery(),{data:i={}}=await super.fetchData({data:this.queries.SHIPPING(e),linkParameter:"?query=subscriptionShipping",cacheName:`subscriptionShipping&md5=${md5(e)}`})||{};return i}getShippigInputQuery(){return`ShippingInput: {\n      mode: product,\n      displaySettings: {\n        sortArgs: cost,\n      },\n      paymentType: prepaid,\n      products: [${this.vars.products.map((e=>`{\n        id: ${e.id},\n        size: "${e.size}",\n        quantity: ${e.quantity},\n        ${e.bundleProducts?.length?`bundleParts: [${e.bundleProducts.map((e=>`{\n          id: ${e.productId},\n          size: "${e.sizeId}",\n          quantity: ${e.quantity},\n          bundleProductId: ${e.bundledId},\n        }`)).join("")}]`:""}\n      }`)).join("")}],\n    }`}async saveChangeDelivery(e){this.deliveriesModalElement.closest(".modal")?.classList.add("--loading"),this.deliveriesElement?.classList.add("--loading");const i=this.getChangeDeliveryInputQuery(e);await super.fetchData({data:this.queries.UPDATE_SUBSCRIPTION(i),linkParameter:"?mutation=subscriptionChangeDelivery"}),this.vars.modal.closeModal(),this.callbacks.afterChangeDelivery?.()}getChangeDeliveryInputQuery(e){const{pickup_point:i,shipping:t=""}=e||{},r=t.split("-")[0];return`subscriptionEditModel: {\n      subscriptionId: ${this.vars.view.id},\n      courierId: ${r},\n      ${i?`pickupPoint: "${i}",`:""}\n    }`}async getAddress(){const{subscriptionOrderData:{orderDelivery:{deliveryAddressData:{id:e}={}}={}}={}}=this.vars.view||{},{client:{deliveryAddresses:i=[]}={}}=this.vars.clientData||{},t=i.find((i=>i.id===e))||{};return t?`${t.street},${this.vars.googleApiKey?` ${t.zipcode}`:""} ${t.city}`:""}disableInputs(){this.deliveriesModalElement.querySelectorAll(`.${this.prefix}_delivery__input`).forEach((e=>{e.parentNode.querySelectorAll(`input:not(.${this.prefix}_delivery__input):not(.--disabled), select:not(.--disabled)`).forEach((i=>{const{nextElementSibling:t}=i;if(e.checked)return i.disabled=!1,void(t?.classList?.contains("f-dropdown-toggle")&&t.classList.remove("--disabled"));i.disabled=!0,t?.classList?.contains("f-dropdown-toggle")&&t.classList.add("--disabled")}))}))}setClientCourierNumber({deliveryElement:e,clientCourierNumber:i}){const t=e.querySelector(`.${this.prefix}_delivery__client_courier_number`),r=e.querySelector(`.${this.prefix}_delivery__client_courier_number_value`),s=e.querySelector(`.${this.prefix}_delivery__client_courier_number_input`);if(r&&s){if(!i)return s.disabled=!0,s.value="",r.textContent="",void t.classList.remove("--active");s.disabled=!1,s.value=i,r.textContent=i,t.classList.add("--active")}else t.classList.remove("--active")}setInputsPickupPoint({selectedPoint:e,deliveryElement:i}){const{id:t,address:{buildingAndHouseNumber:r,street:s,postcode:l,city:n}={},coordinates:{latitude:o,longitude:d}={}}=e,c=i.querySelector(`.${this.prefix}_delivery__pickup_input`);c&&(c.value=t);const a=i.querySelector('input[name^="pickup_point_name"]');a&&(a.value=t);const u=i.querySelector('input[name^="pickup_point_street"]');u&&(u.value=r?`${s} ${r}`:s);const p=i.querySelector('input[name^="pickup_point_city"]');p&&(p.value=n);const v=i.querySelector('input[name^="pickup_point_zipcode"]');v&&(v.value=l);const h=i.querySelector('input[name^="pickup_point_lat"]');h&&(h.value=o);const _=i.querySelector('input[name^="pickup_point_lng"]');_&&(_.value=d);const y=i.querySelector(`.${this.prefix}_delivery__select_delivery`);y&&(y.setAttribute("tabindex","-1"),y.setAttribute("aria-hidden","true"))}setTextsPickupPoint({deliveryElement:e,selectedPoint:i}){const{id:t,address:{buildingAndHouseNumber:r,street:s,postcode:l,city:n}={}}=i,o=e.querySelector(`.${this.prefix}_delivery__pickup_name`);o&&(o.textContent=t);const d=e.querySelector(`.${this.prefix}_delivery__pickup_street`);d&&(d.textContent=r?`${s} ${r}`:s);const c=e.querySelector(`.${this.prefix}_delivery__pickup_city`);c&&(c.textContent=`${l} ${n}`);const a=e.querySelector(`.${this.prefix}_delivery__pickup_other`);a&&this.elementsMap.set(a,i)}checkedDelivery(e,i,t){const r=i.querySelector(`.${this.prefix}_delivery__input`);if(!r)return;const{elementCallback:s}=t||{},l=this.elementsMap.get(s);if(l?.courier?.id===e.courier?.id)return void(r.checked=!0);if(l)return;const{subscriptionOrderData:{orderDelivery:{courier:n={}}={}}={}}=this.vars.view;n.id===e.courier?.id&&(r.checked=!0)}minworthDelivery(e,i){const t=i.querySelector(`.${this.prefix}_delivery__minworth`);if(!t)return;if(e?.minworthReached)return void t.parentNode.removeChild(t);const r=i.querySelector(`.${this.prefix}_delivery__time`);r&&r.parentNode.removeChild(r);const s=i.querySelector(`.${this.prefix}_delivery__select_day`);s&&s.parentNode.removeChild(s);const l=i.querySelector(`.${this.prefix}_delivery__pickup`);l&&l.parentNode.removeChild(l);const n=i.querySelector(`.${this.prefix}_delivery__minworth_value`);n&&(n.textContent=e?.minworth?.formatted);const o=i.querySelector('input[name="shipping"]');o&&(o.disabled=!0)}commentDelivery(e,i){const t=i.querySelector(`.${this.prefix}_delivery__comment`);if(!t)return;if(!e?.comment||""===e?.comment)return void t.parentNode.removeChild(t);const r=super.decodeGraphQLHTMLString(e?.comment);t.innerHTML=r}timeDelivery(e,i){if(!i.querySelector(`.${this.prefix}_delivery__time`))return;const t=i.querySelector(`.${this.prefix}_delivery__time_label`);0===e?.courier?.id&&t&&(t.textContent=`${this.txt["Odbierz zamówienie"]} - `);const r=i.querySelector(`.${this.prefix}_delivery__time_value`);if(!r)return;const{today:s}=e?.deliveryTime;if(s)return void([r.textContent]=this.locale.weekdays);const{weekDay:l,weekAmount:n}=e?.deliveryTime;if(n>0){const{days:i}=e?.deliveryTime?.time,{day:t,month:s}=super.calculateDate({days:i});r.textContent=`${this.locale.weekdays[l]} (${t}.${s})`}else r.textContent=this.locale.weekdays[l]}pickupDelivery(e,i,t){const r=i.querySelector(`.${this.prefix}_delivery__pickup`);if(!r)return;if(0!==e?.courier?.id&&!e?.courier?.pickupPoint)return void r.parentNode.removeChild(r);i.firstChild.classList.add("--pickup");const{id:s,elementCallback:l,clientCourierNumber:n}=t||{},o=this.elementsMap.get(l);if(o?.courier?.id===e.courier?.id)return i.firstChild.setAttribute("data-selected-point",s),this.setInputsPickupPoint({selectedPoint:t,deliveryElement:i.firstChild}),this.setTextsPickupPoint({selectedPoint:t,deliveryElement:i.firstChild}),void this.setClientCourierNumber({deliveryElement:i.firstChild,clientCourierNumber:n});const{subscriptionOrderData:{orderDelivery:{pickupPoint:d={},courier:c={}}={}}}=this.vars.view;if(c?.id===e.courier?.id&&d?.id)return i.firstChild.setAttribute("data-selected-point",d.id),this.setInputsPickupPoint({selectedPoint:d,deliveryElement:i.firstChild}),void this.setTextsPickupPoint({selectedPoint:d,deliveryElement:i.firstChild});const a=i.querySelector(`.${this.prefix}_delivery__pickup_input`);a&&0===e?.courier?.id&&(a.name="stock")}costDelivery(e,i){const t=i.querySelector(`.${this.prefix}_delivery__cost`);t&&(t.textContent=0!==e?.cost?.value?e?.cost?.formatted:`${this.txt.Gratis}!`,e?.cost?.value&&0!==e?.cost?.value&&t.classList.add("--plus"))}getDelivery(e,i){const t=document.getElementById(`${this.prefix}_delivery_template`)?.content.cloneNode(!0);if(!t||!t.firstChild)return!1;t.firstChild.setAttribute("data-id",e?.courier?.id),t.firstChild.setAttribute("data-prepaid",e?.prepaid);const r=e?.courier?.fullId||`${e?.courier?.id}-${"dvp"===e?.prepaid?"0":"1"}`,s=t.querySelector('input[name^="shipping"]');s&&(s.value=r,s.id=`delivery_${r}`);const l=t.querySelector(`label.${this.prefix}_delivery__label`);l&&l.setAttribute("for",`delivery_${r}`);const n=t.querySelector(`img.${this.prefix}_delivery__icon`);n&&(n.alt=e?.courier?.name,n.src=93!==e?.courier?.id||e?.courier?.icon?e?.courier?.icon:this.icons.online);const o=t.querySelector(`.${this.prefix}_delivery__name`);return o&&(o.textContent=e?.courier?.name),this.checkedDelivery(e,t,i),this.minworthDelivery(e,t),this.commentDelivery(e,t),this.timeDelivery(e,t),this.pickupDelivery(e,t,i),this.costDelivery(e,t),t.firstChild}getDeliveriesModalElement(e){const i=document.getElementById(`${this.prefix}_deliveries_modal_template`)?.content.cloneNode(!0);if(!i||!i.firstChild)return!1;this.deliveriesModalElement=i.firstChild;const t=this.deliveriesModalElement.querySelector(`.${this.prefix}_deliveries_modal__block`);return t?(this.vars.shipping=this.vars.deliveriesData.shipping?.shipping||[],this.vars.shipping.forEach((i=>{const r=this.getDelivery(i,e);r&&(this.elementsMap.set(r,i),t.append(r))})),this.disableInputs(),this.deliveriesModalElement):this.deliveriesModalElement}setIconSelectedDelivery(){const e=this.deliveriesElement.querySelector(`.${this.prefix}_deliveries__delivery_icon img`);if(!e)return;const{subscriptionOrderData:{orderDelivery:{courier:{icon:i,name:t}={}}={}}}=this.vars.view;if(e.alt=t,!i)return e.src=this.icons.default,void e.parentNode.classList.add("--default");e.src=i}setNameSelectedDelivery(){const e=this.deliveriesElement.querySelector(`.${this.prefix}_deliveries__delivery_name`);if(!e)return;const{subscriptionOrderData:{orderDelivery:{courier:{name:i=""}={}}={}}}=this.vars.view;e.textContent=i}setDateSelectedDelivery(){const e=this.deliveriesElement.querySelector(`.${this.prefix}_deliveries__delivery_time_value`);if(!e)return;const{upcomingDeliveryDate:i}=this.vars.view;e.textContent=super.getFormattedDate(i,{alwaysWithDate:!0,brackets:!0})}setPriceSelectedDelivery(){const e=this.deliveriesElement.querySelector(`.${this.prefix}_deliveries__delivery_price`);if(!e)return;const{subscriptionOrderData:{deliveryCost:{value:i,formatted:t=""}={}}={}}=this.vars.view;e.textContent=i?t:`${this.txt.Gratis}!`}setPickupSelectedDelivery(){const e=this.deliveriesElement.querySelector(`.${this.prefix}_deliveries__pickup_address`);if(!e)return;const{subscriptionOrderData:{orderDelivery:{pickupPoint:i={}}={}}}=this.vars.view;if(!i?.id)return void e.remove();const{id:t,address:{buildingAndHouseNumber:r,street:s,postcode:l,city:n}={}}=i,o=this.deliveriesElement.querySelector(`.${this.prefix}_deliveries__pickup_name`);o&&(o.textContent=t);const d=this.deliveriesElement.querySelector(`.${this.prefix}_deliveries__pickup_street`);d&&(d.textContent=r?`${s} ${r}`:s);const c=this.deliveriesElement.querySelector(`.${this.prefix}_deliveries__pickup_city`);c&&(c.textContent=`${l} ${n}`)}initLink(){if(this.vars.view.status!==this.statuses.finished)return;const e=this.deliveriesElement.querySelector(`.${this.prefix}_deliveries__edit`);e&&e.remove()}initSelectedDelivery(){this.setIconSelectedDelivery(),this.setNameSelectedDelivery(),this.setDateSelectedDelivery(),this.setPriceSelectedDelivery(),this.setPickupSelectedDelivery()}async onClickOpenPickup(e){const i=e.closest(`.${this.prefix}_delivery`);if(!i)return;if(!i.classList.contains("--pickup"))return void this.deliveriesModalElement?.querySelector(`.${this.prefix}_deliveries_modal__button.--edit`)?.focus();if(e.classList.contains(`${this.prefix}_delivery__input`)&&i.hasAttribute("data-selected-point"))return void this.deliveriesModalElement?.querySelector(`.${this.prefix}_deliveries_modal__button.--edit`)?.focus();const t=i.querySelector(`.${this.prefix}_delivery__input`);t&&!t.checked&&(t.checked=!0,this.onChangeSelectDelivery({target:t,notPickup:!0}));const r=i.getAttribute("data-id"),s=i.getAttribute("data-prepaid"),l="dvp"===s,n=this.onClickShowDeliveriesModal.bind(this),o=i.querySelector(`.${this.prefix}_delivery__pickup_other`),d=this.elementsMap.get(o),{coordinates:{latitude:c,longitude:a}={}}=d||{},u=!d&&await this.getAddress(i),p=this.elementsMap.get(i),{cost:{value:v,formatted:h}={}}=p||{};this.vars.modal?.closeModal(),this.vars.pickup?.init?.({lat:c,lng:a,address:u,cashOnDelivery:l,elementCallback:i,callback:n,couriers:[{id:r,fullId:`${r}-${"dvp"===s?"0":1}`,price:{value:v,formatted:0===v?this.txt.Gratis:h}}],googleApiKey:this.vars.googleApiKey})}onChangeSelectDelivery({target:e,notPickup:i}){const t=e.closest(`.${this.prefix}_delivery`);t&&(this.disableInputs(t),i||this.onClickOpenPickup(e))}onClickEditDelivery(){const e=new FormData(this.deliveriesModalElement),i=Object.fromEntries(e.entries()),{subscriptionOrderData:{orderDelivery:{pickupPoint:t={},courier:r={}}={}}={}}=this.vars.view;i.shipping!==`${r?.id}-1`||t?.id&&t?.id!==i?.pickup_point?this.saveChangeDelivery(i):this.vars.modal.closeModal()}initDeliveriesModalEvents(){this.deliveriesModalElement.addEventListener("click",(e=>{const{target:i}=e;if(i.closest(`.${this.prefix}_delivery__select_delivery`)){e.preventDefault();const t=i.closest(`.${this.prefix}_delivery__select_delivery`).parentNode.querySelector(`.${this.prefix}_delivery__input`);if(!t)return;return t.checked=!0,void this.onChangeSelectDelivery({target:i})}if(i.closest(`.${this.prefix}_delivery__pickup_find`)||i.closest(`.${this.prefix}_delivery__pickup_other`))return e.preventDefault(),void this.onClickOpenPickup(i);i.closest(`.${this.prefix}_deliveries_modal__button.--return`)?this.vars.modal.closeModal():i.closest(`.${this.prefix}_deliveries_modal__button.--edit`)&&this.onClickEditDelivery()})),this.deliveriesModalElement.addEventListener("change",(e=>{const{target:i}=e;i.closest(`.${this.prefix}_delivery__input`)&&(e.preventDefault(),this.onChangeSelectDelivery({target:i}))}))}async onClickShowDeliveriesModal(e){this.deliveriesElement.classList.add("--loading");const i=this.vars.clientData||await this.fetchClientData();if(!i)return;const{client:t}=i||{};if(!t)return super.clearCache(["subscriptionClient"]),void(window.location.href="/signin.php");this.vars.clientData=i;const r=this.vars.deliveriesData||await this.fetchDeliveriesData();if(!r)return;this.vars.deliveriesData=r,this.vars.googleApiKey=i?.shop?.settings?.google?.mapsApiKey||this.vars.googleApiKey,this.deliveriesElement.classList.remove("--loading");const s=this.getDeliveriesModalElement(e);s&&(this.vars.modal=new Modal({element:s,classList:"--subscr --deliveries --medium --mobile",afterShow:()=>{e&&s?.querySelector(`.${this.prefix}_deliveries_modal__button.--edit`)?.focus()}}),this.initDeliveriesModalEvents())}initEvents(){this.deliveriesElement.addEventListener("click",(e=>{const{target:i}=e;i.closest(`.${this.prefix}_deliveries__edit`)&&(e.preventDefault(),this.onClickShowDeliveriesModal())}))}async generate(){const e=document.getElementById(`${this.prefix}_deliveries_template`)?.content.cloneNode(!0);if(!e||!e.firstChild)return;const i=this.deliveriesElement;this.deliveriesElement=e.firstChild,this.initLink(),this.initSelectedDelivery(),this.initEvents(),i&&document.body.contains(i)?i.replaceWith(this.deliveriesElement):super.move({element:this.deliveriesElement,...this.vars.move})}async init(e={}){this.vars={afterReady:e.afterReady||(()=>{}),move:e.move||this.vars?.move||{},view:e.view||this.vars?.view||{},products:e.products||this.vars?.products||[],holidays:e.holidays||this.vars?.holidays||[],pickup:e.pickup||this.vars?.pickup,googleApiKey:e.googleApiKey||this.vars?.googleApiKey||!1},this.callbacks={afterChangeDelivery:e.afterChangeDeliveryCallback||this.callbacks?.afterChangeDelivery},await this.generate(),this.vars.afterReady(this.deliveriesElement)}}app_shop.fn.subscrDeliveries=new SubscrDeliveries;